<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Automatizador de Notas – Santomé</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
<!-- Bibliotecas locais (PDF.js, Tesseract.js, SheetJS) -->
<script type="module">
  /* ---------- PDF.js ---------- */
  import * as pdfjsLib from './libs/pdf.min.mjs';
  pdfjsLib.GlobalWorkerOptions.workerSrc = './libs/pdf.worker.min.mjs';
  window.pdfjsLib = pdfjsLib;                     /* mantém compatibilidade */

  /* ---------- Tesseract.js ---------- */
  import Tesseract from './libs/tesseract.esm.min.js';   /* export default */
  const { createWorker } = Tesseract;
  window.Tesseract = { ...Tesseract, createWorker };

  /* ---------- SheetJS ---------- */
  import * as XLSX from './libs/xlsx.mjs';               /* build ESM */
  window.XLSX = XLSX;

  if (typeof checkLibraries === 'function') checkLibraries();
</script>
  
  <!-- PDF.js -->
  <!-- Tesseract.js -->
<!-- SheetJS -->
<!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ====== Variáveis de cor ====== */
    :root {
      --primary-color: #304ffe;
      --secondary-color: #eef2ff;
      --border-color: #d9d9d9;
      --success-color: #00c853;
      --error-color: #d32f2f;
      --light-text: #666;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --card-bg: #2d2d2d;
        --border-color: #404040;
        --light-text: #ccc;
      }
    }

    /* Reset e base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary-color), #1e88e5);
      color: white;
      padding: 2rem 0;
      text-align: center;
      box-shadow: var(--shadow);
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }

    header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    /* Main container */
    main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      width: 100%;
    }

    /* Upload section */
    .upload-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 2px dashed var(--border-color);
      transition: all 0.3s ease;
    }

    .upload-section.dragover {
      border-color: var(--primary-color);
      background-color: var(--secondary-color);
      transform: scale(1.02);
    }

    .upload-area {
      text-align: center;
      padding: 3rem 2rem;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .upload-area:hover {
      background-color: var(--secondary-color);
    }

    .upload-icon {
      font-size: 4rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    .upload-text {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .upload-hint {
      color: var(--light-text);
      font-size: 0.9rem;
    }

    #fileInput {
      display: none;
    }

    /* Progress section */
    .progress-section {
      margin-top: 1.5rem;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--success-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.9rem;
      color: var(--light-text);
      text-align: center;
    }

    /* Results section */
    .results-section {
      display: none;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .results-title {
      font-size: 1.5rem;
      color: #333;
    }

    .export-btn {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .export-btn:hover:not(:disabled) {
      background: #4caf50;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .export-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Table container */
    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      background: var(--card-bg);
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      vertical-align: top;
    }

    th {
      background: var(--secondary-color);
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td[contenteditable="true"] {
      border: 2px solid transparent;
      border-radius: 4px;
      transition: border-color 0.3s ease;
      cursor: text;
    }

    td[contenteditable="true"]:hover {
      border-color: var(--primary-color);
      background-color: var(--secondary-color);
    }

    td[contenteditable="true"]:focus {
      outline: none;
      border-color: var(--primary-color);
      background-color: white;
    }

    .error-row {
      background-color: #ffebee;
    }

    .error-row td {
      color: var(--error-color);
    }

    .delete-btn {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .delete-btn:hover {
      background: #c62828;
      transform: scale(1.1);
    }

    /* Footer */
    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    footer a {
      color: var(--primary-color);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2rem;
      }
      
      main {
        padding: 1rem;
      }
      
      .upload-section,
      .results-section {
        padding: 1.5rem;
      }
      
      .upload-area {
        padding: 2rem 1rem;
      }
      
      .upload-icon {
        font-size: 3rem;
      }
      
      .results-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 0.5rem;
      }
    }

    @media (max-width: 360px) {
      header {
        padding: 1.5rem 0;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .upload-section,
      .results-section {
        padding: 1rem;
      }
      
      .upload-area {
        padding: 1.5rem 0.5rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1><i class="fas fa-file-invoice"></i> Automatizador de Notas</h1>
    <p>Extração automática de dados de NFS-e para COMERCIO DE BANANAS SANTOMÉ LTDA</p>
  </header>

  <main>
    <section class="upload-section" id="uploadSection">
      <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-text">Solte aqui PDFs ou imagens</div>
        <div class="upload-hint">ou clique para selecionar arquivos</div>
      </div>
      <input type="file" id="fileInput" multiple accept=".pdf,image/*">
      
      <div class="progress-section" id="progressSection">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Processando arquivos...</div>
      </div>
    </section>

    <section class="results-section" id="resultsSection">
      <div class="results-header">
        <h2 class="results-title">Resultados Extraídos</h2>
        <button class="export-btn" id="exportBtn" disabled>
          <i class="fas fa-file-excel"></i>
          Exportar Excel
        </button>
      </div>
      
      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>CNPJ Emitente</th>
              <th>Nome Emitente</th>
              <th>Data Emissão</th>
              <th>Nº Documento</th>
              <th>Valor Total</th>
              <th>Descrição</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 COMERCIO DE BANANAS SANTOMÉ LTDA | 
    <a href="#" onclick="alert('Manual de uso em desenvolvimento')">Manual de Uso</a></p>
  </footer>

  <script>
    // Global variables
    let processedFiles = 0;
    let totalFiles = 0;
    let extractedData = [];
    
    // Company CNPJ to ignore (tomador)
    const COMPANY_CNPJ = '07.925.317/0001-88';
    
    // Initialize PDF.js with verification
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = './libs/pdf.worker.min.mjs';
    }
    
    // Regular expressions
    const regexes = {
      cnpj: /\b\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}\b/g,
      date: /\b\d{2}\/\d{2}\/\d{4}\b/g,
      dateISO: /\b\d{4}-\d{2}-\d{2}\b/g,
      money: /\d{1,3}(?:\.\d{3})*,\d{2}/g,
      docNumber: /(?:Número da NFS-e|Número da Nota|Nº NF|Nº RPS|RPS)\s*:?\s*(\d+)/i,
      placa: /([A-Z]{3}[-\s]?\d[A-Z0-9]\d{2}|[A-Z]{3}-?\d{4})/g
    };
// ======== HELPERS NOVOS ========
// Remove acentuação e normaliza string
const normalize = s => s.normalize("NFD").replace(/[̀-\u036f]/g, "");

/** Extrai nome do emitente (até 2 linhas acima do CNPJ) */
function getEmitenteName(text, cnpj) {
  const cnpjClean = cnpj.replace(/[^\d]/g, "");
  const idx = text.search(new RegExp(cnpjClean));
  if (idx === -1) return "";
  const snippet = text.slice(Math.max(0, idx - 200), idx); // trecho antes do CNPJ
  const before = snippet.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).reverse();
  const keyWords = /(LTDA|EPP|MEI|S\.?A| - )/i;
  for (let i = 0; i < before.length && i < 3; i++) {
    if (keyWords.test(before[i])) return before[i];
  }
  return before[0] || "";
}

/** Extrai descrição do serviço + placa se existir */
function getDescricaoServico(text) {
  const blocoRegex = /(Descrição do Serviço|DISCRIMINAÇÃO[^:\n]*):?\s*([\s\S]{0,500})/i;
  const m = text.match(blocoRegex);
  if (!m) return "";
  let desc = m[2].split(/\r?\n/)[0].trim();
  const placaRe = /\b([A-Z]{3}[-\s]?[0-9][A-Z0-9][0-9]{2}|[A-Z]{3}-?[0-9]{4})\b/;
  const placa = desc.match(placaRe);
  desc = desc.replace(/\s+/g, " ").replace(/[^\w\s\-.,]/g, "").toLowerCase().slice(0,120).trim();
  if (placa) return placa[1].toUpperCase() + " – " + desc;
  return desc;
}
// ======== FIM HELPERS NOVOS ========

    
    // Function to check if libraries are loaded
    function checkLibraries() {
      const status = {
        pdfjs: typeof pdfjsLib !== 'undefined',
        tesseract: typeof Tesseract !== 'undefined',
        xlsx: typeof XLSX !== 'undefined'
      };
      
      console.log('Status das bibliotecas:', status);
      
      if (!status.pdfjs) {
        console.error('PDF.js não carregado. Verifique a conexão com a internet.');
      }
      if (!status.tesseract) {
        console.error('Tesseract.js não carregado. Verifique a conexão com a internet.');
      }
      if (!status.xlsx) {
        console.error('SheetJS não carregado. Verifique a conexão com a internet.');
      }
      
      return status.pdfjs && status.tesseract && status.xlsx;
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Check libraries after a small delay
      setTimeout(() => {
        const librariesLoaded = checkLibraries();
        if (!librariesLoaded) {
          alert('Algumas bibliotecas não carregaram corretamente. Verifique sua conexão com a internet e recarregue a página.');
        }
      }, 2000);
      
      const uploadSection = document.getElementById('uploadSection');
      const fileInput = document.getElementById('fileInput');
      const exportBtn = document.getElementById('exportBtn');
      
      // Drag and drop events
      uploadSection.addEventListener('dragover', handleDragOver);
      uploadSection.addEventListener('dragleave', handleDragLeave);
      uploadSection.addEventListener('drop', handleDrop);
      
      // File input change
      fileInput.addEventListener('change', function(e) {
        handleFiles(Array.from(e.target.files));
      });
      
      // Export button
      exportBtn.addEventListener('click', exportToExcel);
    });
    
    // Drag and drop handlers
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    }
    
    function handleDragLeave(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      handleFiles(files);
    }
    
    // Main file processing function
    async function handleFiles(files) {
      if (files.length === 0) return;
      
      // Check if libraries are available before processing
      if (!checkLibraries()) {
        alert('Bibliotecas necessárias não estão disponíveis. Recarregue a página e tente novamente.');
        return;
      }
      
      totalFiles = files.length;
      processedFiles = 0;
      extractedData = [];
      
      showProgress();
      updateProgress();
      
      // Process files with max 3 concurrent operations
      const chunks = [];
      for (let i = 0; i < files.length; i += 3) {
        chunks.push(files.slice(i, i + 3));
      }
      
      for (const chunk of chunks) {
        const promises = chunk.map(file => processFile(file));
        await Promise.allSettled(promises);
      }
      
      hideProgress();
      updateResultsTable();
      showResults();
    }
    
    // Process single file
    async function processFile(file) {
      try {
        let extractedText = '';
        
        if (file.type === 'application/pdf') {
          extractedText = await processPDF(file);
        } else if (file.type.startsWith('image/')) {
          extractedText = await processImage(file);
        } else {
          throw new Error('Tipo de arquivo não suportado');
        }
        
        const data = extractDataFromText(extractedText, file.name);
        if (data) {
          extractedData.push(data);
        }
        
      } catch (error) {
        console.error(`Erro ao processar ${file.name}:`, error);
        // Add error row
        extractedData.push({
          filename: file.name,
          cnpj: 'ERRO',
          nome: 'Erro no processamento',
          data: '',
          documento: '',
          valor: '',
          descricao: error.message,
          hasError: true
        });
      } finally {
        processedFiles++;
        updateProgress();
      }
    }
    
    // Process PDF file with improved error handling
    async function processPDF(file) {
      if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js não está disponível. Verifique sua conexão com a internet.');
      }
      
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let fullText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }
        
        return fullText;
      } catch (error) {
        console.error('Erro ao processar PDF:', error);
        throw new Error(`Erro ao processar PDF: ${error.message}`);
      }
    }
    
    // Process image file with OCR and improved error handling
    async function processImage(file) {
      if (typeof Tesseract === 'undefined') {
        throw new Error('Tesseract.js não está disponível. Verifique sua conexão com a internet.');
      }
      
      // Preprocess image for better OCR
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      
      return new Promise((resolve, reject) => {
        img.onload = async function() {
          try {
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Draw image and convert to grayscale
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Simple grayscale conversion
            for (let i = 0; i < data.length; i += 4) {
              const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
              data[i] = gray;     // Red
              data[i + 1] = gray; // Green
              data[i + 2] = gray; // Blue
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            const result = await Tesseract.recognize(canvas, 'por+eng', {
              logger: m => console.log(m)
            });
            resolve(result.data.text);
          } catch (error) {
            console.error('Erro no OCR:', error);
            reject(new Error(`Erro no OCR: ${error.message}`));
          }
        };
        
        img.onerror = () => reject(new Error('Erro ao carregar imagem'));
        img.src = URL.createObjectURL(file);
      });
    }
    
    // Extract data from text using heuristics
    function extractDataFromText(text, filename) {
      const lines = text.split('\n').map(line => line.trim()).filter(line => line);
      
      // Extract CNPJ (excluding company CNPJ)
      const cnpjMatches = text.match(regexes.cnpj) || [];
      const validCnpjs = cnpjMatches.filter(cnpj => 
        !cnpj.replace(/[^\d]/g, '').includes(COMPANY_CNPJ.replace(/[^\d]/g, ''))
      );
      const cnpj = validCnpjs[0] || '';
      
      // Extract company name (look for line before CNPJ)
      let nome = getEmitenteName(text, cnpj);
      // Extract date
      const dateMatches = text.match(regexes.date) || text.match(regexes.dateISO) || [];
      const data = dateMatches[0] || '';
      
      // Extract document number
      const docMatch = text.match(regexes.docNumber);
      let documento = docMatch ? docMatch[1] : '';
      
      // If no document number found, look for large numeric sequences
      if (!documento) {
        const numberMatches = text.match(/\b\d{3,10}\b/g) || [];
        documento = numberMatches.find(num => num.length >= 6) || '';
      }
      
      // Extract total value
      const moneyMatches = text.match(regexes.money) || [];
      const valor = moneyMatches.length > 0 ? 
        Math.max(...moneyMatches.map(m => parseFloat(m.replace(/\./g, '').replace(',', '.')))) : '';
      
      // Extract description
      let descricao = getDescricaoServico(text);
      
      // Validate required fields
      if (!cnpj && !nome && !data) {
        return null; // Skip if no essential data found
      }
      
      return {
        filename,
        cnpj: formatCNPJ(cnpj),
        nome: cleanName(nome),
        data: formatDate(data),
        documento,
        valor: formatMoney(valor),
        descricao,
        hasError: !cnpj || !nome || !data
      };
    }
    
    // Extract and format description
    function extractDescription(text) {
      const lines = text.split('\n').map(line => line.trim()).filter(line => line);
      
      // Look for description blocks
      const descriptionStarts = [
        'Descrição do Serviço',
        'DISCRIMINAÇÃO DOS SERVIÇOS',
        'DISCRIMINAÇÃO',
        'Descrição dos Serviços'
      ];
      
      let description = '';
      let startIndex = -1;
      
      // Find description start
      for (const start of descriptionStarts) {
        startIndex = lines.findIndex(line => 
          line.toLowerCase().includes(start.toLowerCase())
        );
        if (startIndex >= 0) break;
      }
      
      if (startIndex >= 0) {
        // Get next few lines after description label
        const descLines = lines.slice(startIndex + 1, startIndex + 5);
        description = descLines.join(' ').trim();
      } else {
        // Fallback: look for lines with meaningful content
        const meaningfulLines = lines.filter(line => 
          line.length > 20 && 
          !line.includes('CNPJ') && 
          !line.includes('Valor') &&
          !line.includes('Total')
        );
        description = meaningfulLines[0] || '';
      }
      
      // Look for license plate
      const placaMatch = description.match(regexes.placa);
      if (placaMatch) {
        const placa = placaMatch[0].replace(/[-\s]/g, '');
        const cleanDesc = description.replace(/placa[:\s=]*[A-Z0-9\s-]+/gi, '').trim();
        description = `${placa} – ${cleanDesc}`;
      }
      
      // Clean and limit description
      description = description
        .replace(/\s+/g, ' ')
        .replace(/VOCÊ PAGOU APROXIMADAMENTE.*/i, '')
        .trim()
        .substring(0, 120);
      
      return description.toLowerCase();
    }
    
    // Utility functions
    function formatCNPJ(cnpj) {
      if (!cnpj) return '';
      const numbers = cnpj.replace(/[^\d]/g, '');
      return numbers.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
    }
    
    function cleanName(nome) {
      return nome.replace(/\s+/g, ' ').trim();
    }
    
    function formatDate(date) {
      if (!date) return '';
      // Keep DD/MM/YYYY format or convert YYYY-MM-DD to DD/MM/YYYY
      if (date.includes('-')) {
        const [year, month, day] = date.split('-');
        return `${day}/${month}/${year}`;
      }
      return date;
    }
    
    function formatMoney(value) {
      if (!value) return '';
      if (typeof value === 'number') {
        return value.toLocaleString('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).replace('R$', '').trim();
      }
      return value;
    }
    
    // Progress functions
    function showProgress() {
      document.getElementById('progressSection').style.display = 'block';
    }
    
    function hideProgress() {
      document.getElementById('progressSection').style.display = 'none';
    }
    
    function updateProgress() {
      const percentage = totalFiles > 0 ? (processedFiles / totalFiles) * 100 : 0;
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = 
        `Processando arquivos... ${processedFiles}/${totalFiles}`;
    }
    
    // Results table functions
    function updateResultsTable() {
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';
      
      extractedData.forEach((data, index) => {
        const row = document.createElement('tr');
        if (data.hasError) {
          row.classList.add('error-row');
        }
        
        row.innerHTML = `
          <td contenteditable="true">${data.cnpj || ''}</td>
          <td contenteditable="true">${data.nome || ''}</td>
          <td contenteditable="true">${data.data || ''}</td>
          <td contenteditable="true">${data.documento || ''}</td>
          <td contenteditable="true">${data.valor || ''}</td>
          <td contenteditable="true">${data.descricao || ''}</td>
          <td>
            <button class="delete-btn" onclick="deleteRow(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      enableExportIfAny();
    }
    
    function deleteRow(index) {
      extractedData.splice(index, 1);
      updateResultsTable();
    }
    
    function showResults() {
      document.getElementById('resultsSection').style.display = 'block';
    }
    
    function enableExportIfAny() {
      const exportBtn = document.getElementById('exportBtn');
      exportBtn.disabled = extractedData.length === 0;
    }
    
    // Export to Excel function
    function exportToExcel() {
      if (typeof XLSX === 'undefined') {
        alert('Biblioteca de exportação não está disponível. Recarregue a página e tente novamente.');
        return;
      }
      
      if (extractedData.length === 0) {
        alert('Nenhum dado para exportar');
        return;
      }
      
      // Get current table data (including user edits)
      const table = document.getElementById('resultsTable');
      const rows = table.querySelectorAll('tbody tr');
      const exportData = [];
      
      rows.forEach((row, index) => {
        const cells = row.querySelectorAll('td[contenteditable="true"]');
        if (cells.length >= 6) {
          exportData.push({
            'CNPJ Emitente': cells[0].textContent.trim(),
            'Nome Emitente': cells[1].textContent.trim(),
            'Data Emissão': cells[2].textContent.trim(),
            'Nº Documento': cells[3].textContent.trim(),
            'Valor Total': cells[4].textContent.trim(),
            'Descrição': cells[5].textContent.trim(),
            'Arquivo Origem': extractedData[index]?.filename || ''
          });
        }
      });
      
      try {
        // Create workbook
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        
        // Set column widths
        ws['!cols'] = [
          { wch: 18 }, // CNPJ
          { wch: 35 }, // Nome
          { wch: 12 }, // Data
          { wch: 15 }, // Documento
          { wch: 15 }, // Valor
          { wch: 50 }, // Descrição
          { wch: 25 }  // Arquivo
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, "Notas Fiscais");
        
        // Generate filename with current date
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
        const filename = `notas_fiscais_santome_${dateStr}.xlsx`;
        
        // Save file
        XLSX.writeFile(wb, filename);
      } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('Erro ao exportar arquivo Excel. Tente novamente.');
      }
    }
    
    // Add event listeners for table editing
    document.addEventListener('input', function(e) {
      if (e.target.contentEditable === 'true') {
        // Update data array when user edits cells
        const row = e.target.parentElement;
        const table = row.parentElement.parentElement;
        const rowIndex = Array.from(table.querySelectorAll('tbody tr')).indexOf(row);
        const cellIndex = Array.from(row.querySelectorAll('td[contenteditable="true"]')).indexOf(e.target);
        
        if (extractedData[rowIndex]) {
          const fields = ['cnpj', 'nome', 'data', 'documento', 'valor', 'descricao'];
          if (fields[cellIndex]) {
            extractedData[rowIndex][fields[cellIndex]] = e.target.textContent.trim();
          }
        }
      }
    });
    
    // Utility function to clean text
    function cleanText(text) {
      return text
        .replace(/\s+/g, ' ')
        .replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
        .trim();
    }
  </script>
<!-- Espera assíncrona para confirmar carregamento das libs locais -->
<script>
  (function waitForLibs(retries = 20){
    const ok = typeof pdfjsLib!=='undefined' && typeof Tesseract!=='undefined' && typeof XLSX!=='undefined';
    if(ok){
      console.log('Bibliotecas locais carregadas OK');
      if(typeof checkLibraries==='function') checkLibraries();
      return;
    }
    if(retries>0){
      setTimeout(()=>waitForLibs(retries-1),300);
    }else{
      console.error('Não foi possível carregar todas as bibliotecas locais.');
    }
  })();
</script>
</body>
</html>
