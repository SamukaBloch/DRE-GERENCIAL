<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Automatizador NFS-e Precisão Laser – Santomé</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ====== Variáveis de cor ====== */
    :root {
      --primary-color: #304ffe;
      --secondary-color: #eef2ff;
      --border-color: #d9d9d9;
      --success-color: #00c853;
      --error-color: #d32f2f;
      --warning-color: #ff9800;
      --light-text: #666;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --card-bg: #2d2d2d;
        --border-color: #404040;
        --light-text: #ccc;
      }
    }

    /* Garantir que a tabela sempre tenha fundo claro */
    .table-container {
      background-color: #ffffff !important;
    }

    table {
      background-color: #ffffff !important;
    }

    th, td {
      background-color: #ffffff !important;
      color: #333333 !important;
    }

    th {
      background-color: #f0f4ff !important;
    }

    /* Reset e base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      padding: 2rem 0;
      text-align: center;
      box-shadow: var(--shadow);
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }

    header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .version-badge {
      background: rgba(255,255,255,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      display: inline-block;
    }

    /* Main container */
    main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      width: 100%;
    }

    /* Status section */
    .status-section {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      text-align: center;
      display: none;
    }

    .status-ok {
      color: var(--success-color);
    }

    .status-error {
      color: var(--error-color);
    }

    .status-warning {
      color: var(--warning-color);
    }

    /* Upload section */
    .upload-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 2px dashed var(--border-color);
      transition: all 0.3s ease;
    }

    .upload-section.dragover {
      border-color: #ff6b35;
      background-color: #fff5f0;
      transform: scale(1.02);
    }

    .upload-area {
      text-align: center;
      padding: 3rem 2rem;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .upload-area:hover {
      background-color: #fff5f0;
    }

    .upload-icon {
      font-size: 4rem;
      color: #ff6b35;
      margin-bottom: 1rem;
    }

    .upload-text {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .upload-hint {
      color: var(--light-text);
      font-size: 0.9rem;
    }

    #fileInput {
      display: none;
    }

    /* Progress section */
    .progress-section {
      margin-top: 1.5rem;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b35, #f7931e);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.9rem;
      color: var(--light-text);
      text-align: center;
    }

    /* Results section */
    .results-section {
      display: none;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .results-title {
      font-size: 1.5rem;
      color: #333;
    }

    .export-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .export-btn, .clear-btn, .save-btn {
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .export-btn {
      background: var(--success-color);
      color: white;
    }

    .export-btn:hover:not(:disabled) {
      background: #4caf50;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .clear-btn {
      background: var(--warning-color);
      color: white;
    }

    .clear-btn:hover:not(:disabled) {
      background: #f57c00;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 124, 0, 0.3);
    }

    .save-btn {
      background: var(--primary-color);
      color: white;
    }

    .save-btn:hover:not(:disabled) {
      background: #283593;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 53, 147, 0.3);
    }

    .export-btn:disabled, .clear-btn:disabled, .save-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Table container */
    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      background: var(--card-bg);
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      vertical-align: top;
    }

    th {
      background: var(--secondary-color);
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td[contenteditable="true"] {
      border: 2px solid transparent;
      border-radius: 4px;
      transition: border-color 0.3s ease;
      cursor: text;
    }

    td[contenteditable="true"]:hover {
      border-color: #ff6b35;
      background-color: #fff5f0;
    }

    td[contenteditable="true"]:focus {
      outline: none;
      border-color: #ff6b35;
      background-color: white;
    }

    .error-row {
      background-color: #ffebee;
    }

    .error-row td {
      color: var(--error-color);
    }

    .success-row {
      background-color: #e8f5e8;
    }

    .warning-row {
      background-color: #fff3e0;
    }

    .delete-btn, .validate-btn {
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      transition: all 0.3s ease;
    }

    .delete-btn {
      background: var(--error-color);
      color: white;
    }

    .delete-btn:hover {
      background: #c62828;
      transform: scale(1.1);
    }

    .validate-btn {
      background: var(--success-color);
      color: white;
    }

    .validate-btn:hover {
      background: #4caf50;
      transform: scale(1.1);
    }

    /* Statistics section */
    .stats-section {
      display: none;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid var(--primary-color);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
    }

    .stat-label {
      color: var(--light-text);
      font-size: 0.9rem;
    }

    /* Filter section */
    .filter-section {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      display: none;
    }

    .filter-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-input {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .filter-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .filter-btn:hover {
      background: #283593;
    }

    /* Debug section */
    .debug-section {
      margin-top: 2rem;
      background: #f5f5f5;
      border-radius: 8px;
      padding: 1rem;
      display: none;
    }

    .debug-section h3 {
      margin-bottom: 1rem;
      color: #666;
    }

    .debug-text {
      font-family: monospace;
      font-size: 0.8rem;
      background: white;
      padding: 1rem;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .extraction-details {
      margin-top: 1rem;
      background: white;
      padding: 1rem;
      border-radius: 4px;
      border-left: 4px solid #ff6b35;
    }

    .extraction-step {
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: #f9f9f9;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8rem;
    }

    .step-success { border-left: 3px solid #4caf50; }
    .step-fail { border-left: 3px solid #f44336; }
    .step-warning { border-left: 3px solid #ff9800; }

    /* Error handling */
    .error-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--error-color);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      display: none;
      max-width: 400px;
    }

    .success-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success-color);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      display: none;
      max-width: 400px;
    }

    /* Footer */
    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    footer a {
      color: #ff6b35;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ff6b35;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2rem;
      }
      
      main {
        padding: 1rem;
      }
      
      .upload-section,
      .results-section {
        padding: 1.5rem;
      }
      
      .upload-area {
        padding: 2rem 1rem;
      }
      
      .upload-icon {
        font-size: 3rem;
      }
      
      .results-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .export-buttons {
        justify-content: center;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 0.5rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    @media (max-width: 360px) {
      header {
        padding: 1.5rem 0;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .upload-section,
      .results-section {
        padding: 1rem;
      }
      
      .upload-area {
        padding: 1.5rem 0.5rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1><i class="fas fa-bullseye"></i> Automatizador NFS-e v3.8</h1>
    <p>Correções do log: VANTOIR DERETTI + SERVOPA + TRANSPOTECH + SINDICATO + FSC + M.A. SILVA + BHS + PORTEC + outros casos específicos</p>
    <div class="version-badge">v3.8 - Correções Log: VANTOIR + SERVOPA + TRANSPOTECH + SINDICATO + FSC + M.A. SILVA + BHS + PORTEC</div>
  </header>

  <main>
    <!-- Status Section -->
    <section class="status-section" id="statusSection">
      <div id="statusMessage">Carregando sistema ultra-direto...</div>
    </section>

    <!-- Statistics Section -->
    <section class="stats-section" id="statsSection">
      <h3>📊 Estatísticas de Processamento</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalProcessed">0</div>
          <div class="stat-label">Documentos Processados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">Taxa de Sucesso</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalValue">R$ 0,00</div>
          <div class="stat-label">Valor Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="uniqueCompanies">0</div>
          <div class="stat-label">Empresas Diferentes</div>
        </div>
      </div>
    </section>

    <!-- Filter Section -->
    <section class="filter-section" id="filterSection">
      <h3>🔍 Filtros</h3>
      <div class="filter-controls">
        <input type="text" class="filter-input" id="filterCompany" placeholder="Filtrar por empresa...">
        <input type="date" class="filter-input" id="filterDateFrom" placeholder="Data de...">
        <input type="date" class="filter-input" id="filterDateTo" placeholder="Data até...">
        <button class="filter-btn" onclick="applyFilters()">Aplicar Filtros</button>
        <button class="filter-btn" onclick="clearFilters()">Limpar Filtros</button>
      </div>
    </section>

    <!-- Upload Section -->
    <section class="upload-section" id="uploadSection">
      <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">
          <i class="fas fa-bullseye"></i>
        </div>
        <div class="upload-text">Upload de NFS-e</div>
        <div class="upload-hint">v3.8 - VANTOIR DERETTI + SERVOPA + TRANSPOTECH + SINDICATO + FSC + M.A. SILVA + BHS + PORTEC + W.O. RIGO + FUNILARIA + SASCAR + RD CARTUCHOS + LUCIA</div>
      </div>
      <input type="file" id="fileInput" multiple accept=".pdf,image/*">
      
      <div class="progress-section" id="progressSection">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Aplicando extração ultra-direta...</div>
      </div>
    </section>

    <!-- Results Section -->
    <section class="results-section" id="resultsSection">
      <div class="results-header">
        <h2 class="results-title">Resultados Ultra-Diretos</h2>
        <div class="export-buttons">
          <button class="export-btn" id="exportBtn" disabled>
            <i class="fas fa-file-excel"></i>
            Exportar Excel
          </button>
          <button class="save-btn" id="saveBtn" disabled>
            <i class="fas fa-save"></i>
            Salvar Dados
          </button>
          <button class="clear-btn" id="clearBtn" disabled>
            <i class="fas fa-trash"></i>
            Limpar Tudo
          </button>
        </div>
      </div>
      
      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>CNPJ Emitente</th>
              <th>Nome Emitente</th>
              <th>Data Emissão</th>
              <th>Nº Documento</th>
              <th>Valor Total</th>
              <th>Descrição</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Debug Section -->
    <section class="debug-section" id="debugSection">
      <h3>Debug Ultra-Direto - Análise Simples</h3>
      <div class="debug-text" id="debugText"></div>
      <div class="extraction-details" id="extractionDetails"></div>
    </section>
  </main>

  <!-- Notifications -->
  <div class="error-notification" id="errorNotification">
    <i class="fas fa-exclamation-triangle"></i>
    <span id="errorMessage"></span>
  </div>

  <div class="success-notification" id="successNotification">
    <i class="fas fa-check-circle"></i>
    <span id="successMessage"></span>
  </div>

  <footer>
    <p>&copy; 2025 COMERCIO DE BANANAS SANTOMÉ LTDA | 
    <a href="#" onclick="toggleDebug(); return false;">Debug Ultra-Direto</a> |
    <a href="#" onclick="toggleStats(); return false;">Estatísticas</a> |
    <a href="#" onclick="toggleFilters(); return false;">Filtros</a></p>
  </footer>

  <!-- Script de Precisão Laser -->
  <script type="module">
    // ===== POLYFILLS =====
    (function() {
      const originalMatchAll = String.prototype.matchAll;
      String.prototype.matchAll = function(re) {
        if (re instanceof RegExp && !re.flags.includes('g')) {
          re = new RegExp(re.source, re.flags + 'g');
        }
        return originalMatchAll.call(this, re);
      };
    })();

    // Importa as bibliotecas
    import * as pdfjsLib from './libs/pdf.min.mjs';
    import Tesseract from './libs/tesseract.esm.min.js';
    import * as XLSX from './libs/xlsx.mjs';

    // Configura PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = './libs/pdf.worker.min.mjs';
    window.pdfjsLib = pdfjsLib;
    window.Tesseract = Tesseract;
    window.XLSX = XLSX;

    // ===== VARIÁVEIS GLOBAIS =====
    let debugMode = false;
    let librariesLoaded = false;
    let extractionResults = [];
    let debugSteps = [];
    let originalResults = []; // Para filtros
    let statistics = {
      totalProcessed: 0,
      successCount: 0,
      errorCount: 0,
      totalValue: 0,
      uniqueCompanies: new Set()
    };
    
    // CNPJ da empresa (tomador)
    const COMPANY_CNPJ = '07.925.317/0001-88';

    // ===== SISTEMA DE EXTRAÇÃO v3.8 - CORREÇÕES DO LOG =====
    // HISTÓRICO DE MELHORIAS (SEM QUEBRAR FUNCIONALIDADES):
    // v3.8: + VANTOIR DERETTI ME + SERVOPA CAMINHOES LTDA + TRANSPOTECH PECAS E SERVICOS LTDA + SINDICATO DO COMERCIO VAREJISTA + FSC COMUNICACOES LTDA + correções específicas baseadas no log
    // v3.6: + M.A. DA SILVA VIEIRA - AUTO ELÉTRICA + BHS MARINGA + PORTEC + TRANORTE + POSTO Z4 + CONTABILIDADE ORLANDO + correções específicas
    // v3.5: + W.O. RIGO FILHO + Razão Social específica + nomes com iniciais + seção PRESTADOR melhorada
    // v3.4: + FUNILARIA NITZ LTDA + SASCAR TECNOLOGIA + busca por primeiras linhas + busca por CNPJ+nome
    // v3.3: + Bibliotecas atualizadas (PDF.js v3.11.174, SheetJS v0.18.5)  
    // v3.2: + Busca específica por seção PRESTADOR (corrige RD CARTUCHOS)
    // v3.1: + Filtros anti-órgão público + validação aprimorada + limpeza melhorada
    // v3.0: + LUCIA IVONETE específica + estratégias em ordem de prioridade
    // 
    // CASOS SUPORTADOS:
    // ✅ VANTOIR DERETTI ME (NOVO v3.8)
    // ✅ SERVOPA CAMINHOES LTDA (NOVO v3.8)
    // ✅ TRANSPOTECH PECAS E SERVICOS LTDA (NOVO v3.8)
    // ✅ SINDICATO DO COMERCIO VAREJISTA DE JARAGUA DO SUL (NOVO v3.8)
    // ✅ FSC COMUNICACOES LTDA (NOVO v3.8)
    // ✅ M.A. DA SILVA VIEIRA - AUTO ELÉTRICA
    // ✅ BHS MARINGA TECNOLOGIA LTDA  
    // ✅ PORTEC COMERCIO DE PRODUTOS ELETRONICOS E SERVICO
    // ✅ TRANORTE SISTEMAS MECANIZADOS LTDA
    // ✅ POSTO Z4 LTDA
    // ✅ CONTABILIDADE ORLANDO AMORIM S/S LTDA
    // ✅ W.O. RIGO FILHO - INFORMATICA - ME
    // ✅ RD CARTUCHOS E INFORMATICA LTDA - ME
    // ✅ LUCIA IVONETE VICK KASMIRSKI - EPP - MECANICA DIESEL KASMIRSKI  
    // ✅ FUNILARIA NITZ LTDA
    // ✅ SASCAR - TECNOLOGIA E SEGURANÇA AUTOMOTIVA S.A
    // ✅ Qualquer empresa com EPP, LTDA, ME, S.A, EIRELI
    // ✅ Nomes com iniciais (J.A., M.S., etc.)
    // ✅ Filtros robustos anti-órgão público
    class UltraDirectExtractor {
      constructor() {
        this.debugSteps = [];
      }

      logStep(type, message, result = null) {
        const step = { type, message, result, timestamp: new Date() };
        this.debugSteps.push(step);
        console.log(`[${type.toUpperCase()}] ${message}`, result || '');
      }

      // ===== EXTRAÇÃO DE CNPJ (mantida - já funciona) =====
      extractCNPJEmitente(text) {
        this.logStep('info', 'Iniciando extração de CNPJ');
        
        const cnpjMatches = [...text.matchAll(/\b\d{2}[\.\s]?\d{3}[\.\s]?\d{3}[\s\/]?\d{4}[\s\-]?\d{2}\b/g)];
        const companyCnpjClean = COMPANY_CNPJ.replace(/\D/g, '');
        
        this.logStep('info', `Encontrados ${cnpjMatches.length} CNPJs no documento`);
        
        for (const match of cnpjMatches) {
          const cnpj = match[0];
          const cnpjClean = cnpj.replace(/\D/g, '');
          
          if (cnpjClean !== companyCnpjClean && cnpjClean.length === 14) {
            const formatted = this.formatCNPJ(cnpjClean);
            this.logStep('success', 'CNPJ do emitente encontrado', formatted);
            return formatted;
          }
        }
        
        this.logStep('fail', 'CNPJ do emitente não encontrado');
        return '';
      }

      // ===== ESTRATÉGIAS ESPECÍFICAS v3.8 - Correções do Log ADICIONADAS =====
      extractEmitenteNameLaser(text, cnpj) {
        this.logStep('info', 'Iniciando extração ULTRA-DIRETA de nome do emitente');
        
        if (!cnpj) {
          this.logStep('fail', 'CNPJ não fornecido para busca de nome');
          return '';
        }

        // ===== NOVAS ESTRATÉGIAS v3.8 - ADICIONADAS =====

        // NOVA ESTRATÉGIA v3.8.1: VANTOIR DERETTI ME
        const vantoirMatch = text.match(/VANTOIR\s+DERETTI[^0-9\n\r]*ME[^0-9\n\r]*/gi);
        if (vantoirMatch) {
          let name = this.cleanCompanyName(vantoirMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'VANTOIR DERETTI ME encontrada', name);
            return name;
          }
        }

        // NOVA ESTRATÉGIA v3.8.2: SERVOPA CAMINHOES LTDA
        const servopaMatch = text.match(/SERVOPA\s+CAMINHOES[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (servopaMatch) {
          let name = this.cleanCompanyName(servopaMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'SERVOPA CAMINHOES LTDA encontrada', name);
            return name;
          }
        }

        // NOVA ESTRATÉGIA v3.8.3: TRANSPOTECH PECAS E SERVICOS LTDA
        const transpotechMatch = text.match(/TRANSPOTECH\s+PECAS\s+E\s+SERVICOS[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (transpotechMatch) {
          let name = this.cleanCompanyName(transpotechMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'TRANSPOTECH PECAS E SERVICOS encontrada', name);
            return name;
          }
        }

        // NOVA ESTRATÉGIA v3.8.4: SINDICATO DO COMERCIO VAREJISTA
        const sindicatoMatch = text.match(/SINDICATO\s+DO\s+COMERCIO\s+VAREJISTA[^0-9\n\r]*JARAGUA\s+DO\s+SUL[^0-9\n\r]*/gi);
        if (sindicatoMatch) {
          let name = this.cleanCompanyName(sindicatoMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'SINDICATO DO COMERCIO VAREJISTA encontrado', name);
            return name;
          }
        }

        // NOVA ESTRATÉGIA v3.8.5: FSC COMUNICACOES LTDA
        const fscMatch = text.match(/FSC\s+COMUNICACOES[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (fscMatch) {
          let name = this.cleanCompanyName(fscMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'FSC COMUNICACOES encontrada', name);
            return name;
          }
        }

        // ===== ESTRATÉGIAS v3.6 MANTIDAS =====

        // ESTRATÉGIA v3.6.1: M.A. DA SILVA VIEIRA - AUTO ELÉTRICA (mantida)
        const autoEletricaMatch = text.match(/M\.A\.\s+DA\s+SILVA\s+VIEIRA[^0-9\n\r]*AUTO\s+EL[EÉ]TRICA[^0-9\n\r]*/gi);
        if (autoEletricaMatch) {
          let name = this.cleanCompanyName(autoEletricaMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'M.A. DA SILVA VIEIRA - AUTO ELÉTRICA encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.6.2: BHS MARINGA TECNOLOGIA LTDA (mantida)
        const bhsMatch = text.match(/BHS\s+MARINGA\s+TECNOLOGIA[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (bhsMatch) {
          let name = this.cleanCompanyName(bhsMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'BHS MARINGA TECNOLOGIA encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.6.3: PORTEC COMERCIO (mantida)
        const portecMatch = text.match(/PORTEC[^0-9\n\r]*COMERCIO[^0-9\n\r]*PRODUTOS[^0-9\n\r]*ELETRONICOS[^0-9\n\r]*SERVICO[^0-9\n\r]*/gi);
        if (portecMatch) {
          let name = this.cleanCompanyName(portecMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'PORTEC COMERCIO encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.6.4: TRANORTE SISTEMAS MECANIZADOS (mantida)
        const tranorteMatch = text.match(/TRANORTE[^0-9\n\r]*SISTEMAS[^0-9\n\r]*MECANIZADOS[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (tranorteMatch) {
          let name = this.cleanCompanyName(tranorteMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'TRANORTE SISTEMAS MECANIZADOS encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.6.5: POSTO Z4 LTDA (mantida)
        const postoZ4Match = text.match(/POSTO\s+Z4[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (postoZ4Match) {
          let name = this.cleanCompanyName(postoZ4Match[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'POSTO Z4 encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.6.6: CONTABILIDADE ORLANDO AMORIM (mantida)
        const orlandoMatch = text.match(/CONTABILIDADE\s+ORLANDO\s+AMORIM[^0-9\n\r]*S\/S[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (orlandoMatch) {
          let name = this.cleanCompanyName(orlandoMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'CONTABILIDADE ORLANDO AMORIM encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.5.1: Busca específica W.O. RIGO FILHO (mantida - funcionando)
        const rigoMatch = text.match(/W\.O\.\s+RIGO\s+FILHO[^0-9\n\r]*INFORMATICA[^0-9\n\r]*ME[^0-9\n\r]*/gi);
        if (rigoMatch) {
          let name = this.cleanCompanyName(rigoMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'W.O. RIGO FILHO encontrado', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.5.2: Busca por Razão Social específica (mantida)
        const razaoSocialMatch = text.match(/Raz[ãa]o\s+Social:\s*([^\r\n]+)/gi);
        if (razaoSocialMatch) {
          for (const match of razaoSocialMatch) {
            let name = this.cleanCompanyName(match);
            if (this.validateCompanyNameImproved(name) && name.length > 10) {
              this.logStep('success', 'Nome encontrado em Razão Social', name);
              return name;
            }
          }
        }

        // ESTRATÉGIA v3.6.7: Busca aprimorada em "Nome/Razão Social:" (mantida)
        const nomeRazaoAprimoradaMatch = text.match(/Nome\/Raz[ãa]o\s+Social:\s*([^\r\n]+)/gi);
        if (nomeRazaoAprimoradaMatch) {
          for (const match of nomeRazaoAprimoradaMatch) {
            let name = this.cleanCompanyName(match);
            if (this.validateCompanyNameImproved(name) && name.length > 8) {
              this.logStep('success', 'Nome encontrado em Nome/Razão Social aprimorada', name);
              return name;
            }
          }
        }

        // ESTRATÉGIA v3.5.3: Busca por nomes com iniciais (mantida - funcionando)
        const iniciaisPattern = /([A-Z]\.[A-Z]\.\s+[A-Z][^0-9\n\r]{5,80}(?:LTDA|EPP|ME|S\.?A|EIRELI|INFORMATICA)[^0-9\n\r]*)/gi;
        const iniciaisMatches = [...text.matchAll(iniciaisPattern)];
        for (const match of iniciaisMatches) {
          let name = this.cleanCompanyName(match[1]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'Nome com iniciais encontrado', name);
            return name;
          }
        }

        // ESTRATÉGIA v3.5.4: Seção PRESTADOR melhorada (mantida)
        const prestadorMatch = text.match(/PRESTADOR\s+DE\s+SERVI[ÇC]OS([\s\S]*?)(?=TOMADOR|DISCRIMINA[ÇC][ÃA]O|Valor Total|$)/gi);
        if (prestadorMatch) {
          const prestadorSection = prestadorMatch[0];
          this.logStep('info', 'Seção PRESTADOR encontrada', prestadorSection.substring(0, 200));
          
          // v3.6.8: Busca BHS MARINGA na seção prestador especificamente (mantida)
          const bhsPrestadorMatch = prestadorSection.match(/BHS\s+MARINGA\s+TECNOLOGIA[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
          if (bhsPrestadorMatch) {
            let name = this.cleanCompanyName(bhsPrestadorMatch[0]);
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'BHS MARINGA encontrada na seção PRESTADOR', name);
              return name;
            }
          }
          
          // Busca Razão Social na seção prestador (mantida)
          const razaoMatch = prestadorSection.match(/Raz[ãa]o\s+Social:\s*([^\r\n]+)/gi);
          if (razaoMatch) {
            let name = this.cleanCompanyName(razaoMatch[0]);
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'Nome encontrado em Razão Social da seção PRESTADOR', name);
              return name;
            }
          }
          
          // Busca qualquer linha com empresa na seção prestador (MELHORADA v3.8)
          const prestadorLines = prestadorSection.split(/[\r\n]+/).map(l => l.trim()).filter(l => l.length > 0);
          for (const line of prestadorLines) {
            if (line.length > 15 && line.length < 120 && 
                /LTDA|EPP|S\.?A|ME|EIRELI|CARTUCHOS|TECNOLOGIA|INFORMATICA|RIGO|FILHO|BHS|MARINGA|PORTEC|COMERCIO|SERVOPA|CAMINHOES|TRANSPOTECH|PECAS|SERVICOS|SINDICATO|VAREJISTA|FSC|COMUNICACOES|VANTOIR|DERETTI/gi.test(line) &&
                !/PRESTADOR|TOMADOR|ENDEREÇO|TELEFONE|EMAIL|CPF|CNPJ|Inscrição|Município|Complemento|UF:|CENTRO|MUNICÍPIO|Bairro CIC|Estado:|CURITIBA|BLUMENAU|ITOUPAVA NORTE|VIA EXPRESSA|PAUL FRITZ/i.test(line)) {
              
              let name = this.cleanCompanyName(line);
              if (this.validateCompanyNameImproved(name)) {
                this.logStep('success', 'Nome encontrado em linha da seção PRESTADOR', name);
                return name;
              }
            }
          }
        }

        // ESTRATÉGIA ORIGINAL 1: Busca específica por FUNILARIA NITZ (mantida - funcionando)
        const funilariaNitzMatch = text.match(/FUNILARIA\s+NITZ[^0-9\n\r]{0,50}LTDA[^0-9\n\r]*/gi);
        if (funilariaNitzMatch) {
          let name = this.cleanCompanyName(funilariaNitzMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'FUNILARIA NITZ encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA ORIGINAL 2: Busca específica por SASCAR (mantida - funcionando)
        const sascarMatch = text.match(/SASCAR[^0-9\n\r]*TECNOLOGIA[^0-9\n\r]*SEGUR[^0-9\n\r]*AUTOMOTIVA[^0-9\n\r]*S\.?A[^0-9\n\r]*/gi);
        if (sascarMatch) {
          let name = this.cleanCompanyName(sascarMatch[0]);
          if (name.includes('SASCAR') && name.length > 20) {
            this.logStep('success', 'SASCAR encontrada', name);
            return name;
          }
        }

        // ESTRATÉGIA ORIGINAL 3: Busca por primeira linha com nome da empresa (MELHORADA v3.8)
        const lines = text.split(/[\r\n]+/).map(l => l.trim()).filter(l => l.length > 0);
        for (let i = 0; i < Math.min(5, lines.length); i++) {
          const line = lines[i];
          
          if (line.length > 10 && line.length < 120 && 
              /LTDA|EPP|S\.?A|ME|EIRELI|SERVOPA|CAMINHOES|TRANSPOTECH|PECAS|SERVICOS|SINDICATO|COMERCIO|VAREJISTA|FSC|COMUNICACOES|VANTOIR|DERETTI/gi.test(line) &&
              !/PREFEITURA|MUNICIPAL|SECRETARIA|FAZENDA|TOMADOR|PRESTADOR|DOCUMENTO|EMITIDA|Complemento|UF:|CENTRO|MUNICÍPIO|Bairro CIC|Estado:|CURITIBA|BLUMENAU|ITOUPAVA NORTE|VIA EXPRESSA|PAUL FRITZ/i.test(line)) {
            
            let name = this.cleanCompanyName(line);
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', `Nome de empresa encontrado na linha ${i}`, name);
              return name;
            }
          }
        }

        // ESTRATÉGIA ORIGINAL 4: Busca direta por LUCIA IVONETE (mantida - funcionando)
        const luciaDirectMatch = text.match(/LUCIA\s+IVONETE[^0-9\n\r]{1,100}/i);
        if (luciaDirectMatch) {
          let name = luciaDirectMatch[0].trim();
          name = name.replace(/(Número|Situação|Emitida|Autenticidade|CNPJ).*$/i, '').trim();
          if (name.length > 10) {
            this.logStep('success', 'LUCIA IVONETE encontrada com busca direta', name);
            return name;
          }
        }

        // ESTRATÉGIA ORIGINAL 5: Busca por CNPJ e nome próximo (mantida)
        const cnpjPattern = new RegExp(cnpj.replace(/[^\d]/g, '').replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1\\.$2\\.$3/$4-$5'));
        const cnpjIndex = text.search(cnpjPattern);
        
        if (cnpjIndex > -1) {
          const beforeCnpj = text.substring(Math.max(0, cnpjIndex - 500), cnpjIndex);
          const beforeMatch = beforeCnpj.match(/([A-Z][^0-9\n\r]{5,80}(?:LTDA|EPP|S\.?A|ME)[^0-9\n\r]{0,20})[\s\S]*$/gi);
          if (beforeMatch) {
            let name = this.cleanCompanyName(beforeMatch[0]);
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'Nome encontrado antes do CNPJ', name);
              return name;
            }
          }
        }

        // ESTRATÉGIAS ORIGINAIS mantidas para compatibilidade... (MELHORADAS v3.8)
        const businessMatches = [
          text.match(/([A-Z][^0-9\n\r]{5,100}\s+EPP[^0-9\n\r]{0,50})/i),
          text.match(/([A-Z][^0-9\n\r]{5,100}\s+LTDA\s*-\s*ME[^0-9\n\r]{0,50})/i),
          text.match(/(RD\s+CARTUCHOS[^0-9\n\r]*LTDA[^0-9\n\r]*ME[^0-9\n\r]*)/gi),
          text.match(/(SERVOPA[^0-9\n\r]*CAMINHOES[^0-9\n\r]*LTDA[^0-9\n\r]*)/gi),  // v3.8
          text.match(/(TRANSPOTECH[^0-9\n\r]*PECAS[^0-9\n\r]*SERVICOS[^0-9\n\r]*LTDA[^0-9\n\r]*)/gi),  // v3.8
          text.match(/(SINDICATO[^0-9\n\r]*COMERCIO[^0-9\n\r]*VAREJISTA[^0-9\n\r]*)/gi),  // v3.8
          text.match(/(FSC[^0-9\n\r]*COMUNICACOES[^0-9\n\r]*LTDA[^0-9\n\r]*)/gi),  // v3.8
          text.match(/(VANTOIR[^0-9\n\r]*DERETTI[^0-9\n\r]*ME[^0-9\n\r]*)/gi)  // v3.8
        ];
        
        for (const match of businessMatches) {
          if (match) {
            let name = match[1] || match[0];
            name = name.replace(/(Número|Situação|Emitida|Autenticidade|CNPJ).*$/i, '').trim();
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'Nome empresarial encontrado com padrão original', name);
              return name;
            }
          }
        }

        this.logStep('fail', 'TODAS as estratégias (v3.8 + anteriores) falharam');
        return '';
      }

      extractFromPrestadorSection(text) {
        this.logStep('info', 'Buscando seção PRESTADOR DE SERVIÇOS');
        
        // ESTRATÉGIA 1: Busca seção específica do prestador (formato antigo)
        const prestadorRegex = /PRESTADOR\s+DE\s+SERVI[ÇC]OS[\s\S]*?(?=TOMADOR|DISCRIMINA[ÇC][ÃA]O|$)/gi;
        const prestadorMatch = text.match(prestadorRegex);
        
        if (prestadorMatch) {
          const prestadorSection = prestadorMatch[0];
          this.logStep('info', 'Seção PRESTADOR encontrada', prestadorSection.substring(0, 200) + '...');

          // Padrões específicos para NFS-e municipal
          const namePatterns = [
            /Nome\/Raz[ãa]o\s+social:\s*([^\r\n]+)/gi,
            /Raz[ãa]o\s+Social[:\s]*([^\r\n]+)/gi,
            /Nome\s+fantasia:\s*([^\r\n]+)/gi,
            /CPF\/CNPJ:\s*[\d\.\-\/\s]+[\r\n]+([^\r\n]+)/gi,
            /([A-Z][A-Z\s&\-\.]{10,80}(?:LTDA|ME|EPP|S\/A|EIRELI)[^\r\n]*)/gi
          ];

          for (const pattern of namePatterns) {
            const match = prestadorSection.match(pattern);
            if (match && match[1]) {
              const name = this.cleanCompanyName(match[1]);
              if (this.validateCompanyName(name)) {
                this.logStep('success', `Nome encontrado com padrão ${pattern.source}`, name);
                return name;
              }
            }
          }
        }

        // ESTRATÉGIA 2: NOVO - Busca no cabeçalho (formato Guaramirim)
        this.logStep('info', 'Buscando nome no cabeçalho do documento');
        
        const lines = text.split(/[\r\n]+/).map(l => l.trim()).filter(l => l.length > 0);
        
        // Busca nas primeiras 10 linhas do documento
        for (let i = 0; i < Math.min(10, lines.length); i++) {
          const line = lines[i];
          
          // Padrão específico: NOME - EPP - DESCRIÇÃO (formato Guaramirim)
          const headerPattern = /^([A-Z\s]+(?:EPP|LTDA|ME|EIRELI|S\/A)[^-]*(?:-[^-]+)*)/i;
          const match = line.match(headerPattern);
          
          if (match) {
            const name = this.cleanCompanyName(match[1]);
            if (this.validateCompanyName(name) && name.length > 10) {
              this.logStep('success', `Nome encontrado no cabeçalho linha ${i}`, name);
              return name;
            }
          }
          
          // Padrão alternativo: linha que termina com EPP, LTDA, etc.
          if (/(?:EPP|LTDA|ME|EIRELI|S\/A)\s*(?:-|$)/i.test(line) && line.length > 15) {
            const name = this.cleanCompanyName(line);
            if (this.validateCompanyName(name)) {
              this.logStep('success', `Nome encontrado por terminação linha ${i}`, name);
              return name;
            }
          }
        }

        this.logStep('warning', 'Nome não encontrado na seção PRESTADOR nem cabeçalho');
        return null;
      }

      extractWithSpecificPatterns(text) {
        this.logStep('info', 'Aplicando padrões ultra-específicos');

        // PADRÃO LASER 1: Formato específico Guaramirim (NOME - EPP - DESCRIÇÃO)
        const guaramirimPattern = /([A-Z\s]+ - EPP - [A-Z\s]+)/gi;
        const guaramirimMatch = text.match(guaramirimPattern);
        if (guaramirimMatch) {
          for (const match of guaramirimMatch) {
            const name = this.cleanCompanyName(match);
            if (this.validateCompanyName(name) && name.length > 10) {
              this.logStep('success', 'Nome encontrado com padrão Guaramirim', name);
              return name;
            }
          }
        }

        // PADRÃO LASER 2: LUCIA IVONETE específico (baseado no documento atual)
        const luciaPattern = /LUCIA\s+IVONETE[^\r\n]*/gi;
        const luciaMatch = text.match(luciaPattern);
        if (luciaMatch) {
          const name = this.cleanCompanyName(luciaMatch[0]);
          if (name.includes('LUCIA IVONETE')) {
            this.logStep('success', 'LUCIA IVONETE encontrada com padrão específico', name);
            return name;
          }
        }

        // PADRÃO LASER 3: RD CARTUCHOS específico (documento anterior)
        const rdCartuchosPattern = /RD\s+CARTUCHOS[^\r\n]*/gi;
        const rdMatch = text.match(rdCartuchosPattern);
        if (rdMatch) {
          const name = this.cleanCompanyName(rdMatch[0]);
          if (name.includes('RD CARTUCHOS')) {
            this.logStep('success', 'RD CARTUCHOS encontrado com padrão específico', name);
            return name;
          }
        }

        // PADRÃO LASER 4: Empresas com estrutura EPP específica
        const eppPatterns = [
          // NOME - EPP - DESCRIÇÃO
          /([A-Z\s]+ - EPP[^\r\n]*)/gi,
          
          // NOME EPP (sem hífen)
          /([A-Z][A-Z\s]{5,50} EPP[^\r\n]*)/gi,
          
          // NOME seguido de LTDA - ME
          /([A-Z][A-Z\s&\-\.]*LTDA\s*\-\s*ME)/gi,
          
          // NOME E SOBRENOME LTDA
          /([A-Z][A-Z\s&\-\.]*\s+E\s+[A-Z\s&\-\.]*LTDA[^,\r\n]*)/gi
        ];

        for (const pattern of eppPatterns) {
          const matches = [...text.matchAll(pattern)];
          for (const match of matches) {
            const name = this.cleanCompanyName(match[1]);
            if (this.validateCompanyName(name) && name.length > 8) {
              this.logStep('success', `Nome encontrado com padrão EPP`, name);
              return name;
            }
          }
        }

        // PADRÃO LASER 5: Busca no CNPJ específico (primeira linha do documento)
        const lines = text.split(/[\r\n]+/).map(l => l.trim()).filter(l => l.length > 0);
        if (lines.length > 0) {
          const firstLine = lines[0];
          // Se primeira linha tem mais de 20 caracteres e parece ser nome de empresa
          if (firstLine.length > 20 && /[A-Z]{3,}/.test(firstLine) && !/^\d/.test(firstLine)) {
            const name = this.cleanCompanyName(firstLine);
            if (this.validateCompanyName(name)) {
              this.logStep('success', 'Nome encontrado na primeira linha', name);
              return name;
            }
          }
        }

        this.logStep('warning', 'Padrões específicos não encontraram nome válido');
        return null;
      }

      extractFromCNPJProximity(text, cnpj) {
        this.logStep('info', 'Buscando nome próximo ao CNPJ do emitente');
        
        const cnpjClean = cnpj.replace(/\D/g, '');
        const lines = text.split(/[\r\n]+/);
        
        // Encontra linha com o CNPJ
        const cnpjLineIndex = lines.findIndex(line => 
          line.includes(cnpjClean) && !line.includes(COMPANY_CNPJ.replace(/\D/g, ''))
        );
        
        if (cnpjLineIndex === -1) {
          this.logStep('warning', 'CNPJ não encontrado nas linhas do texto');
          return null;
        }

        this.logStep('info', `CNPJ encontrado na linha ${cnpjLineIndex}`);

        // Busca nas linhas próximas (3 antes e 3 depois)
        for (let i = Math.max(0, cnpjLineIndex - 3); i <= Math.min(lines.length - 1, cnpjLineIndex + 3); i++) {
          const line = lines[i].trim();
          
          // Pula linha do próprio CNPJ se não tem letras suficientes
          if (i === cnpjLineIndex && !/[A-Za-z]{5,}/.test(line)) continue;
          
          // Busca padrões de empresa na linha
          const companyPattern = /([A-Z][A-Z\s&\-\.]{5,80}(?:LTDA|ME|EPP|S\/A|EIRELI)[^\r\n]*)/gi;
          const match = line.match(companyPattern);
          
          if (match) {
            const name = this.cleanCompanyName(match[0]);
            if (this.validateCompanyName(name)) {
              this.logStep('success', `Nome encontrado próximo ao CNPJ na linha ${i}`, name);
              return name;
            }
          }
        }

        this.logStep('warning', 'Nome não encontrado próximo ao CNPJ');
        return null;
      }

      // ===== EXTRAÇÃO DE NÚMERO DO DOCUMENTO LASER =====
      extractDocumentNumberLaser(text) {
        this.logStep('info', 'Iniciando extração LASER de número do documento');

        // ESTRATÉGIA LASER 1: Busca específica em tabela estruturada
        const tableResult = this.extractFromDocumentTable(text);
        if (tableResult) {
          this.logStep('success', 'Número encontrado em tabela estruturada', tableResult);
          return tableResult;
        }

        // ESTRATÉGIA LASER 2: Busca por "Número da nota" específico
        const noteNumberResult = this.extractNoteNumber(text);
        if (noteNumberResult) {
          this.logStep('success', 'Número encontrado via "Número da nota"', noteNumberResult);
          return noteNumberResult;
        }

        // ESTRATÉGIA LASER 3: Busca em cabeçalho estruturado
        const headerResult = this.extractFromHeader(text);
        if (headerResult) {
          this.logStep('success', 'Número encontrado em cabeçalho', headerResult);
          return headerResult;
        }

        this.logStep('fail', 'Número do documento não encontrado');
        return '';
      }

      extractFromDocumentTable(text) {
        this.logStep('info', 'Buscando número em tabela de documento');

        // Padrão específico: Página X/Y seguido de "Número da nota" seguido do número
        const tablePattern = /Página\s+\d+\/\d+[\s\S]*?N[úu]mero\s+da\s+nota[\s\S]*?(\d{3,8})/gi;
        const match = text.match(tablePattern);
        
        if (match) {
          const numberMatch = match[0].match(/(\d{3,8})/);
          if (numberMatch && this.validateDocumentNumber(numberMatch[1])) {
            this.logStep('info', 'Número encontrado em estrutura de tabela', numberMatch[1]);
            return numberMatch[1];
          }
        }

        // Padrão alternativo: busca por estrutura visual específica
        const lines = text.split(/[\r\n]+/);
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // Se encontrar "Número da nota"
          if (/N[úu]mero\s+da\s+nota/i.test(line)) {
            this.logStep('info', `Encontrado "Número da nota" na linha ${i}`);
            
            // Busca número na mesma linha ou próximas
            for (let j = i; j <= Math.min(i + 3, lines.length - 1); j++) {
              const numberMatch = lines[j].match(/\b(\d{3,8})\b/);
              if (numberMatch && this.validateDocumentNumber(numberMatch[1])) {
                this.logStep('info', `Número encontrado na linha ${j}`, numberMatch[1]);
                return numberMatch[1];
              }
            }
          }
        }

        this.logStep('warning', 'Número não encontrado em tabela');
        return null;
      }

      extractNoteNumber(text) {
        this.logStep('info', 'Buscando "Número da nota" específico');

        // Padrões laser para "Número da nota"
        const patterns = [
          /N[úu]mero\s+da\s+nota[\s:]*(\d{3,8})/gi,
          /da\s+nota[\s:]*(\d{3,8})/gi,
          /Nota[\s\w]*?:\s*(\d{3,8})/gi
        ];

        for (const pattern of patterns) {
          const matches = [...text.matchAll(pattern)];
          for (const match of matches) {
            if (this.validateDocumentNumber(match[1])) {
              this.logStep('info', `Padrão "${pattern.source}" encontrou número`, match[1]);
              return match[1];
            }
          }
        }

        this.logStep('warning', 'Padrões de "Número da nota" não encontraram resultado');
        return null;
      }

      extractFromHeader(text) {
        this.logStep('info', 'Buscando número em cabeçalho');

        // Pega primeiras 20 linhas (cabeçalho)
        const lines = text.split(/[\r\n]+/).slice(0, 20);
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // Se a linha contém indicadores de cabeçalho
          if (/NOTA\s+FISCAL|NFS-e|MUNICIPAL/i.test(line)) {
            // Busca números nas próximas linhas
            for (let j = i; j < Math.min(i + 5, lines.length); j++) {
              const numberMatch = lines[j].match(/\b(\d{3,8})\b/);
              if (numberMatch && this.validateDocumentNumber(numberMatch[1])) {
                this.logStep('info', `Número encontrado em cabeçalho linha ${j}`, numberMatch[1]);
                return numberMatch[1];
              }
            }
          }
        }

        this.logStep('warning', 'Número não encontrado em cabeçalho');
        return null;
      }

      // ===== MÉTODOS AUXILIARES =====
      validateDocumentNumber(number) {
        if (!number) return false;
        const clean = number.toString().replace(/\D/g, '');
        
        // Validações específicas
        if (clean.length < 3 || clean.length > 8) return false;
        if (parseInt(clean) < 100) return false;
        
        // IMPORTANTE: Não aceitar anos (2020-2030)
        const num = parseInt(clean);
        if (num >= 2020 && num <= 2030) return false;
        
        // Não aceitar sequências óbvias
        if (/^0+$/.test(clean)) return false;
        if (/^1+$/.test(clean)) return false;
        
        return true;
      }

      // MELHORIA v3.8: Validação aprimorada para novos casos específicos
      validateCompanyNameImproved(name) {
        if (!name || name.length < 5 || name.length > 150) return false;
        if (!/[A-Za-z]/.test(name)) return false;
        if (/^[\d\s\-\.]+$/.test(name)) return false;
        
        // FILTRO CRÍTICO: Não aceitar nomes que são claramente do órgão público ou tomador
        if (/SECRETARIA|MUNICIPAL|FAZENDA|PREFEITURA|TOMADOR|PRESTADOR|COMERCIO DE BANANAS|Optante Simples|Regime|Situação|Documento emitido|Complemento|UF:|CENTRO|MUNICÍPIO|Data Prestação|Número:|Bairro CIC|Estado:|CURITIBA|BLUMENAU|MASSARANDUBA|ITOUPAVA NORTE/i.test(name)) {
          return false;
        }
        
        // NOVOS PADRÕES ACEITOS v3.8 (ADICIONADOS):
        // Aceitar VANTOIR DERETTI ME
        if (/VANTOIR.*DERETTI/i.test(name)) return true;
        
        // Aceitar SERVOPA CAMINHOES LTDA
        if (/SERVOPA.*CAMINHOES/i.test(name)) return true;
        
        // Aceitar TRANSPOTECH PECAS E SERVICOS LTDA
        if (/TRANSPOTECH.*PECAS.*SERVICOS/i.test(name)) return true;
        
        // Aceitar SINDICATO DO COMERCIO VAREJISTA
        if (/SINDICATO.*COMERCIO.*VAREJISTA/i.test(name)) return true;
        
        // Aceitar FSC COMUNICACOES LTDA
        if (/FSC.*COMUNICACOES/i.test(name)) return true;
        
        // PADRÕES v3.6 (mantidos):
        // Aceitar M.A. DA SILVA VIEIRA - AUTO ELÉTRICA
        if (/M\.A\.\s+DA\s+SILVA\s+VIEIRA.*AUTO.*EL[EÉ]TRICA/i.test(name)) return true;
        
        // Aceitar BHS MARINGA TECNOLOGIA
        if (/BHS.*MARINGA.*TECNOLOGIA/i.test(name)) return true;
        
        // Aceitar PORTEC COMERCIO
        if (/PORTEC.*COMERCIO.*PRODUTOS.*ELETRONICOS/i.test(name)) return true;
        
        // Aceitar TRANORTE SISTEMAS
        if (/TRANORTE.*SISTEMAS.*MECANIZADOS/i.test(name)) return true;
        
        // Aceitar POSTO Z4
        if (/POSTO\s+Z4/i.test(name)) return true;
        
        // Aceitar CONTABILIDADE ORLANDO AMORIM
        if (/CONTABILIDADE.*ORLANDO.*AMORIM/i.test(name)) return true;
        
        // PADRÕES v3.5 (mantidos):
        // Aceitar nomes com iniciais (W.O., J.A., etc.)
        if (/^[A-Z]\.[A-Z]\.\s+[A-Z]/i.test(name)) return true;
        
        // Aceitar W.O. RIGO FILHO específico
        if (/W\.O\.\s+RIGO\s+FILHO/i.test(name)) return true;
        
        // Aceitar FUNILARIA NITZ
        if (/FUNILARIA\s+NITZ/i.test(name)) return true;
        
        // Aceitar SASCAR
        if (/SASCAR.*TECNOLOGIA/i.test(name)) return true;
        
        // Aceitar nomes com EPP, LTDA, ME, S.A etc.
        if (/EPP|LTDA|ME|EIRELI|S\.?A/i.test(name)) return true;
        
        // Aceitar se tem pelo menos 3 palavras maiúsculas (nomes de pessoas)
        const upperWords = name.match(/[A-Z]{2,}/g);
        if (upperWords && upperWords.length >= 3) return true;
        
        // Aceitar se tem palavras características de empresa (MELHORADO v3.8)
        if (/DIESEL|MECANICA|CARTUCHOS|INFORMATICA|INDUSTRIA|SERVICOS|TECNOLOGIA|SEGURANCA|AUTOMOTIVA|FUNILARIA|RIGO|FILHO|BHS|MARINGA|PORTEC|COMERCIO|TRANORTE|SISTEMAS|POSTO|CONTABILIDADE|ORLANDO|AMORIM|AUTO|ELETRICA|SERVOPA|CAMINHOES|TRANSPOTECH|PECAS|SINDICATO|VAREJISTA|FSC|COMUNICACOES|VANTOIR|DERETTI/i.test(name)) return true;
        
        return false;
      }

      validateCompanyName(name) {
        // Mantém função original para compatibilidade
        return this.validateCompanyNameImproved(name);
      }

      // MELHORIA v3.8: Limpeza aprimorada para casos específicos do log
      cleanCompanyName(name) {
        if (!name) return '';
        
        return name
          .replace(/^(Nome\/Razão social:|Razão Social:|Nome fantasia:|PRESTADOR:|CPF\/CNPJ:|Prestador de Serviços|Razão Social:)/gi, '')
          .replace(/^(e\s+|de\s+|da\s+|do\s+)/gi, '') // Remove artigos do início
          .replace(/(Inscrição|CPF\/CNPJ|Telefone|E-mail|Número da NFS-e|Situação|Emitida|Autenticidade|CNPJ:|Número da|CEP|Endereço|Município|Email:|Complemento|UF:|Data Prestação|Documento emitido).*$/gi, '')
          .replace(/(TOMADOR|COMERCIO DE BANANAS|ALAMEDA|TORRE|ANDAR|SITIO|CENTRO|MUNICÍPIO|SECRETARIA|FAZENDA|Nota Fiscal|Número:|Data de|PRESTADOR DE|Inscrigao estadual|Bairro CIC|Estado:|PR CURITIBA|SC BLUMENAU|Endereço:|VIA EXPRESSA|PAUL FRITZ|KUEHNRICH).*$/gi, '') // Remove tomador e endereços + novos filtros v3.8
          .replace(/[\r\n]+/g, ' ') // Remove quebras de linha
          .replace(/^[\s\W]+|[\s\W]+$/g, '')
          .replace(/\s+/g, ' ')  // Normaliza espaços múltiplos
          .trim();
      }

      formatCNPJ(cnpj) {
        return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      }

      // ===== MÉTODO PRINCIPAL =====
      async extractAllData(text, filename) {
        this.debugSteps = [];
        this.logStep('info', `=== INICIANDO EXTRAÇÃO v3.8 PARA ${filename} ===`);
        
        const data = {
          filename: filename,
          cnpj_emitente: '',
          nome_emitente: '',
          data_emissao: '',
          numero_documento: '',
          valor_total: '',
          descricao: '',
          status: 'pending' // NOVO: campo de status
        };

        try {
          // CNPJ do emitente
          data.cnpj_emitente = this.extractCNPJEmitente(text);
          
          // Nome do emitente (LASER)
          if (data.cnpj_emitente) {
            data.nome_emitente = this.extractEmitenteNameLaser(text, data.cnpj_emitente);
          }
          
          // Número do documento (LASER)
          data.numero_documento = this.extractDocumentNumberLaser(text);
          
          // Dados tradicionais (funcionam bem)
          data.data_emissao = this.extractDataEmissao(text);
          data.valor_total = this.extractValorTotal(text);
          data.descricao = this.extractDescription(text);
          
          // Determinar status baseado na qualidade da extração
          data.status = this.determineExtractionStatus(data);
          
          this.logStep('success', '=== EXTRAÇÃO v3.8 CONCLUÍDA ===', data);
          
          return data;
          
        } catch (error) {
          this.logStep('error', 'ERRO NA EXTRAÇÃO ULTRA-DIRETA', error.message);
          return {
            ...data,
            nome_emitente: 'ERRO ULTRA-DIRETO',
            numero_documento: 'ERRO',
            descricao: error.message,
            status: 'error'
          };
        }
      }

      // NOVO: Determina status da extração
      determineExtractionStatus(data) {
        let score = 0;
        if (data.cnpj_emitente) score++;
        if (data.nome_emitente && data.nome_emitente !== 'ERRO ULTRA-DIRETO') score++;
        if (data.data_emissao) score++;
        if (data.numero_documento && data.numero_documento !== 'ERRO') score++;
        if (data.valor_total) score++;
        if (data.descricao && data.descricao !== 'serviços não especificados') score++;

        if (score >= 5) return 'success';
        if (score >= 3) return 'warning';
        return 'error';
      }

      // ===== MÉTODOS TRADICIONAIS (funcionam bem) =====
      extractDataEmissao(text) {
        const patterns = [
          /\b(\d{2}\/\d{2}\/\d{4})\b/g,
          /\b(\d{4}-\d{2}-\d{2})\b/g,
          /\b(\d{2}-\d{2}-\d{4})\b/g
        ];
        
        for (const pattern of patterns) {
          const matches = [...text.matchAll(pattern)];
          for (const match of matches) {
            const date = match[1];
            if (this.isValidDate(date)) {
              return this.formatDate(date);
            }
          }
        }
        return '';
      }

      extractValorTotal(text) {
        const valorMatch = text.match(/Valor\s*Total[:\s]*([\d\.,]+)/i) || 
                          text.match(/Valor\s*L[ií]quido[:\s]*([\d\.,]+)/i);
        
        if (valorMatch) {
          return valorMatch[1].trim().replace(/[^\d\.,]/g, '');
        }
        
        const moneyMatches = [...text.matchAll(/\b\d{1,3}(?:\.\d{3})*,\d{2}\b/g)];
        
        if (moneyMatches.length === 0) return '';
        
        const values = moneyMatches.map(match => {
          const valueStr = match[0];
          return {
            original: valueStr,
            numeric: parseFloat(valueStr.replace(/\./g, '').replace(',', '.'))
          };
        });
        
        const maxValue = values.reduce((max, current) => 
          current.numeric > max.numeric ? current : max
        );
        
        return maxValue.original;
      }

      extractDescription(text) {
        const descPatterns = [
          /Descri[çc][ãa]o\s+do\s+Servi[çc]o[^:\n]*:?\s*([\s\S]{10,300}?)(?=\n\s*\n|\n[A-Z]{3,}|Valor|$)/gi,
          /DISCRIMINA[ÇC][ÃA]O[^:\n]*:?\s*([\s\S]{10,300}?)(?=\n\s*\n|\n[A-Z]{3,}|Valor|$)/gi
        ];
        
        for (const pattern of descPatterns) {
          const matches = [...text.matchAll(pattern)];
          if (matches.length > 0) {
            return matches[0][1].trim()
              .replace(/\n+/g, ' ')
              .replace(/\s+/g, ' ')
              .substring(0, 120);
          }
        }
        
        return 'serviços não especificados';
      }

      isValidDate(dateStr) {
        const formats = [
          /^\d{2}\/\d{2}\/\d{4}$/,
          /^\d{4}-\d{2}-\d{2}$/,
          /^\d{2}-\d{2}-\d{4}$/
        ];
        
        return formats.some(format => format.test(dateStr));
      }
      
      formatDate(dateStr) {
        if (dateStr.includes('-')) {
          const parts = dateStr.split('-');
          if (parts[0].length === 4) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
          } else {
            return dateStr.replace(/-/g, '/');
          }
        }
        return dateStr;
      }
    }

    // ===== INSTÂNCIA DO EXTRATOR ULTRA-DIRETO =====
    const ultraDirectExtractor = new UltraDirectExtractor();

    // ===== NOVAS FUNCIONALIDADES - MELHORIAS =====

    // Sistema de notificações
    function showNotification(message, type = 'success') {
      const notification = document.getElementById(type === 'error' ? 'errorNotification' : 'successNotification');
      const messageElement = document.getElementById(type === 'error' ? 'errorMessage' : 'successMessage');
      
      messageElement.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    // Sistema de estatísticas
    function updateStatistics() {
      statistics.totalProcessed = extractionResults.length;
      statistics.successCount = extractionResults.filter(r => r.status === 'success').length;
      statistics.errorCount = extractionResults.filter(r => r.status === 'error').length;
      
      // Calcular valor total
      statistics.totalValue = extractionResults.reduce((total, item) => {
        if (item.valor_total && item.status !== 'error') {
          const value = parseFloat(item.valor_total.replace(/\./g, '').replace(',', '.'));
          return total + (isNaN(value) ? 0 : value);
        }
        return total;
      }, 0);

      // Empresas únicas
      statistics.uniqueCompanies.clear();
      extractionResults.forEach(item => {
        if (item.nome_emitente && item.status !== 'error') {
          statistics.uniqueCompanies.add(item.nome_emitente);
        }
      });

      // Atualizar interface
      document.getElementById('totalProcessed').textContent = statistics.totalProcessed;
      document.getElementById('successRate').textContent = 
        statistics.totalProcessed > 0 ? 
        Math.round((statistics.successCount / statistics.totalProcessed) * 100) + '%' : '0%';
      document.getElementById('totalValue').textContent = 
        'R$ ' + statistics.totalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      document.getElementById('uniqueCompanies').textContent = statistics.uniqueCompanies.size;
    }

    // Sistema de filtros
    function applyFilters() {
      const companyFilter = document.getElementById('filterCompany').value.toLowerCase();
      const dateFromFilter = document.getElementById('filterDateFrom').value;
      const dateToFilter = document.getElementById('filterDateTo').value;

      let filteredResults = [...originalResults];

      if (companyFilter) {
        filteredResults = filteredResults.filter(item => 
          item.nome_emitente.toLowerCase().includes(companyFilter)
        );
      }

      if (dateFromFilter) {
        filteredResults = filteredResults.filter(item => {
          if (!item.data_emissao) return false;
          const itemDate = item.data_emissao.split('/').reverse().join('-');
          return itemDate >= dateFromFilter;
        });
      }

      if (dateToFilter) {
        filteredResults = filteredResults.filter(item => {
          if (!item.data_emissao) return false;
          const itemDate = item.data_emissao.split('/').reverse().join('-');
          return itemDate <= dateToFilter;
        });
      }

      // Atualizar tabela
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';
      filteredResults.forEach(data => renderResult(data, data.status === 'error'));

      showNotification(`Filtro aplicado: ${filteredResults.length} resultados encontrados`);
    }

    function clearFilters() {
      document.getElementById('filterCompany').value = '';
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      
      // Restaurar todos os resultados
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';
      originalResults.forEach(data => renderResult(data, data.status === 'error'));

      showNotification('Filtros removidos');
    }

    // Sistema de backup/save dos dados
    function saveDataToLocalStorage() {
      try {
        const dataToSave = {
          timestamp: new Date().toISOString(),
          results: extractionResults,
          statistics: {
            ...statistics,
            uniqueCompanies: Array.from(statistics.uniqueCompanies)
          }
        };
        
        localStorage.setItem('nfse_data_backup', JSON.stringify(dataToSave));
        showNotification('Dados salvos com sucesso!');
      } catch (error) {
        showNotification('Erro ao salvar dados: ' + error.message, 'error');
      }
    }

    function loadDataFromLocalStorage() {
      try {
        const savedData = localStorage.getItem('nfse_data_backup');
        if (savedData) {
          const parsedData = JSON.parse(savedData);
          
          // Confirmar restauração
          if (confirm('Dados salvos encontrados. Deseja restaurar?')) {
            extractionResults = parsedData.results || [];
            originalResults = [...extractionResults];
            
            // Restaurar estatísticas
            if (parsedData.statistics) {
              statistics = {
                ...parsedData.statistics,
                uniqueCompanies: new Set(parsedData.statistics.uniqueCompanies || [])
              };
            }
            
            // Atualizar interface
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            extractionResults.forEach(data => renderResult(data, data.status === 'error'));
            
            updateStatistics();
            enableExportIfAny();
            showResults();
            showNotification('Dados restaurados com sucesso!');
            
            return true;
          }
        }
      } catch (error) {
        showNotification('Erro ao carregar dados: ' + error.message, 'error');
      }
      return false;
    }

    // Função para validar dados de uma linha
    function validateRowData(rowElement) {
      const cells = Array.from(rowElement.querySelectorAll('td[contenteditable]'));
      let isValid = true;
      
      // Validação básica de CNPJ
      const cnpj = cells[0].textContent.trim();
      if (cnpj && !/^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/.test(cnpj)) {
        cells[0].style.borderColor = 'red';
        isValid = false;
      } else {
        cells[0].style.borderColor = '';
      }
      
      // Validação de nome (não pode estar vazio)
      const nome = cells[1].textContent.trim();
      if (!nome || nome.length < 5) {
        cells[1].style.borderColor = 'red';
        isValid = false;
      } else {
        cells[1].style.borderColor = '';
      }
      
      return isValid;
    }

    // ===== VERIFICAÇÃO DE BIBLIOTECAS =====
    function checkLibraries() {
      const statusSection = document.getElementById('statusSection');
      const statusMessage = document.getElementById('statusMessage');
      
      statusSection.style.display = 'block';
      
      let allLoaded = true;
      let message = '';
      
      if (typeof pdfjsLib === 'undefined') {
        console.error('PDF.js não carregado');
        message += 'PDF.js não carregado. ';
        allLoaded = false;
      }
      
      if (typeof Tesseract === 'undefined') {
        console.error('Tesseract.js não carregado');
        message += 'Tesseract.js não carregado. ';
        allLoaded = false;
      }
      
      if (typeof XLSX === 'undefined') {
        console.error('SheetJS não carregado');
        message += 'SheetJS não carregado. ';
        allLoaded = false;
      }
      
      if (allLoaded) {
        statusMessage.innerHTML = '<i class="fas fa-check-circle"></i> Sistema v3.8 ativo! Correções do log: VANTOIR DERETTI + SERVOPA + TRANSPOTECH + SINDICATO + FSC + M.A. SILVA + BHS + PORTEC implementadas.';
        statusMessage.className = 'status-ok';
        librariesLoaded = true;
        
        setTimeout(() => {
          statusSection.style.display = 'none';
        }, 3000);
        
        console.log('🎯 Sistema de Extração v3.8 inicializado');
        
        // Tentar carregar dados salvos
        loadDataFromLocalStorage();
        
      } else {
        statusMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Erro: ${message}`;
        statusMessage.className = 'status-error';
        librariesLoaded = false;
        
        console.error('Erro no carregamento das bibliotecas:', message);
      }
    }

    // ===== PROCESSAMENTO DE ARQUIVOS =====
    async function handleFiles(files) {
      if (!librariesLoaded) {
        showNotification('Aguarde o carregamento do sistema ULTRA-DIRETO!', 'error');
        return;
      }
      
      showProgress();
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        updateProgress(i, files.length, `Aplicando extração ultra-direta em ${file.name}...`);
        
        try {
          let extractedText = '';
          if
