<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Automatizador de Notas – Santomé</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
<!-- Bibliotecas locais (PDF.js, Tesseract.js, SheetJS) -->
<script type="module">
  /* ---------- PDF.js ---------- */
  import * as pdfjsLib from './libs/pdf.min.mjs';
  pdfjsLib.GlobalWorkerOptions.workerSrc = './libs/pdf.worker.min.mjs';
  window.pdfjsLib = pdfjsLib;                     /* mantém compatibilidade */

  /* ---------- Tesseract.js ---------- */
  import Tesseract from './libs/tesseract.esm.min.js';   /* export default */
  const { createWorker } = Tesseract;
  window.Tesseract = { ...Tesseract, createWorker };
// ===== Cache helpers =====
window.cacheEmitenteName = function cacheEmitenteName(cnpj, nome){
  const digits = (cnpj||'').replace(/\D/g,'');
  if(digits.length===14 && nome) localStorage.setItem('nm_'+digits, nome);
}
window.getCachedEmitenteName = function getCachedEmitenteName(cnpj){
  const digits = (cnpj||'').replace(/\D/g,'');
  if(digits.length===14){
    return localStorage.getItem('nm_'+digits) || '';
  }
  return '';
}


  /* ---------- SheetJS ---------- */
  import * as XLSX from './libs/xlsx.mjs';               /* build ESM */
  window.XLSX = XLSX;

  if (typeof checkLibraries === 'function') checkLibraries();
</script>
  
  <!-- PDF.js -->
  <!-- Tesseract.js -->
<!-- SheetJS -->
<!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ====== Variáveis de cor ====== */
    :root {
      --primary-color: #304ffe;
      --secondary-color: #eef2ff;
      --border-color: #d9d9d9;
      --success-color: #00c853;
      --error-color: #d32f2f;
      --light-text: #666;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #1a1a1a;
        --card-bg: #2d2d2d;
        --border-color: #404040;
        --light-text: #ccc;
      }
    }
    
    /* Garantir que a tabela sempre tenha fundo claro, independente do modo escuro */
    .table-container {
      background-color: #ffffff !important;
    }
    
    table {
      background-color: #ffffff !important;
    }
    
    th, td {
      background-color: #ffffff !important;
      color: #333333 !important;
    }
    
    th {
      background-color: #f0f4ff !important;
    }

    /* Reset e base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary-color), #1e88e5);
      color: white;
      padding: 2rem 0;
      text-align: center;
      box-shadow: var(--shadow);
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }

    header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    /* Main container */
    main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      width: 100%;
    }

    /* Upload section */
    .upload-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 2px dashed var(--border-color);
      transition: all 0.3s ease;
    }

    .upload-section.dragover {
      border-color: var(--primary-color);
      background-color: var(--secondary-color);
      transform: scale(1.02);
    }

    .upload-area {
      text-align: center;
      padding: 3rem 2rem;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .upload-area:hover {
      background-color: var(--secondary-color);
    }

    .upload-icon {
      font-size: 4rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    .upload-text {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .upload-hint {
      color: var(--light-text);
      font-size: 0.9rem;
    }

    #fileInput {
      display: none;
    }

    /* Progress section */
    .progress-section {
      margin-top: 1.5rem;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--success-color));
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.9rem;
      color: var(--light-text);
      text-align: center;
    }

    /* Results section */
    .results-section {
      display: none;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .results-title {
      font-size: 1.5rem;
      color: #333;
    }

    .export-btn {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .export-btn:hover:not(:disabled) {
      background: #4caf50;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .export-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Table container */
    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      background: var(--card-bg);
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      vertical-align: top;
    }

    th {
      background: var(--secondary-color);
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td[contenteditable="true"] {
      border: 2px solid transparent;
      border-radius: 4px;
      transition: border-color 0.3s ease;
      cursor: text;
    }

    td[contenteditable="true"]:hover {
      border-color: var(--primary-color);
      background-color: var(--secondary-color);
    }

    td[contenteditable="true"]:focus {
      outline: none;
      border-color: var(--primary-color);
      background-color: white;
    }

    .error-row {
      background-color: #ffebee;
    }

    .error-row td {
      color: var(--error-color);
    }

    .delete-btn {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .delete-btn:hover {
      background: #c62828;
      transform: scale(1.1);
    }

    /* Footer */
    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    footer a {
      color: var(--primary-color);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive design */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2rem;
      }
      
      main {
        padding: 1rem;
      }
      
      .upload-section,
      .results-section {
        padding: 1.5rem;
      }
      
      .upload-area {
        padding: 2rem 1rem;
      }
      
      .upload-icon {
        font-size: 3rem;
      }
      
      .results-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 0.5rem;
      }
    }

    @media (max-width: 360px) {
      header {
        padding: 1.5rem 0;
      }
      
      header h1 {
        font-size: 1.8rem;
      }
      
      .upload-section,
      .results-section {
        padding: 1rem;
      }
      
      .upload-area {
        padding: 1.5rem 0.5rem;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1><i class="fas fa-file-invoice"></i> Automatizador de Notas</h1>
    <p>Extração automática de dados de NFS-e para COMERCIO DE BANANAS SANTOMÉ LTDA</p>
  </header>

  <main>
    <section class="upload-section" id="uploadSection">
      <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-text">Solte aqui PDFs ou imagens</div>
        <div class="upload-hint">ou clique para selecionar arquivos</div>
      </div>
      <input type="file" id="fileInput" multiple accept=".pdf,image/*">
      
      <div class="progress-section" id="progressSection">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Processando arquivos...</div>
      </div>
    </section>

    <section class="results-section" id="resultsSection">
      <div class="results-header">
        <h2 class="results-title">Resultados Extraídos</h2>
        <button class="export-btn" id="exportBtn" disabled>
          <i class="fas fa-file-excel"></i>
          Exportar Excel
        </button>
      </div>
      
      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>CNPJ Emitente</th>
              <th>Nome Emitente</th>
              <th>Data Emissão</th>
              <th>Nº Documento</th>
              <th>Valor Total</th>
              <th>Descrição</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 COMERCIO DE BANANAS SANTOMÉ LTDA | 
    <a href="#" onclick="alert('Manual de uso em desenvolvimento')">Manual de Uso</a></p>
  </footer>

  <script>
    // Global variables
// ===== Cache helpers (global) =====
function cacheEmitenteName(cnpj, nome){
  const digits = (cnpj||'').replace(/\D/g,'');
  if(digits.length===14 && nome) localStorage.setItem('nm_'+digits, nome);
}
function getCachedEmitenteName(cnpj){
  const digits = (cnpj||'').replace(/\D/g,'');
  if(digits.length===14){
    return localStorage.getItem('nm_'+digits) || '';
  }
  return '';
}

    let processedFiles = 0;
    let totalFiles = 0;
    let extractedData = [];
    
    // Company CNPJ to ignore (tomador)
    const COMPANY_CNPJ = '07.925.317/0001-88';
    
    // Initialize PDF.js with verification
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = './libs/pdf.worker.min.mjs';
    }
    
    // Regular expressions
    
/* ---------- Nº DOCUMENTO robusto ---------- */
function detectNumeroDocumento(text){
  const etiquetas = [
    /Número da (?:NFS.?e|Nota)[^\d]{0,15}(\d{3,})/i,
    /Nº\s?(?:NF|Documento|RPS)[^\d]{0,10}(\d{3,})/i,
    /RPS\s*[:#-]?\s*(\d{3,})/i
  ];
  for(const re_ of etiquetas){
    const m = text.match(re_);
    if(m) return m[1];
  }
  const topo = text.slice(0, Math.floor(text.length*0.25));
  const m = topo.match(/\b(\d{4,9})\b/);
  return m ? m[1] : '';
}

/* ---------- DESCRIÇÃO limpa ---------- */
function detectDescricao(text){
  const lab = /(Descrição do Serviço[^:\n]*:|DESCRIÇÃO DOS SERVIÇOS PRESTADOS|DISCRIMINA[ÇC]ÃO DOS SERVIÇOS)/i;
  const i = text.search(lab);
  if(i !== -1){
    let linha = text.slice(i).split(/\n/).slice(1,6)
                 .map(l=>l.trim())
                 .find(l => l && !/valor (unit|serviço)/i.test(l));
    if(linha){
      linha = linha.replace(/valor.*$/i,'')
                   .replace(/\s{2,}/g,' ')
                   .toLowerCase();
      const placa = linha.match(/\b([A-Z]{3}[-\s]?\d[A-Z0-9]\d{2}|[A-Z]{3}-?\d{4})\b/i);
      return (placa ? placa[0].toUpperCase()+' – ' : '') + linha.slice(0,120);
    }
  }
  return '';
}

const regexes = {
      cnpj: /\b\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}\b/g,
      date: /\b\d{2}\/\d{2}\/\d{4}\b/g,
      dateISO: /\b\d{4}-\d{2}-\d{2}\b/g,
      money: /\d{1,3}(?:\.\d{3})*,\d{2}/g,
      docNumber: /(?:Número da NFS-e|Número da Nota|Nº NF|Nº RPS|RPS)\s*:?\s*(\d+)/i,
      placa: /([A-Z]{3}[-\s]?\d[A-Z0-9]\d{2}|[A-Z]{3}-?\d{4})/g
    };
// ======== HELPERS NOVOS ========
// Remove acentuação e normaliza string
const normalize = s => s.normalize("NFD").replace(/[̀-\u036f]/g, "");




/** Extrai nome do emitente a partir do texto bruto */




function getEmitenteName(text, cnpj){
  if(!cnpj) return "";
  const digits = cnpj.replace(/\D/g,"");

  const cached = getCachedEmitenteName(cnpj);
  if(cached) return cached;

  const isValid = nome=>{
      if(!nome) return false;
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(nome)) return false;
      const bad = /(CPF|CNPJ|TOMADOR|CONSUMIDOR|SERVI[ÇC]OS?\s*CPF|NOTA|N[ÚU]MERO)/i;
      if(bad.test(nome)) return false;
      return (nome.match(/[A-Z]/gi)||[]).length >= 5;
  };

  const blocoPrest = text.match(/PRESTADOR(?: DE)? SERVI[ÇC]OS([\s\S]{0,200})TOMADOR/i);
  if(blocoPrest){
      const cand = blocoPrest[1].split(/[\r\n]+/).map(l=>l.trim()).filter(l=>l);
      const melhor = cand.find(l=>/Raz[aã]o/i.test(l)) || cand.find(l=>/fantasia/i.test(l)) || cand[0];
      if(isValid(melhor)) return melhor.replace(/\s+/g," ").trim();
  }

  const rot = text.match(/(?:Raz[aã]o Social|Nome\/Raz[aã]o social|Nome fantasia|Emitente)[^:\n]*:\s*([^\n]{5,})/i);
  if(rot && isValid(rot[1])) return rot[1].replace(/\s+/g," ").trim();

  const lines = text.split(/[\r\n]+/).map(l=>l.trim()).filter(Boolean);
  const idx = lines.findIndex(l=>l.replace(/\D/g,"").includes(digits));
  const compKey = /(LTDA|EPP|MEI|EIRELI|S\.?A|SERVI[ÇC]OS|COM[EÉ]RCIO|IND[ÚU]STRIA)/i;
  if(idx!==-1){
      let candidates=[];
      for(const off of [-3,-2,-1,1,2,3]){
          const i=idx+off;
          if(i>=0 && i<lines.length){
              const ln=lines[i];
              if(isValid(ln)) candidates.push(ln);
          }
      }
      let best = candidates.find(l=>compKey.test(l));
      if(!best) best = candidates.sort((a,b)=>b.length-a.length)[0];
      if(best) return best.replace(/\s+/g," ").trim();
  }

  const p = text.indexOf(digits);
  if(p!==-1){
     const slice=text.slice(Math.max(0,p-250),p+120);
     const m=slice.match(/([^\n\r]{8,}?(?:LTDA\.?|EPP|MEI|EIRELI|S\.?A|SERVI[ÇC]OS|COM[EÉ]RCIO))/i);
     if(m && isValid(m[1])) return m[1].replace(/\s+/g," ").trim();
  }
  return "";
}
function getDescricaoServico(text){
  const discriPart = text.split(/DISCRIMINA[ÇC]ÃO[^:\n]*:/i)[1];
  if(discriPart){
     const linha = discriPart.split(/[\r\n]+/).map(l=>l.trim()).find(l=>l && !/valor unit/i.test(l));
     if(linha){
        let desc = linha.replace(/valor.*$/i,'').trim();
        const placaMatch = desc.match(/\b([A-Z]{3}[-\s]?[0-9][A-Z0-9][0-9]{2}|[A-Z]{3}-?[0-9]{4})\b/i);
        desc = desc.replace(/\s+/g,' ').replace(/[^\w\s\-.,]/g,'').toLowerCase();
        if(placaMatch){
           return placaMatch[0].toUpperCase()+' – '+desc;
        }
        return desc;
     }
  }
  const fallback = text.match(/(SERVIÇOS? PRESTADOS?|Descrição[^:\n]*):?\s*([\s\S]{0,400})/i);
  if(fallback){
      return fallback[2].split(/[\r\n]+/)[0].trim();
  }
  return "";
}

// ======== FIM HELPERS NOVOS ========

    
    // Function to check if libraries are loaded
    function checkLibraries() {
      const status = {
        pdfjs: typeof pdfjsLib !== 'undefined',
        tesseract: typeof Tesseract !== 'undefined',
        xlsx: typeof XLSX !== 'undefined'
      };
      
      console.log('Status das bibliotecas:', status);
      
      if (!status.pdfjs) {
        console.error('PDF.js não carregado. Verifique a conexão com a internet.');
      }
      if (!status.tesseract) {
        console.error('Tesseract.js não carregado. Verifique a conexão com a internet.');
      }
      if (!status.xlsx) {
        console.error('SheetJS não carregado. Verifique a conexão com a internet.');
      }
      
      return status.pdfjs && status.tesseract && status.xlsx;
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Check libraries after a small delay
      setTimeout(() => {
        const librariesLoaded = checkLibraries();
        if (!librariesLoaded) {
          alert('Algumas bibliotecas não carregaram corretamente. Verifique sua conexão com a internet e recarregue a página.');
        }
      }, 2000);
      
      const uploadSection = document.getElementById('uploadSection');
      const fileInput = document.getElementById('fileInput');
      const exportBtn = document.getElementById('exportBtn');
      
      // Drag and drop events
      uploadSection.addEventListener('dragover', handleDragOver);
      uploadSection.addEventListener('dragleave', handleDragLeave);
      uploadSection.addEventListener('drop', handleDrop);
      
      // File input change
      fileInput.addEventListener('change', function(e) {
        handleFiles(Array.from(e.target.files));
      });
      
      // Export button
      exportBtn.addEventListener('click', exportToExcel);
    });
    
    // Drag and drop handlers
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    }
    
    function handleDragLeave(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      handleFiles(files);
    }
    
    // Main file processing function
    async function handleFiles(files) {
      if (files.length === 0) return;
      
      // Check if libraries are available before processing
      if (!checkLibraries()) {
        alert('Bibliotecas necessárias não estão disponíveis. Recarregue a página e tente novamente.');
        return;
      }
      
      totalFiles = files.length;
      processedFiles = 0;
      extractedData = [];
      
      showProgress();
      updateProgress();
      
      // Process files with max 3 concurrent operations
      const chunks = [];
      for (let i = 0; i < files.length; i += 3) {
        chunks.push(files.slice(i, i + 3));
      }
      
      for (const chunk of chunks) {
        const promises = chunk.map(file => processFile(file));
        await Promise.allSettled(promises);
      }
      
      hideProgress();
      updateResultsTable();
      showResults();
    }
    
    // Process single file
    async function processFile(file) {
      try {
        let text = '';
        
        if (file.type === 'application/pdf') {
          text = await extractTextFromPDF(file);
        } else if (file.type.startsWith('image/')) {
          text = await extractTextFromImage(file);
        } else {
          console.warn('Tipo de arquivo não suportado:', file.type);
          return;
        }
        
        // Extract data from text
        const data = extractDataFromText(text, file.name);
        
        if (data) {
          extractedData.push(data);
        }
        
        processedFiles++;
        updateProgress();
        
      } catch (error) {
        console.error('Erro ao processar arquivo:', file.name, error);
        processedFiles++;
        updateProgress();
      }
    }
    
    // Extract text from PDF
    async function extractTextFromPDF(file) {
      return new Promise(async (resolve, reject) => {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          
          let fullText = '';
          
          
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();

            // Agrupa os itens por coordenada Y para reconstruir linhas reais
            const lineBuckets = {};
            textContent.items.forEach(it=>{
              const y = Math.round(it.transform[5]);  // posição vertical
              const x = it.transform[4];              // posição horizontal
              if(!lineBuckets[y]) lineBuckets[y] = [];
              lineBuckets[y].push({x, str: it.str});
            });
            const orderedY = Object.keys(lineBuckets).map(n=>parseFloat(n)).sort((a,b)=>b-a); // topo→base
            const lines = orderedY.map(y=>{
              return lineBuckets[y].sort((a,b)=>a.x-b.x).map(t=>t.str).join(' ').trim();
            });

            const pageText = lines.join('\n');
            fullText += pageText + '\n';
          }

          
          resolve(fullText);
        } catch (error) {
          console.error('Erro ao extrair texto do PDF:', error);
          reject(error);
        }
      });
    }
    
    // Extract text from image
    async function extractTextFromImage(file) {
      return new Promise(async (resolve, reject) => {
        try {
          const worker = await Tesseract.createWorker('por');
          
          const imageUrl = URL.createObjectURL(file);
          const result = await worker.recognize(imageUrl);
          
          await worker.terminate();
          URL.revokeObjectURL(imageUrl);
          
          resolve(result.data.text);
        } catch (error) {
          console.error('Erro ao extrair texto da imagem:', error);
          reject(error);
        }
      });
    }
    
    // Extract structured data from text
    function extractDataFromText(text, filename) {
      // Skip if text is too short
      if (text.length < 50) {
        console.warn('Texto muito curto para extração:', filename);
        return null;
      }
      
      // Find all CNPJs
      const cnpjs = [...text.matchAll(regexes.cnpj)].map(match => match[0]);
      
      // Skip company CNPJ (tomador)
      const emitenteCNPJ = cnpjs.find(cnpj => {
        const digits = cnpj.replace(/[^\d]/g, '');
        return digits !== COMPANY_CNPJ.replace(/[^\d]/g, '');
      });
      
      if (!emitenteCNPJ) {
        console.warn('CNPJ do emitente não encontrado:', filename);
        return null;
      }
      
      // Extract other data
      const emitenteNome = getEmitenteName(text, emitenteCNPJ);
  if(emitenteNome) cacheEmitenteName(emitenteCNPJ, emitenteNome);
      
      // Find dates
      const dates = [...text.matchAll(regexes.date)].map(match => match[0]);
      const datesISO = [...text.matchAll(regexes.dateISO)].map(match => match[0]);
      
      let dataEmissao = '';
      if (dates.length > 0) {
        dataEmissao = dates[0];
      } else if (datesISO.length > 0) {
        const parts = datesISO[0].split('-');
        dataEmissao = `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      
            // Find document number
      const numeroDocumento = detectNumeroDocumento(text);
      // Find monetary values
      const valores = [...text.matchAll(regexes.money)].map(match => match[0]);
      let valorTotal = '';
      if (valores.length > 0) {
        // Try to find the largest value, which is likely the total
        const numericValues = valores.map(v => parseFloat(v.replace(/\./g, '').replace(',', '.')));
        const maxIndex = numericValues.indexOf(Math.max(...numericValues));
        valorTotal = valores[maxIndex];
      }
      
      // Get service description
      const descricao = detectDescricao(text);
      
      return {
        cnpj: emitenteCNPJ,
        nome: emitenteNome,
        data: dataEmissao,
        documento: numeroDocumento,
        valor: valorTotal,
        descricao: descricao,
        filename: filename
      };
    }
    
    // Update progress bar and text
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      const percentage = Math.round((processedFiles / totalFiles) * 100);
      progressFill.style.width = `${percentage}%`;
      progressText.textContent = `Processando arquivos... ${processedFiles}/${totalFiles} (${percentage}%)`;
      
      // Enable export button if data is available
      const exportBtn = document.getElementById('exportBtn');
      exportBtn.disabled = extractedData.length === 0;
    }
    
    // Show progress section
    function showProgress() {
      const progressSection = document.getElementById('progressSection');
      progressSection.style.display = 'block';
    }
    
    // Hide progress section
    function hideProgress() {
      const progressSection = document.getElementById('progressSection');
      progressSection.style.display = 'none';
    }
    
    // Show results section
    function showResults() {
      const resultsSection = document.getElementById('resultsSection');
      resultsSection.style.display = 'block';
    }
    
    // Update results table
    function updateResultsTable() {
      const tableBody = document.querySelector('#resultsTable tbody');
      tableBody.innerHTML = '';
      
      if (extractedData.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.textContent = 'Nenhum dado extraído.';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }
      
      extractedData.forEach((data, index) => {
        const row = document.createElement('tr');
        
        // CNPJ Emitente
        const cnpjCell = document.createElement('td');
        cnpjCell.textContent = data.cnpj || '';
        cnpjCell.contentEditable = 'true';
        row.appendChild(cnpjCell);
        
        // Nome Emitente
        const nomeCell = document.createElement('td');
        nomeCell.textContent = data.nome || '';
        nomeCell.contentEditable = 'true';
        row.appendChild(nomeCell);
        // se nome vazio, consulta API pública
        if (!data.nome) fillEmitenteViaAPI(data.cnpj, row);

        
        // Data Emissão
        const dataCell = document.createElement('td');
        dataCell.textContent = data.data || '';
        dataCell.contentEditable = 'true';
        row.appendChild(dataCell);
        
        // Nº Documento
        const docCell = document.createElement('td');
        docCell.textContent = data.documento || '';
        docCell.contentEditable = 'true';
        row.appendChild(docCell);
        
        // Valor Total
        const valorCell = document.createElement('td');
        valorCell.textContent = data.valor || '';
        valorCell.contentEditable = 'true';
        row.appendChild(valorCell);
        
        // Descrição
        const descCell = document.createElement('td');
        descCell.textContent = data.descricao || '';
        descCell.contentEditable = 'true';
        row.appendChild(descCell);
        
        // Ações
        const actionsCell = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.addEventListener('click', () => {
          extractedData.splice(index, 1);
          updateResultsTable();
        });
        actionsCell.appendChild(deleteBtn);
        row.appendChild(actionsCell);
        
        tableBody.appendChild(row);
      });
    }
    
    // Export to Excel
    function exportToExcel() {
      if (extractedData.length === 0) {
        alert('Não há dados para exportar.');
        return;
      }
      
      // Create worksheet
      const ws = XLSX.utils.json_to_sheet(extractedData.map(data => ({
        'CNPJ': data.cnpj || '',
        'Nome Emitente': data.nome || '',
        'Data Emissão': data.data || '',
        'Nº Documento': data.documento || '',
        'Valor Total': data.valor || '',
        'Descrição': data.descricao || '',
        'Arquivo': data.filename || ''
      })));
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Notas Fiscais');
      
      // Generate filename with date
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
      const filename = `notas_fiscais_${dateStr}.xlsx`;
      
      // Save file
      XLSX.writeFile(wb, filename);
    }
    
    // Add event listeners for table editing
    document.addEventListener('input', function(e) {
      if (e.target.contentEditable === 'true') {
        // Update data array when user edits cells
        const row = e.target.parentElement;
        const table = row.parentElement.parentElement;
        const rowIndex = Array.from(table.querySelectorAll('tbody tr')).indexOf(row);
        const cellIndex = Array.from(row.querySelectorAll('td[contenteditable="true"]')).indexOf(e.target);
        
        if (extractedData[rowIndex]) {
          const fields = ['cnpj', 'nome', 'data', 'documento', 'valor', 'descricao'];
          if (fields[cellIndex]) {
            extractedData[rowIndex][fields[cellIndex]] = e.target.textContent.trim();
          }
        }
      }
    });
    
    
// Salva correção manual no cache
document.addEventListener('blur', function(e){
  if(e.target && e.target.tagName==='TD' && e.target.parentElement){
     const headerCells = e.target.parentElement.parentElement.parentElement.querySelectorAll('th');
     const colIndex = Array.from(e.target.parentElement.children).indexOf(e.target);
     if(headerCells[colIndex] && /Nome Emitente/i.test(headerCells[colIndex].textContent)){
        const cnpj = e.target.parentElement.querySelector('td').textContent.trim();
        const nome = e.target.textContent.trim();
        if(nome) cacheEmitenteName(cnpj, nome);
     }
  }
}, true);

// Utility function to clean text
    function cleanText(text) {
      return text
        .replace(/\s+/g, ' ')
        .replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
        .trim();
    }
  </script>
<!-- Espera assíncrona para confirmar carregamento das libs locais -->
<script>
  (function waitForLibs(retries = 20){
    const ok = typeof pdfjsLib!=='undefined' && typeof Tesseract!=='undefined' && typeof XLSX!=='undefined';
    if(ok){
      console.log('Bibliotecas locais carregadas OK');
      if(typeof checkLibraries==='function') checkLibraries();
      return;
    }
    if(retries>0){
      setTimeout(()=>waitForLibs(retries-1),300);
    }else{
      console.error('Não foi possível carregar todas as bibliotecas locais.');
    }
  })();

/** Consulta nome da empresa via API pública se nome extraído estiver vazio */


async function fillEmitenteViaAPI(cnpj, rowEl){
  const digits = cnpj.replace(/[^0-9]/g,'');
  if(digits.length !== 14) return;

  const endpoints = [
    `https://publica.cnpj.ws/cnpj/${digits}`,
    `https://api-publica.speedio.com.br/buscarcnpj?cnpj=${digits}`
  ];

  let nome = '';
  for (const url of endpoints){
    try{
      const resp = await fetch(url, {mode:'cors'});
      if(!resp.ok) continue;
      const info = await resp.json();
      if(info.razao_social){
          nome = info.razao_social;
      } else if(info.NOME_EMPRESARIAL){
          nome = info.NOME_EMPRESARIAL;
      } else if(info.nome_fantasia){
          nome = info.nome_fantasia;
      }
      nome = (nome || '').trim();
      if(nome) break;
    }catch(e){
      console.warn('API CNPJ falhou para', url, e);
    }
  }
  if(!nome) return;

  // Atualiza célula
  const td = rowEl.querySelector('td:nth-child(2)');
  if(td) td.textContent = nome;

  // Sincroniza array interno
  const idx = Array.from(rowEl.parentElement.children).indexOf(rowEl);
  if(extractedData[idx]) extractedData[idx].nome = nome;
  cacheEmitenteName(cnpj, nome);
}
/* tudo ok */
</script>
</body>
</html>
