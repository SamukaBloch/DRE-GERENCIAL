<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>DRE Gerencial</title>
  <!-- Estilos e Bibliotecas -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Plugin for Data Labels -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- jsPDF for PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    /* Seu CSS permanece inalterado */
    :root {
      --primary: #2c3e50;
      --secondary: #34495e;
      --accent: #3498db;
      --success: #2ecc71;
      --warning: #f1c40f;
      --danger: #e74c3c;
      --info: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --background: #f4f6f9;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: var(--background);
      overflow-x: hidden;
    }
    /* Navbar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar h1 {
      font-size: 1.5rem;
    }
    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 60px;
      left: 0;
      width: 80px;
      height: calc(100% - 60px);
      background-color: var(--primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      transition: width 0.3s;
    }
    .sidebar:hover {
      width: 200px;
    }
    .sidebar ul {
      list-style: none;
      width: 100%;
    }
    .sidebar li {
      width: 100%;
      padding: 15px 20px;
      color: white;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .sidebar li:hover, .sidebar li.active {
      background-color: var(--accent);
    }
    .sidebar li i {
      font-size: 1.2rem;
      margin-right: 10px;
    }
    .sidebar li span {
      display: none;
      white-space: nowrap;
    }
    .sidebar:hover li span {
      display: inline;
    }
    /* Main Container */
    .container {
      margin-top: 60px;
      margin-left: 80px;
      padding: 20px;
      transition: margin-left 0.3s;
    }
    .sidebar:hover + .container {
      margin-left: 200px;
    }
    /* Panels */
    .panel {
      display: none;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .panel.active-panel {
      display: block;
    }
    /* Cards */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      transition: transform 0.3s;
      position: relative;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card-icon {
      font-size: 2rem;
      margin-right: 15px;
    }
    .card-content h3 {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    .card-content .value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .percentage {
      display: flex;
      align-items: center;
      margin-top: 5px;
      font-size: 0.9rem;
    }
    .percentage i {
      margin-right: 5px;
    }
    /* Buttons */
    .btn {
      padding: 10px 20px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-top: 10px;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    .btn-delete {
      background-color: var(--danger);
    }
    .btn-delete:hover {
      background-color: #c0392b;
    }
    .btn-select {
      background-color: var(--success);
    }
    .btn-select:hover {
      background-color: #27ae60;
    }
    /* Forms */
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    .file-upload {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    .file-upload:hover {
      border-color: var(--accent);
    }
    /* Tables */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .table th, .table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    .table th {
      background-color: var(--light);
    }
    /* Charts */
    .chart-container {
      background-color: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .chart-small {
      height: 300px;
      position: relative;
    }
    .chart-small canvas {
      max-height: 100%;
    }
    /* Notifications */
    .notifications {
      margin-top: 20px;
    }
    .notification-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      transition: background-color 0.3s;
    }
    .notification-item:hover {
      background-color: var(--light);
    }
    .notification-item i {
      font-size: 1.5rem;
      margin-right: 10px;
      color: var(--warning);
    }
    /* Footer */
    .footer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 10px;
      background-color: var(--primary);
      color: white;
      font-size: 0.9rem;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      .sidebar:hover {
        width: 150px;
      }
      .sidebar li span {
        display: none;
      }
      .sidebar:hover li span {
        display: inline;
      }
      .container {
        margin-left: 60px;
      }
      .sidebar:hover + .container {
        margin-left: 150px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <h1>DRE Gerencial</h1>
  </nav>
  
  <!-- Sidebar -->
  <div class="sidebar">
    <ul>
      <li class="active" onclick="showPanel('overview', this)">
        <i class="fas fa-tachometer-alt"></i><span>Visão Geral</span>
      </li>
      <li onclick="showPanel('revenue', this)">
        <i class="fas fa-chart-line"></i><span>Receitas</span>
      </li>
      <li onclick="showPanel('costs', this)">
        <i class="fas fa-coins"></i><span>Custos</span>
      </li>
      <li onclick="showPanel('expenses', this)">
        <i class="fas fa-money-bill-wave"></i><span>Despesas</span>
      </li>
      <li onclick="showPanel('reports', this)">
        <i class="fas fa-file-alt"></i><span>Relatórios</span>
      </li>
    </ul>
  </div>
  
  <!-- Main Container -->
  <div class="container">
    <!-- Painel Visão Geral -->
    <div id="overview" class="panel active-panel">
      <h2>Visão Geral</h2>
      
      <!-- Display Selected Month -->
      <div id="selected-month-display" style="text-align: center; margin-bottom: 10px; font-size: 1.2rem; font-weight: bold;">
        Mês Selecionado: Todos os Meses
      </div>
      
      <!-- Cartões de Resumo -->
      <div class="grid">
        <!-- Receita Bruta -->
        <div class="card" style="background-color: #3498db;">
          <div class="card-icon">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="card-content">
            <h3>Receita Bruta</h3>
            <p class="value" id="gross-revenue">R$ 0,00</p>
          </div>
        </div>
        
        <!-- Lucro Operacional -->
        <div class="card" style="background-color: #2ecc71;">
          <div class="card-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
          <div class="card-content">
            <h3>Lucro Operacional</h3>
            <p class="value" id="operating-profit">R$ 0,00</p>
          </div>
        </div>
        
        <!-- Lucro Líquido -->
        <div class="card" style="background-color: #e74c3c;">
          <div class="card-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="card-content">
            <h3>Lucro Líquido</h3>
            <p class="value" id="net-profit">R$ 0,00</p>
          </div>
        </div>
      </div>
      
      <!-- Gráficos -->
      <div class="grid">
        <!-- Gráfico de Linhas -->
        <div class="chart-container chart-small">
          <canvas id="lineChart"></canvas>
        </div>
        
        <!-- Gráfico de Barras -->
        <div class="chart-container chart-small">
          <canvas id="barChart"></canvas>
        </div>
        
        <!-- Gráfico de Pizza -->
        <div class="chart-container chart-small">
          <!-- Gráfico de Pizza sem título -->
          <canvas id="pieChart"></canvas>
        </div>
      </div>
      
      <!-- Linha do Tempo / Calendário (Simplificado como tabela) -->
      <div class="chart-container">
        <h3>Histórico de Receitas e Despesas</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Mês/Ano</th>
              <th>Receita Bruta</th>
              <th>Custos</th>
              <th>Despesas</th>
              <th>Selecionar</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <!-- Linhas serão inseridas via JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Notificações -->
      <div class="notifications">
        <h3>Notificações</h3>
        <div id="notifications-list">
          <!-- Notificações serão adicionadas aqui -->
        </div>
      </div>
    </div>
    
    <!-- Painel Receitas -->
    <div id="revenue" class="panel">
      <h2>Cadastro de Receitas</h2>
      <form id="revenue-form">
        <div class="form-group">
          <label>Tipo de Receita</label>
          <select class="form-control" name="tipo" required>
            <option value="Vendas Matriz/Curitiba">Vendas Matriz/Curitiba</option>
            <option value="Vendas Maringá">Vendas Maringá</option>
            <option value="Vendas Prudente">Vendas Prudente</option>
            <option value="Receitas Financeiras">Receitas Financeiras</option>
            <option value="Outras Receitas">Outras Receitas</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" name="valor" class="form-control" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Descrição</label>
          <textarea class="form-control" name="descricao" required></textarea>
        </div>
        <div class="form-group">
          <label>Mês/Ano</label>
          <input type="month" name="mesAno" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Arquivo Comprobatório</label>
          <div class="file-upload" onclick="document.getElementById('revenue-file').click()">
            <input type="file" id="revenue-file" name="files" accept=".xlsx,.xls,.pdf,.doc,.docx" style="display:none;" multiple>
            <p>Arraste um arquivo ou clique para selecionar</p>
          </div>
          <div id="revenue-file-list"></div>
        </div>
        <button type="submit" class="btn">Salvar</button>
      </form>
      
      <!-- Busca e Histórico -->
      <div class="form-group">
        <label>Pesquisar Registros</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="revenue-search" class="form-control" placeholder="Pesquisar por tipo, arquivo ou descrição...">
          <input type="month" id="revenue-search-month" class="form-control">
          <button class="btn" onclick="searchRevenue()">Buscar</button>
        </div>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Valor (R$)</th>
            <th>Descrição</th>
            <th>Mês/Ano</th>
            <th>Arquivos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="revenue-history">
          <!-- Registros serão inseridos via JavaScript -->
        </tbody>
      </table>
    </div>
    
    <!-- Painel Custos -->
    <div id="costs" class="panel">
      <h2>Cadastro de Custos</h2>
      <form id="costs-form">
        <div class="form-group">
          <label>Tipo de Custo</label>
          <select class="form-control" name="tipo" required>
            <option value="Matéria Prima">Matéria Prima</option>
            <option value="Mão de Obra">Mão de Obra</option>
            <option value="Mão de Obra Terceirizada">Mão de Obra Terceirizada</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" name="valor" class="form-control" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Descrição</label>
          <textarea class="form-control" name="descricao" required></textarea>
        </div>
        <div class="form-group">
          <label>Mês/Ano</label>
          <input type="month" name="mesAno" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Arquivo Comprobatório</label>
          <div class="file-upload" onclick="document.getElementById('costs-file').click()">
            <input type="file" id="costs-file" name="files" accept=".xlsx,.xls,.pdf,.doc,.docx" style="display:none;" multiple>
            <p>Arraste um arquivo ou clique para selecionar</p>
          </div>
          <div id="costs-file-list"></div>
        </div>
        <button type="submit" class="btn">Salvar</button>
      </form>
      
      <!-- Busca e Histórico -->
      <div class="form-group">
        <label>Pesquisar Registros</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="costs-search" class="form-control" placeholder="Pesquisar por tipo, arquivo ou descrição...">
          <input type="month" id="costs-search-month" class="form-control">
          <button class="btn" onclick="searchCosts()">Buscar</button>
        </div>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Valor (R$)</th>
            <th>Descrição</th>
            <th>Mês/Ano</th>
            <th>Arquivos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="costs-history">
          <!-- Registros serão inseridos via JavaScript -->
        </tbody>
      </table>
    </div>
    
    <!-- Painel Despesas -->
    <div id="expenses" class="panel">
      <h2>Cadastro de Despesas</h2>
      <form id="expenses-form">
        <div class="form-group">
          <label>Tipo de Despesa</label>
          <select class="form-control" name="tipo" required>
            <option value="Administrativas">Administrativas</option>
            <option value="Comerciais">Comerciais</option>
            <option value="Financeiras">Financeiras</option>
            <option value="Caminhões">Caminhões</option>
            <option value="Combustível">Combustível</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" name="valor" class="form-control" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Descrição</label>
          <textarea class="form-control" name="descricao" required></textarea>
        </div>
        <div class="form-group">
          <label>Mês/Ano</label>
          <input type="month" name="mesAno" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Arquivo Comprobatório</label>
          <div class="file-upload" onclick="document.getElementById('expenses-file').click()">
            <input type="file" id="expenses-file" name="files" accept=".xlsx,.xls,.pdf,.doc,.docx" style="display:none;" multiple>
            <p>Arraste um arquivo ou clique para selecionar</p>
          </div>
          <div id="expenses-file-list"></div>
        </div>
        <button type="submit" class="btn">Salvar</button>
      </form>
      
      <!-- Busca e Histórico -->
      <div class="form-group">
        <label>Pesquisar Registros</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="expenses-search" class="form-control" placeholder="Pesquisar por tipo, arquivo ou descrição...">
          <input type="month" id="expenses-search-month" class="form-control">
          <button class="btn" onclick="searchExpenses()">Buscar</button>
        </div>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Valor (R$)</th>
            <th>Descrição</th>
            <th>Mês/Ano</th>
            <th>Arquivos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="expenses-history">
          <!-- Registros serão inseridos via JavaScript -->
        </tbody>
      </table>
    </div>
    
    <!-- Painel Relatórios -->
    <div id="reports" class="panel">
      <h2>Relatórios</h2>
      <form id="report-form">
        <div class="form-group">
          <label>Tipo de Relatório</label>
          <select class="form-control" id="report-type" required>
            <option value="dre">DRE</option>
          </select>
        </div>
        <div class="form-group">
          <label>Mês/Ano Inicial</label>
          <input type="month" class="form-control" id="report-start" required>
        </div>
        <div class="form-group">
          <label>Mês/Ano Final</label>
          <input type="month" class="form-control" id="report-end" required>
        </div>
        <button type="submit" class="btn">Gerar Relatório</button>
      </form>
      
      <!-- Output do Relatório -->
      <div id="report-output" class="chart-container" style="display: none;">
        <h3>Relatório Gerado</h3>
        <div id="report-content"></div>
        <button class="btn" onclick="exportToPDF()">Exportar PDF</button>
        <button class="btn" onclick="exportToExcel()">Exportar Excel</button>
      </div>
    </div>
  </div>
  
  <!-- Footer -->
  <div class="footer">
    Aplicativo de Samuel Bloch
  </div>
  
  <!-- Scripts -->
  <script>
    // Definir o endereço do servidor (localhost, já que o servidor é local)
    const serverAddress = 'http://srvdc1:3000';
  
    // Variáveis para edição
    let editRevenueId = null;
    let editCostId = null;
    let editExpenseId = null;
    // Variável para armazenar o mês selecionado
    let selectedMonth = null;
  
    // Inicialização dos Gráficos
    let lineChart, barChart, pieChart;
    function initializeCharts() {
      // Gráfico de Linhas
      const ctxLine = document.getElementById('lineChart').getContext('2d');
      lineChart = new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Receita Bruta',
              data: [],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.2)',
              fill: true,
              tension: 0.1
            },
            {
              label: 'Lucro Líquido',
              data: [],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.2)',
              fill: true,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Evolução Financeira' }
          }
        }
      });
      
      // Gráfico de Barras
      const ctxBar = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Despesas',
              data: [],
              backgroundColor: '#e74c3c'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Despesas por Mês' }
          }
        }
      });
      
      // Gráfico de Pizza
      const ctxPie = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
          labels: ['Administrativas', 'Comerciais', 'Financeiras', 'Caminhões', 'Combustível'],
          datasets: [{
            data: [],
            backgroundColor: ['#e74c3c', '#f1c40f', '#8e44ad', '#2ecc71', '#3498db']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              formatter: (value) => 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2}),
              color: '#fff',
              font: {
                weight: 'bold',
                size: 12
              },
              anchor: 'center',
              align: 'center',
              offset: 0,
              rotation: 0
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }
  
    // Função para exibir o painel selecionado
    function showPanel(panelId, clickedElement) {
      document.querySelectorAll('.sidebar li').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelectorAll('.panel').forEach(panel => {
        panel.classList.remove('active-panel');
      });
      clickedElement.classList.add('active');
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.classList.add('active-panel');
      } else {
        console.error(`Painel com ID '${panelId}' não encontrado.`);
      }
    }
  
    // Função para formatar a data no formato MM/YYYY
    function formatDate(dateString) {
      const [year, month] = dateString.split('-');
      return `${month}/${year}`;
    }
  
    // Função para atualizar os gráficos
    async function updateCharts() {
      try {
        const response = await fetch(`${serverAddress}/overview`);
        const data = await response.json();
        if (!data) return;
        const { months, revenueData, netProfitData, expenseData, costData } = data;
  
        // Atualizar Gráfico de Linhas
        lineChart.data.labels = months.map(formatDate);
        lineChart.data.datasets[0].data = revenueData;
        lineChart.data.datasets[1].data = netProfitData;
        lineChart.update();
  
        // Atualizar Gráfico de Barras
        barChart.data.labels = months.map(formatDate);
        barChart.data.datasets[0].data = expenseData;
        barChart.update();
  
        // Atualizar tabela de histórico
        updateHistoryTable(months, revenueData, costData, expenseData);
  
        // Atualizar cartões com dados do mês selecionado ou geral
        updateCardsAndPieChart();
      } catch (error) {
        console.error('Erro ao atualizar gráficos:', error);
      }
    }
  
    // Funções para atualizar a tabela de histórico
    function updateHistoryTable(months, revenueData, costData, expenseData) {
      const historyBody = document.getElementById('history-table-body');
      historyBody.innerHTML = '';
      for (let i = 0; i < months.length; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(months[i])}</td>
          <td>R$ ${revenueData[i].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td>R$ ${costData[i].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td>R$ ${expenseData[i].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
          <td><button class="btn btn-select" onclick="selectMonth('${months[i]}')">Selecionar</button></td>
        `;
        historyBody.appendChild(tr);
      }
    }
  
    // Função para selecionar o mês
    function selectMonth(month) {
      selectedMonth = month;
      updateCardsAndPieChart();
    }
  
    // Função para atualizar os cartões e o gráfico de pizza com base no mês selecionado
    async function updateCardsAndPieChart() {
      try {
        const response = await fetch(`${serverAddress}/summary${selectedMonth ? '?month=' + selectedMonth : ''}`);
        const data = await response.json();
        if (!data) return;
  
        const { totalRevenue, totalCost, totalExpenses, lucroOperacional, lucroLiquido, expenseSums } = data;
  
        if (selectedMonth) {
          document.getElementById('selected-month-display').innerText = `Mês Selecionado: ${formatDate(selectedMonth)}`;
        } else {
          document.getElementById('selected-month-display').innerText = 'Mês Selecionado: Todos os Meses';
        }
  
        document.getElementById('gross-revenue').innerText = 'R$ ' +
          totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        document.getElementById('operating-profit').innerText = 'R$ ' +
          lucroOperacional.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        document.getElementById('net-profit').innerText = 'R$ ' +
          lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2});
  
        // Atualizar gráfico de pizza
        pieChart.data.datasets[0].data = expenseSums;
        pieChart.update();
  
      } catch (error) {
        console.error('Erro ao atualizar cartões e gráfico de pizza:', error);
      }
    }
  
    // Função para carregar dados do servidor e atualizar tabelas
    async function loadDataFromServer() {
      await Promise.all([
        updateRevenueTable(),
        updateCostTable(),
        updateExpenseTable()
      ]);
      updateCharts();
    }
  
    // Função para adicionar arquivos selecionados à lista
    function handleFileSelection(event, listId) {
      const fileList = event.target.files;
      const listElement = document.getElementById(listId);
      listElement.innerHTML = '';
      for (let i = 0; i < fileList.length; i++) {
        const p = document.createElement('p');
        p.innerText = fileList[i].name;
        listElement.appendChild(p);
      }
    }
  
    document.getElementById('revenue-file').addEventListener('change', (e) => {
      handleFileSelection(e, 'revenue-file-list');
    });
    document.getElementById('costs-file').addEventListener('change', (e) => {
      handleFileSelection(e, 'costs-file-list');
    });
    document.getElementById('expenses-file').addEventListener('change', (e) => {
      handleFileSelection(e, 'expenses-file-list');
    });
  
    // Inicializar tudo quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      initializeCharts();
      loadDataFromServer();
  
      // Formulário de Receitas
      const revenueForm = document.getElementById('revenue-form');
      revenueForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
  
        // Upload de arquivos
        let arquivos = [];
        const files = document.getElementById('revenue-file').files;
        if (files.length > 0) {
          const uploadResponse = await uploadFiles(files);
          arquivos = uploadResponse.files;
        }
  
        const data = {
          tipo: formData.get('tipo'),
          valor: parseFloat(formData.get('valor')),
          descricao: formData.get('descricao'),
          mesAno: formData.get('mesAno'),
          arquivos
        };
  
        let url = `${serverAddress}/revenues`;
        let method = 'POST';
        if (editRevenueId !== null) {
          url += `/${editRevenueId}`;
          method = 'PUT';
        }
  
        try {
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (response.ok) {
            alert('Receita cadastrada com sucesso!');
            this.reset();
            document.getElementById('revenue-file-list').innerHTML = '';
            editRevenueId = null;
            await updateRevenueTable();
            updateCharts();
          } else {
            alert('Erro ao cadastrar receita.');
          }
        } catch (error) {
          console.error('Erro ao cadastrar receita:', error);
        }
      });
  
      // Formulário de Custos
      const costsForm = document.getElementById('costs-form');
      costsForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
  
        // Upload de arquivos
        let arquivos = [];
        const files = document.getElementById('costs-file').files;
        if (files.length > 0) {
          const uploadResponse = await uploadFiles(files);
          arquivos = uploadResponse.files;
        }
  
        const data = {
          tipo: formData.get('tipo'),
          valor: parseFloat(formData.get('valor')),
          descricao: formData.get('descricao'),
          mesAno: formData.get('mesAno'),
          arquivos
        };
  
        let url = `${serverAddress}/costs`;
        let method = 'POST';
        if (editCostId !== null) {
          url += `/${editCostId}`;
          method = 'PUT';
        }
  
        try {
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (response.ok) {
            alert('Custo cadastrado com sucesso!');
            this.reset();
            document.getElementById('costs-file-list').innerHTML = '';
            editCostId = null;
            await updateCostTable();
            updateCharts();
          } else {
            alert('Erro ao cadastrar custo.');
          }
        } catch (error) {
          console.error('Erro ao cadastrar custo:', error);
        }
      });
  
      // Formulário de Despesas
      const expensesForm = document.getElementById('expenses-form');
      expensesForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
  
        // Upload de arquivos
        let arquivos = [];
        const files = document.getElementById('expenses-file').files;
        if (files.length > 0) {
          const uploadResponse = await uploadFiles(files);
          arquivos = uploadResponse.files;
        }
  
        const data = {
          tipo: formData.get('tipo'),
          valor: parseFloat(formData.get('valor')),
          descricao: formData.get('descricao'),
          mesAno: formData.get('mesAno'),
          arquivos
        };
  
        let url = `${serverAddress}/expenses`;
        let method = 'POST';
        if (editExpenseId !== null) {
          url += `/${editExpenseId}`;
          method = 'PUT';
        }
  
        try {
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (response.ok) {
            alert('Despesa cadastrada com sucesso!');
            this.reset();
            document.getElementById('expenses-file-list').innerHTML = '';
            editExpenseId = null;
            await updateExpenseTable();
            updateCharts();
          } else {
            alert('Erro ao cadastrar despesa.');
          }
        } catch (error) {
          console.error('Erro ao cadastrar despesa:', error);
        }
      });
  
      // Evento para gerar relatório
      document.getElementById('report-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generateReport();
      });
    });
  
    // Função para fazer upload de arquivos
    async function uploadFiles(files) {
      const formData = new FormData();
      for (let file of files) {
        formData.append('files', file);
      }
      try {
        const response = await fetch(`${serverAddress}/upload`, {
          method: 'POST',
          body: formData
        });
        return await response.json();
      } catch (error) {
        console.error('Erro ao fazer upload de arquivos:', error);
        return { files: [] };
      }
    }
  
    // Funções para atualizar as tabelas
    async function updateRevenueTable() {
      try {
        const response = await fetch(`${serverAddress}/revenues`);
        const revenues = await response.json();
        const history = document.getElementById('revenue-history');
        if (!history) return;
        history.innerHTML = '';
        revenues.forEach((entry) => addRevenueToTable(entry));
      } catch (error) {
        console.error('Erro ao atualizar tabela de receitas:', error);
      }
    }
  
    async function updateCostTable() {
      try {
        const response = await fetch(`${serverAddress}/costs`);
        const costs = await response.json();
        const history = document.getElementById('costs-history');
        if (!history) return;
        history.innerHTML = '';
        costs.forEach((entry) => addCostToTable(entry));
      } catch (error) {
        console.error('Erro ao atualizar tabela de custos:', error);
      }
    }
  
    async function updateExpenseTable() {
      try {
        const response = await fetch(`${serverAddress}/expenses`);
        const expenses = await response.json();
        const history = document.getElementById('expenses-history');
        if (!history) return;
        history.innerHTML = '';
        expenses.forEach((entry) => addExpenseToTable(entry));
      } catch (error) {
        console.error('Erro ao atualizar tabela de despesas:', error);
      }
    }
  
    // Funções para adicionar dados às tabelas
    function addRevenueToTable(entry) {
      const history = document.getElementById('revenue-history');
      if (!history) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.tipo}</td>
        <td>R$ ${entry.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${entry.descricao}</td>
        <td data-mes-ano="${entry.mesAno}">${formatDate(entry.mesAno)}</td>
        <td>${entry.arquivos.map(file => `<a href="${serverAddress}${file.url}" target="_blank">${file.name}</a>`).join(', ')}</td>
        <td>
          <button class="btn" onclick="editRevenue(${entry.id})">Editar</button>
          <button class="btn btn-delete" onclick="deleteRevenue(${entry.id})">Excluir</button>
        </td>
      `;
      history.appendChild(tr);
    }
  
    function addCostToTable(entry) {
      const history = document.getElementById('costs-history');
      if (!history) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.tipo}</td>
        <td>R$ ${entry.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${entry.descricao}</td>
        <td data-mes-ano="${entry.mesAno}">${formatDate(entry.mesAno)}</td>
        <td>${entry.arquivos.map(file => `<a href="${serverAddress}${file.url}" target="_blank">${file.name}</a>`).join(', ')}</td>
        <td>
          <button class="btn" onclick="editCost(${entry.id})">Editar</button>
          <button class="btn btn-delete" onclick="deleteCost(${entry.id})">Excluir</button>
        </td>
      `;
      history.appendChild(tr);
    }
  
    function addExpenseToTable(entry) {
      const history = document.getElementById('expenses-history');
      if (!history) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.tipo}</td>
        <td>R$ ${entry.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
        <td>${entry.descricao}</td>
        <td data-mes-ano="${entry.mesAno}">${formatDate(entry.mesAno)}</td>
        <td>${entry.arquivos.map(file => `<a href="${serverAddress}${file.url}" target="_blank">${file.name}</a>`).join(', ')}</td>
        <td>
          <button class="btn" onclick="editExpense(${entry.id})">Editar</button>
          <button class="btn btn-delete" onclick="deleteExpense(${entry.id})">Excluir</button>
        </td>
      `;
      history.appendChild(tr);
    }
  
    // Funções para editar registros
    async function editRevenue(id) {
      try {
        const response = await fetch(`${serverAddress}/revenues/${id}`);
        const entry = await response.json();
        const revenueForm = document.getElementById('revenue-form');
        revenueForm.querySelector('select').value = entry.tipo;
        revenueForm.querySelector('input[name="valor"]').value = entry.valor;
        revenueForm.querySelector('textarea').value = entry.descricao;
        revenueForm.querySelector('input[type="month"]').value = entry.mesAno;
        editRevenueId = id;
      } catch (error) {
        console.error('Erro ao editar receita:', error);
      }
    }
  
    async function editCost(id) {
      try {
        const response = await fetch(`${serverAddress}/costs/${id}`);
        const entry = await response.json();
        const costsForm = document.getElementById('costs-form');
        costsForm.querySelector('select').value = entry.tipo;
        costsForm.querySelector('input[name="valor"]').value = entry.valor;
        costsForm.querySelector('textarea').value = entry.descricao;
        costsForm.querySelector('input[type="month"]').value = entry.mesAno;
        editCostId = id;
      } catch (error) {
        console.error('Erro ao editar custo:', error);
      }
    }
  
    async function editExpense(id) {
      try {
        const response = await fetch(`${serverAddress}/expenses/${id}`);
        const entry = await response.json();
        const expensesForm = document.getElementById('expenses-form');
        expensesForm.querySelector('select').value = entry.tipo;
        expensesForm.querySelector('input[name="valor"]').value = entry.valor;
        expensesForm.querySelector('textarea').value = entry.descricao;
        expensesForm.querySelector('input[type="month"]').value = entry.mesAno;
        editExpenseId = id;
      } catch (error) {
        console.error('Erro ao editar despesa:', error);
      }
    }
  
    // Funções para deletar registros
    async function deleteRevenue(id) {
      if (confirm('Tem certeza que deseja excluir este registro?')) {
        try {
          const response = await fetch(`${serverAddress}/revenues/${id}`, { method: 'DELETE' });
          if (response.ok) {
            await updateRevenueTable();
            updateCharts();
          } else {
            alert('Erro ao excluir receita.');
          }
        } catch (error) {
          console.error('Erro ao excluir receita:', error);
        }
      }
    }
  
    async function deleteCost(id) {
      if (confirm('Tem certeza que deseja excluir este registro?')) {
        try {
          const response = await fetch(`${serverAddress}/costs/${id}`, { method: 'DELETE' });
          if (response.ok) {
            await updateCostTable();
            updateCharts();
          } else {
            alert('Erro ao excluir custo.');
          }
        } catch (error) {
          console.error('Erro ao excluir custo:', error);
        }
      }
    }
  
    async function deleteExpense(id) {
      if (confirm('Tem certeza que deseja excluir este registro?')) {
        try {
          const response = await fetch(`${serverAddress}/expenses/${id}`, { method: 'DELETE' });
          if (response.ok) {
            await updateExpenseTable();
            updateCharts();
          } else {
            alert('Erro ao excluir despesa.');
          }
        } catch (error) {
          console.error('Erro ao excluir despesa:', error);
        }
      }
    }
  
    // Funções de Busca
    function searchRevenue() {
      const searchTerm = document.getElementById('revenue-search').value.toLowerCase();
      const searchMonth = document.getElementById('revenue-search-month').value;
      const rows = document.querySelectorAll('#revenue-history tr');
      rows.forEach(row => {
        const tipo = row.cells[0].innerText.toLowerCase();
        const descricao = row.cells[2].innerText.toLowerCase();
        const mesAno = row.cells[3].dataset.mesAno;
        const arquivos = row.cells[4].innerText.toLowerCase();
        let matchSearchTerm = tipo.includes(searchTerm) || arquivos.includes(searchTerm) || descricao.includes(searchTerm);
        let matchMonth = !searchMonth || mesAno === searchMonth;
        if (matchSearchTerm && matchMonth) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
  
    function searchCosts() {
      const searchTerm = document.getElementById('costs-search').value.toLowerCase();
      const searchMonth = document.getElementById('costs-search-month').value;
      const rows = document.querySelectorAll('#costs-history tr');
      rows.forEach(row => {
        const tipo = row.cells[0].innerText.toLowerCase();
        const descricao = row.cells[2].innerText.toLowerCase();
        const mesAno = row.cells[3].dataset.mesAno;
        const arquivos = row.cells[4].innerText.toLowerCase();
        let matchSearchTerm = tipo.includes(searchTerm) || arquivos.includes(searchTerm) || descricao.includes(searchTerm);
        let matchMonth = !searchMonth || mesAno === searchMonth;
        if (matchSearchTerm && matchMonth) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
  
    function searchExpenses() {
      const searchTerm = document.getElementById('expenses-search').value.toLowerCase();
      const searchMonth = document.getElementById('expenses-search-month').value;
      const rows = document.querySelectorAll('#expenses-history tr');
      rows.forEach(row => {
        const tipo = row.cells[0].innerText.toLowerCase();
        const descricao = row.cells[2].innerText.toLowerCase();
        const mesAno = row.cells[3].dataset.mesAno;
        const arquivos = row.cells[4].innerText.toLowerCase();
        let matchSearchTerm = tipo.includes(searchTerm) || arquivos.includes(searchTerm) || descricao.includes(searchTerm);
        let matchMonth = !searchMonth || mesAno === searchMonth;
        if (matchSearchTerm && matchMonth) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
  
    // Função para gerar o relatório DRE
    async function generateReport() {
      const reportType = document.getElementById('report-type').value;
      const reportStart = document.getElementById('report-start').value;
      const reportEnd = document.getElementById('report-end').value;
      if (reportType === 'dre') {
        generateDREReport(reportStart, reportEnd);
      } else {
        alert('Tipo de relatório não suportado no momento.');
      }
    }
  
    async function generateDREReport(startDate, endDate) {
      try {
        const response = await fetch(`${serverAddress}/dre-report?startDate=${startDate}&endDate=${endDate}`);
        const reportData = await response.json();
  
        const reportContent = `
          <h3>Demonstração do Resultado do Exercício (DRE)</h3>
          <p>Período: ${formatDate(startDate)} a ${formatDate(endDate)}</p>
          <table class="table">
            <tr>
              <th>Descrição</th>
              <th>Valor (R$)</th>
            </tr>
            <tr>
              <td>Receita Bruta de Vendas</td>
              <td>${reportData.totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>(-) Custos das Mercadorias Vendidas</td>
              <td>${reportData.totalCost.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>= Lucro Bruto</td>
              <td>${reportData.lucroBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>(-) Despesas Operacionais</td>
              <td>${reportData.totalExpenses.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>= Lucro Operacional</td>
              <td>${reportData.lucroOperacional.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>= Lucro Antes dos Tributos</td>
              <td>${reportData.lucroAntesTributos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>(-) IRPJ</td>
              <td>${reportData.irpj.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>(-) CSLL</td>
              <td>${reportData.csll.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
            <tr>
              <td>= Lucro Líquido do Exercício</td>
              <td>${reportData.lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>
          </table>
        `;
        const reportOutput = document.getElementById('report-output');
        reportOutput.style.display = 'block';
        document.getElementById('report-content').innerHTML = reportContent;
      } catch (error) {
        console.error('Erro ao gerar relatório:', error);
      }
    }
  
    // Função para exportar o relatório para PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.html(document.getElementById('report-content'), {
        callback: function (doc) {
          doc.save("dre_report.pdf");
        },
        x: 10,
        y: 10,
        width: 180,
        windowWidth: 650
      });
    }
  
    // Função para exportar o relatório para Excel
    function exportToExcel() {
      const table = document.querySelector('#report-content table');
      const wb = XLSX.utils.table_to_book(table, { sheet: "DRE" });
      XLSX.writeFile(wb, "dre_report.xlsx");
    }
  </script>
</body>
</html>
