<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>DRE Gerencial</title>
  <!-- Estilos e Bibliotecas -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #34495e;
      --accent: #3498db;
      --success: #2ecc71;
      --warning: #f1c40f;
      --danger: #e74c3c;
      --info: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --background: #f4f6f9;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--background);
      overflow-x: hidden;
    }
    
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .navbar h1 {
      font-size: 1.5rem;
    }
    
    .sidebar {
      position: fixed;
      top: 60px;
      left: 0;
      width: 80px;
      height: calc(100% - 60px);
      background-color: var(--primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      transition: width 0.3s;
    }
    
    .sidebar:hover {
      width: 200px;
    }
    
    .sidebar ul {
      list-style: none;
      width: 100%;
    }
    
    .sidebar li {
      width: 100%;
      padding: 15px 20px;
      color: white;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .sidebar li:hover, 
    .sidebar li.active {
      background-color: var(--accent);
    }
    
    .sidebar li i {
      font-size: 1.2rem;
      margin-right: 10px;
    }
    
    .sidebar li span {
      display: none;
      white-space: nowrap;
    }
    
    .sidebar:hover li span {
      display: inline;
    }
    
    .container {
      margin-top: 60px;
      margin-left: 80px;
      padding: 20px;
      transition: margin-left 0.3s;
    }
    
    .sidebar:hover + .container {
      margin-left: 200px;
    }
    
    .panel {
      display: none;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .panel.active-panel {
      display: block;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      transition: transform 0.3s;
      position: relative;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-icon {
      font-size: 2rem;
      margin-right: 15px;
    }
    
    .card-content h3 {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    
    .card-content .value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .percentage {
      display: flex;
      align-items: center;
      margin-top: 5px;
      font-size: 0.9rem;
    }
    
    .percentage i {
      margin-right: 5px;
    }
    
    .btn {
      padding: 10px 20px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-top: 10px;
    }
    
    .btn:hover {
      background-color: #2980b9;
    }
    
    .btn-delete {
      background-color: var(--danger);
    }
    
    .btn-delete:hover {
      background-color: #c0392b;
    }
    
    .btn-select {
      background-color: var(--success);
    }
    
    .btn-select:hover {
      background-color: #27ae60;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    
    .file-upload {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    
    .file-upload:hover {
      border-color: var(--accent);
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .table th,
    .table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    
    .table th {
      background-color: var(--light);
    }
    
    .chart-container {
      background-color: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .chart-small {
      height: 300px;
      position: relative;
    }
    
    .chart-small canvas {
      max-height: 100%;
    }
    
    .notifications {
      margin-top: 20px;
    }
    
    .notification-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      transition: background-color 0.3s;
    }
    
    .notification-item:hover {
      background-color: var(--light);
    }
    
    .notification-item i {
      font-size: 1.5rem;
      margin-right: 10px;
      color: var(--warning);
    }
    
    .footer {
      position: fixed;
      bottom: 0;
      right: 0;
      padding: 10px;
      background-color: var(--primary);
      color: white;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      
      .sidebar:hover {
        width: 150px;
      }
      
      .sidebar li span {
        display: none;
      }
      
      .sidebar:hover li span {
        display: inline;
      }
      
      .container {
        margin-left: 60px;
      }
      
      .sidebar:hover + .container {
        margin-left: 150px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <h1>DRE Gerencial</h1>
  </nav>
  
  <div class="sidebar">
    <ul>
      <li class="active" onclick="showPanel('overview', this)">
        <i class="fas fa-tachometer-alt"></i><span>Visão Geral</span>
      </li>
      <li onclick="showPanel('revenue', this)">
        <i class="fas fa-chart-line"></i><span>Receitas</span>
      </li>
      <li onclick="showPanel('costs', this)">
        <i class="fas fa-coins"></i><span>Custos</span>
      </li>
      <li onclick="showPanel('expenses', this)">
        <i class="fas fa-money-bill-wave"></i><span>Despesas</span>
      </li>
      <li onclick="showPanel('reports', this)">
        <i class="fas fa-file-alt"></i><span>Relatórios</span>
      </li>
    </ul>
  </div>
  
  <div class="container">
    <div id="overview" class="panel active-panel">
      <h2>Visão Geral</h2>
      
      <div id="selected-month-display" style="text-align: center; margin-bottom: 10px; font-size: 1.2rem; font-weight: bold;">
        Mês Selecionado: Todos os Meses
      </div>
      
      <div class="grid">
        <div class="card" style="background-color: #3498db;">
          <div class="card-icon">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="card-content">
            <h3>Receita Bruta</h3>
            <p class="value" id="gross-revenue">R$ 0,00</p>
          </div>
        </div>
        
        <div class="card" style="background-color: #2ecc71;">
          <div class="card-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
          <div class="card-content">
            <h3>Lucro Operacional</h3>
            <p class="value" id="operating-profit">R$ 0,00</p>
          </div>
        </div>
        
        <div class="card" style="background-color: #e74c3c;">
          <div class="card-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="card-content">
            <h3>Lucro Líquido</h3>
            <p class="value" id="net-profit">R$ 0,00</p>
          </div>
        </div>
      </div>
      
      <div class="grid">
        <div class="chart-container chart-small">
          <canvas id="lineChart"></canvas>
        </div>
        
        <div class="chart-container chart-small">
          <canvas id="barChart"></canvas>
        </div>
        
        <div class="chart-container chart-small">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
      
      <div class="chart-container">
        <h3>Histórico de Receitas e Despesas</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Mês/Ano</th>
              <th>Receita Bruta</th>
              <th>Custos</th>
              <th>Despesas</th>
              <th>Selecionar</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
          </tbody>
        </table>
      </div>
      
      <div class="notifications">
        <h3>Notificações</h3>
        <div id="notifications-list">
        </div>
      </div>
    </div>

    <!-- Painel Receitas -->
    <div id="revenue" class="panel">
      <h2>Cadastro de Receitas</h2>
      <form id="revenue-form">
        <div class="form-group">
          <label>Tipo de Receita</label>
          <select class="form-control" name="tipo" required>
            <option value="Vendas Matriz/Curitiba">Vendas Matriz/Curitiba</option>
            <option value="Vendas Maringá">Vendas Maringá</option>
            <option value="Vendas Prudente">Vendas Prudente</option>
            <option value="Receitas Financeiras">Receitas Financeiras</option>
            <option value="Outras Receitas">Outras Receitas</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" name="valor" class="form-control" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Descrição</label>
          <textarea class="form-control" name="descricao" required></textarea>
        </div>
        <div class="form-group">
          <label>Mês/Ano</label>
          <input type="month" name="mesAno" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Arquivo Comprobatório</label>
          <div class="file-upload" onclick="document.getElementById('revenue-file').click()">
            <input type="file" id="revenue-file" name="files" accept=".xlsx,.xls,.pdf,.doc,.docx" style="display:none;"
multiple>
            <p>Arraste um arquivo ou clique para selecionar</p>
          </div>
          <div id="revenue-file-list"></div>
        </div>
        <button type="submit" class="btn">Salvar</button>
      </form>
      
      <div class="form-group">
        <label>Pesquisar Registros</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="revenue-search" class="form-control" placeholder="Pesquisar por tipo, arquivo ou descrição...">
          <input type="month" id="revenue-search-month" class="form-control">
          <button class="btn" onclick="buscarReceitas()">Buscar</button>
        </div>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Valor (R$)</th>
            <th>Descrição</th>
            <th>Mês/Ano</th>
            <th>Arquivos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="revenue-history">
        </tbody>
      </table>
    </div>
    
    <!-- Painel de Custos -->
    <div id="costs" class="panel">
      <h2>Cadastro de Custos</h2>
      <form id="costs-form">
        <div class="form-group">
          <label>Tipo de Custo</label>
          <select class="form-control" name="tipo" required>
            <option value="Matéria Prima">Matéria Prima</option>
            <option value="Mão de Obra">Mão de Obra</option>
            <option value="Mão de Obra Terceirizada">Mão de Obra Terceirizada</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" name="valor" class="form-control" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Descrição</label>
          <textarea class="form-control" name="descricao" required></textarea>
        </div>
        <div class="form-group">
          <label>Mês/Ano</label>
          <input type="month" name="mesAno" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Arquivo Comprobatório</label>
          <div class="file-upload" onclick="document.getElementById('costs-file').click()">
            <input type="file" id="costs-file" name="files" accept=".xlsx,.xls,.pdf,.doc,.docx" style="display:none;" multiple>
            <p>Arraste um arquivo ou clique para selecionar</p>
          </div>
          <div id="costs-file-list"></div>
        </div>
        <button type="submit" class="btn">Salvar</button>
      </form>

      <div class="form-group">
        <label>Pesquisar Registros</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="costs-search" class="form-control" placeholder="Pesquisar por tipo, arquivo ou descrição...">
          <input type="month" id="costs-search-month" class="form-control">
          <button class="btn" onclick="buscarCustos()">Buscar</button>
        </div>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Valor (R$)</th>
            <th>Descrição</th>
            <th>Mês/Ano</th>
            <th>Arquivos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="costs-history">
        </tbody>
      </table>
    </div>

    <!-- Painel de Despesas -->
    <div id="expenses" class="panel">
      <h2>Cadastro de Despesas</h2>
      <form id="expenses-form">
        <div class="form-group">
          <label>Tipo de Despesa</label>
          <select class="form-control" name="tipo" required>
            <option value="Administrativas">Administrativas</option>
            <option value="Comerciais">Comerciais</option>
            <option value="Financeiras">Financeiras</option>
            <option value="Caminhões">Caminhões</option>
            <option value="Combustível">Combustível</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" name="valor" class="form-control" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Descrição</label>
          <textarea class="form-control" name="descricao" required></textarea>
        </div>
        <div class="form-group">
          <label>Mês/Ano</label>
          <input type="month" name="mesAno" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Arquivo Comprobatório</label>
          <div class="file-upload" onclick="document.getElementById('expenses-file').click()">
            <input type="file" id="expenses-file" name="files" accept=".xlsx,.xls,.pdf,.doc,.docx" style="display:none;" multiple>
            <p>Arraste um arquivo ou clique para selecionar</p>
          </div>
          <div id="expenses-file-list"></div>
        </div>
        <button type="submit" class="btn">Salvar</button>
      </form>

      <div class="form-group">
        <label>Pesquisar Registros</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="expenses-search" class="form-control" placeholder="Pesquisar por tipo, arquivo ou descrição...">
          <input type="month" id="expenses-search-month" class="form-control">
          <button class="btn" onclick="buscarDespesas()">Buscar</button>
        </div>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Valor (R$)</th>
            <th>Descrição</th>
            <th>Mês/Ano</th>
            <th>Arquivos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="expenses-history">
        </tbody>
      </table>
    </div>

    <!-- Painel de Relatórios -->
    <div id="reports" class="panel">
      <h2>Relatórios</h2>
      <form id="report-form">
        <div class="form-group">
          <label>Tipo de Relatório</label>
          <select class="form-control" id="report-type" required>
            <option value="dre">DRE</option>
          </select>
        </div>
        <div class="form-group">
          <label>Mês/Ano Inicial</label>
          <input type="month" class="form-control" id="report-start" required>
        </div>
        <div class="form-group">
          <label>Mês/Ano Final</label>
          <input type="month" class="form-control" id="report-end" required>
        </div>
        <button type="submit" class="btn">Gerar Relatório</button>
      </form>
      
      <div id="report-output" class="chart-container" style="display: none;">
        <h3>Relatório Gerado</h3>
        <div id="report-content"></div>
        <button class="btn" onclick="exportarPDF()">Exportar PDF</button>
        <button class="btn" onclick="exportarExcel()">Exportar Excel</button>
      </div>
    </div>
  </div>
  
  <div class="footer">
    Desenvolvido por Samuel Bloch
  </div>

  <script type="module">
    // Importações do Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js';
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js';

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAbJeDK8Q2KZMWfHtqWpUYqvwa1dIbJXQA",
      authDomain: "santome-5518c.firebaseapp.com",
      projectId: "santome-5518c",
      storageBucket: "santome-5518c.appspot.com",
      messagingSenderId: "586838170514",
      appId: "1:586838170514:web:68845f852d7d83ccebbf4b",
      measurementId: "G-HGBWW5BZMM"
    };

    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Variáveis globais
    let editRevenueId = null;
    let editCostId = null;
    let editExpenseId = null;
    let selectedMonth = null;
    let lineChart, barChart, pieChart;

    // Função para mostrar painéis
    window.showPanel = function(panelId, clickedElement) {
      document.querySelectorAll('.sidebar li').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active-panel'));
      clickedElement.classList.add('active');
      document.getElementById(panelId).classList.add('active-panel');
    };

    // Funções de formatação
    function formatarData(dataString) {
      const [ano, mes] = dataString.split('-');
      return `${mes}/${ano}`;
    }

    function formatarMoeda(valor) {
      return valor.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    }

    // Inicialização dos gráficos
    function inicializarGraficos() {
      const ctxLine = document.getElementById('lineChart').getContext('2d');
      lineChart = new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Receita Bruta',
              data: [],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.2)',
              fill: true,
              tension: 0.1
            },
            {
              label: 'Lucro Líquido',
              data: [],
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.2)',
              fill: true,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Evolução Financeira' }
          }
        }
      });

      const ctxBar = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Despesas',
            data: [],
            backgroundColor: '#e74c3c'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Despesas por Mês' }
          }
        }
      });

      const ctxPie = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
          labels: ['Administrativas', 'Comerciais', 'Financeiras', 'Caminhões', 'Combustível'],
          datasets: [{
            data: [],
            backgroundColor: ['#e74c3c', '#f1c40f', '#8e44ad', '#2ecc71', '#3498db']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              formatter: (value) => formatarMoeda(value),
              color: '#fff',
              font: { weight: 'bold', size: 12 },
              anchor: 'center',
              align: 'center',
              offset: 0
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Atualização dos gráficos
    async function atualizarGraficos() {
      try {
        const [receitasSnapshot, custosSnapshot, despesasSnapshot] = await Promise.all([
          getDocs(collection(db, 'revenues')),
          getDocs(collection(db, 'costs')),
          getDocs(collection(db, 'expenses'))
        ]);

        const mesesSet = new Set();
        receitasSnapshot.forEach(doc => mesesSet.add(doc.data().mesAno));
        custosSnapshot.forEach(doc => mesesSet.add(doc.data().mesAno));
        despesasSnapshot.forEach(doc => mesesSet.add(doc.data().mesAno));

        const meses = Array.from(mesesSet).sort();
        const dadosReceita = [];
        const dadosLucroLiquido = [];
        const dadosDespesas = [];
        const dadosCustos = [];

        for (const mes of meses) {
          const receitas = receitasSnapshot.docs.filter(doc => doc.data().mesAno === mes);
          const custos = custosSnapshot.docs.filter(doc => doc.data().mesAno === mes);
          const despesas = despesasSnapshot.docs.filter(doc => doc.data().mesAno === mes);

          const totalReceita = receitas.reduce((soma, doc) => soma + doc.data().valor, 0);
          const totalCusto = custos.reduce((soma, doc) => soma + doc.data().valor, 0);
          const totalDespesas = despesas.reduce((soma, doc) => soma + doc.data().valor, 0);

          const lucroBruto = totalReceita - totalCusto;
          const lucroOperacional = lucroBruto - totalDespesas;

          dadosReceita.push(totalReceita);
          dadosLucroLiquido.push(lucroOperacional);
          dadosDespesas.push(totalDespesas);
          dadosCustos.push(totalCusto);
        }

        lineChart.data.labels = meses.map(formatarData);
        lineChart.data.datasets[0].data = dadosReceita;
        lineChart.data.datasets[1].data = dadosLucroLiquido;
        lineChart.update();

        barChart.data.labels = meses.map(formatarData);
        barChart.data.datasets[0].data = dadosDespesas;
        barChart.update();

        atualizarTabelaHistorico(meses, dadosReceita, dadosCustos, dadosDespesas);
        atualizarCartoesEGraficoPizza();
      } catch (erro) {
        console.error('Erro ao atualizar gráficos:', erro);
      }
    }

    // Atualização da tabela de histórico
    function atualizarTabelaHistorico(meses, dadosReceita, dadosCustos, dadosDespesas) {
      const tbody = document.getElementById('history-table-body');
      tbody.innerHTML = '';
      
      meses.forEach((mes, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatarData(mes)}</td>
          <td>${formatarMoeda(dadosReceita[index])}</td>
          <td>${formatarMoeda(dadosCustos[index])}</td>
          <td>${formatarMoeda(dadosDespesas[index])}</td>
          <td><button class="btn btn-select" onclick="selecionarMes('${mes}')">Selecionar</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Função para selecionar mês
    window.selecionarMes = function(mes) {
      selectedMonth = mes;
      atualizarCartoesEGraficoPizza();
    };

    // Atualização dos cartões e gráfico de pizza
    async function atualizarCartoesEGraficoPizza() {
      try {
        let receitasQuery = collection(db, 'revenues');
        let custosQuery = collection(db, 'costs');
        let despesasQuery = collection(db, 'expenses');

        if (selectedMonth) {
          receitasQuery = query(receitasQuery, where('mesAno', '==', selectedMonth));
          custosQuery = query(custosQuery, where('mesAno', '==', selectedMonth));
          despesasQuery = query(despesasQuery, where('mesAno', '==', selectedMonth));
        }

        const [receitasSnapshot, custosSnapshot, despesasSnapshot] = await Promise.all([
          getDocs(receitasQuery),
          getDocs(custosQuery),
          getDocs(despesasQuery)
        ]);

        const totalReceitas = receitasSnapshot.docs.reduce((soma, doc) => soma + doc.data().valor, 0);
        const totalCustos = custosSnapshot.docs.reduce((soma, doc) => soma + doc.data().valor, 0);
        const totalDespesas = despesasSnapshot.docs.reduce((soma, doc) => soma + doc.data().valor, 0);

        const lucroBruto = totalReceitas - totalCustos;
        const lucroOperacional = lucroBruto - totalDespesas;

        document.getElementById('selected-month-display').innerText = selectedMonth ? 
          `Mês Selecionado: ${formatarData(selectedMonth)}` : 
          'Mês Selecionado: Todos os Meses';

        document.getElementById('gross-revenue').innerText = formatarMoeda(totalReceitas);
        document.getElementById('operating-profit').innerText = formatarMoeda(lucroOperacional);
        document.getElementById('net-profit').innerText = formatarMoeda(lucroOperacional);

        const somasDespesas = {
          'Administrativas': 0,
          'Comerciais': 0,
          'Financeiras': 0,
          'Caminhões': 0,
          'Combustível': 0
        };

        despesasSnapshot.docs.forEach(doc => {
          const dados = doc.data();
          if (somasDespesas.hasOwnProperty(dados.tipo)) {
            somasDespesas[dados.tipo] += dados.valor;
          }
        });

        pieChart.data.datasets[0].data = Object.values(somasDespesas);
        pieChart.update();
      } catch (erro) {
        console.error('Erro ao atualizar cartões e gráfico de pizza:', erro);
      }
    }

    // Funções de manipulação de arquivos
    function manipularSelecaoArquivo(evento, listaId) {
      const listaArquivos = evento.target.files;
      const elementoLista = document.getElementById(listaId);
      elementoLista.innerHTML = '';
      
      for (let i = 0; i < listaArquivos.length; i++) {
        const p = document.createElement('p');
        p.innerText = listaArquivos[i].name;
        elementoLista.appendChild(p);
      }
    }

    // Event Listeners para arquivos
    document.getElementById('revenue-file').addEventListener('change', 
      (e) => manipularSelecaoArquivo(e, 'revenue-file-list'));
    document.getElementById('costs-file').addEventListener('change', 
      (e) => manipularSelecaoArquivo(e, 'costs-file-list'));
    document.getElementById('expenses-file').addEventListener('change', 
      (e) => manipularSelecaoArquivo(e, 'expenses-file-list'));

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      inicializarGraficos();
      carregarDadosDoServidor();
    });

    // Funções CRUD para Receitas
    async function carregarReceitas() {
      try {
        const snapshot = await getDocs(collection(db, 'revenues'));
        const tbody = document.getElementById('revenue-history');
        tbody.innerHTML = '';
        
        snapshot.forEach(doc => {
          const dados = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dados.tipo}</td>
            <td>${formatarMoeda(dados.valor)}</td>
            <td>${dados.descricao}</td>
            <td>${formatarData(dados.mesAno)}</td>
            <td>${dados.arquivos ? dados.arquivos.join(', ') : ''}</td>
            <td>
              <button class="btn" onclick="editarReceita('${doc.id}')">Editar</button>
              <button class="btn btn-delete" onclick="excluirReceita('${doc.id}')">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (erro) {
        console.error('Erro ao carregar receitas:', erro);
      }
    }

    window.carregarReceitas = carregarReceitas;

    // Event listener para o formulário de receitas
    document.getElementById('revenue-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const dados = {
        tipo: formData.get('tipo'),
        valor: parseFloat(formData.get('valor')),
        descricao: formData.get('descricao'),
        mesAno: formData.get('mesAno'),
        arquivos: []
      };

      try {
        if (editRevenueId) {
          await updateDoc(doc(db, 'revenues', editRevenueId), dados);
          editRevenueId = null;
        } else {
          await addDoc(collection(db, 'revenues'), dados);
        }
        e.target.reset();
        await carregarReceitas();
        await atualizarGraficos();
      } catch (erro) {
        console.error('Erro ao salvar receita:', erro);
      }
    });

    // Funções CRUD para Custos
    async function carregarCustos() {
      try {
        const snapshot = await getDocs(collection(db, 'costs'));
        const tbody = document.getElementById('costs-history');
        tbody.innerHTML = '';
        
        snapshot.forEach(doc => {
          const dados = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dados.tipo}</td>
            <td>${formatarMoeda(dados.valor)}</td>
            <td>${dados.descricao}</td>
            <td>${formatarData(dados.mesAno)}</td>
            <td>${dados.arquivos ? dados.arquivos.join(', ') : ''}</td>
            <td>
              <button class="btn" onclick="editarCusto('${doc.id}')">Editar</button>
              <button class="btn btn-delete" onclick="excluirCusto('${doc.id}')">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (erro) {
        console.error('Erro ao carregar custos:', erro);
      }
    }

    window.carregarCustos = carregarCustos;

    // Event listener para o formulário de custos
    document.getElementById('costs-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const dados = {
        tipo: formData.get('tipo'),
        valor: parseFloat(formData.get('valor')),
        descricao: formData.get('descricao'),
        mesAno: formData.get('mesAno'),
        arquivos: []
      };

      try {
        if (editCostId) {
          await updateDoc(doc(db, 'costs', editCostId), dados);
          editCostId = null;
        } else {
          await addDoc(collection(db, 'costs'), dados);
        }
        e.target.reset();
        await carregarCustos();
        await atualizarGraficos();
      } catch (erro) {
        console.error('Erro ao salvar custo:', erro);
      }
    });

    // Funções CRUD para Despesas
    async function carregarDespesas() {
      try {
        const snapshot = await getDocs(collection(db, 'expenses'));
        const tbody = document.getElementById('expenses-history');
        tbody.innerHTML = '';
        
        snapshot.forEach(doc => {
          const dados = doc.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dados.tipo}</td>
            <td>${formatarMoeda(dados.valor)}</td>
            <td>${dados.descricao}</td>
            <td>${formatarData(dados.mesAno)}</td>
            <td>${dados.arquivos ? dados.arquivos.join(', ') : ''}</td>
            <td>
              <button class="btn" onclick="editarDespesa('${doc.id}')">Editar</button>
              <button class="btn btn-delete" onclick="excluirDespesa('${doc.id}')">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (erro) {
        console.error('Erro ao carregar despesas:', erro);
      }
    }

    window.carregarDespesas = carregarDespesas;

    // Event listener para o formulário de despesas
    document.getElementById('expenses-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const dados = {
        tipo: formData.get('tipo'),
        valor: parseFloat(formData.get('valor')),
        descricao: formData.get('descricao'),
        mesAno: formData.get('mesAno'),
        arquivos: []
      };

      try {
        if (editExpenseId) {
          await updateDoc(doc(db, 'expenses', editExpenseId), dados);
          editExpenseId = null;
        } else {
          await addDoc(collection(db, 'expenses'), dados);
        }
        e.target.reset();
        await carregarDespesas();
        await atualizarGraficos();
      } catch (erro) {
        console.error('Erro ao salvar despesa:', erro);
      }
    });

    // Função para carregar todos os dados do servidor
    async function carregarDadosDoServidor() {
      await Promise.all([
        carregarReceitas(),
        carregarCustos(),
        carregarDespesas()
      ]);
      await atualizarGraficos();
    }

    // Funções de busca
    window.buscarReceitas = async function() {
      const termo = document.getElementById('revenue-search').value.toLowerCase();
      const mes = document.getElementById('revenue-search-month').value;
      
      try {
        let queryRef = collection(db, 'revenues');
        if (mes) {
          queryRef = query(queryRef, where('mesAno', '==', mes));
        }
        
        const snapshot = await getDocs(queryRef);
        const tbody = document.getElementById('revenue-history');
        tbody.innerHTML = '';

        snapshot.forEach(doc => {
          const dados = doc.data();
          if (!termo || 
              dados.tipo.toLowerCase().includes(termo) ||
              dados.descricao.toLowerCase().includes(termo)) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${dados.tipo}</td>
              <td>${formatarMoeda(dados.valor)}</td>
              <td>${dados.descricao}</td>
              <td>${formatarData(dados.mesAno)}</td>
              <td>${dados.arquivos ? dados.arquivos.join(', ') : ''}</td>
              <td>
                <button class="btn" onclick="editarReceita('${doc.id}')">Editar</button>
                <button class="btn btn-delete" onclick="excluirReceita('${doc.id}')">Excluir</button>
              </td>
            `;
            tbody.appendChild(tr);
          }
        });
      } catch (erro) {
        console.error('Erro ao buscar receitas:', erro);
      }
    };

    // Funções de edição
    window.editarReceita = async function(id) {
      try {
        const docRef = doc(db, 'revenues', id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const dados = docSnap.data();
          const form = document.getElementById('revenue-form');
          form.tipo.value = dados.tipo;
          form.valor.value = dados.valor;
          form.descricao.value = dados.descricao;
          form.mesAno.value = dados.mesAno;
          editRevenueId = id;
        }
      } catch (erro) {
        console.error('Erro ao editar receita:', erro);
      }
    };

    window.editarCusto = async function(id) {
      try {
        const docRef = doc(db, 'costs', id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const dados = docSnap.data();
          const form = document.getElementById('costs-form');
          form.tipo.value = dados.tipo;
          form.valor.value = dados.valor;
          form.descricao.value = dados.descricao;
          form.mesAno.value = dados.mesAno;
          editCostId = id;
        }
      } catch (erro) {
        console.error('Erro ao editar custo:', erro);
      }
    };

    window.editarDespesa = async function(id) {
      try {
        const docRef = doc(db, 'expenses', id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const dados = docSnap.data();
          const form = document.getElementById('expenses-form');
          form.tipo.value = dados.tipo;
          form.valor.value = dados.valor;
          form.descricao.value = dados.descricao;
          form.mesAno.value = dados.mesAno;
          editExpenseId = id;
        }
      } catch (erro) {
        console.error('Erro ao editar despesa:', erro);
      }
    };

    // Funções de exclusão
    window.excluirReceita = async function(id) {
      if (confirm('Tem certeza que deseja excluir esta receita?')) {
        try {
          await deleteDoc(doc(db, 'revenues', id));
          await carregarReceitas();
          await atualizarGraficos();
        } catch (erro) {
          console.error('Erro ao excluir receita:', erro);
        }
      }
    };

    window.excluirCusto = async function(id) {
      if (confirm('Tem certeza que deseja excluir este custo?')) {
        try {
          await deleteDoc(doc(db, 'costs', id));
          await carregarCustos();
          await atualizarGraficos();
        } catch (erro) {
          console.error('Erro ao excluir custo:', erro);
        }
      }
    };

    window.excluirDespesa = async function(id) {
      if (confirm('Tem certeza que deseja excluir esta despesa?')) {
        try {
          await deleteDoc(doc(db, 'expenses', id));
          await carregarDespesas();
          await atualizarGraficos();
        } catch (erro) {
          console.error('Erro ao excluir despesa:', erro);
        }
      }
    };

    // Funções de exportação
    window.exportarPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const conteudo = document.getElementById('report-content').innerText;
      doc.text(conteudo, 10, 10);
      doc.save('relatorio-dre.pdf');
    };

    window.exportarExcel = function() {
      const wb = XLSX.utils.book_new();
      const conteudo = document.getElementById('report-content').innerText;
      const ws = XLSX.utils.aoa_to_sheet([[conteudo]]);
      XLSX.utils.book_append_sheet(wb, ws, "Relatório");
      XLSX.writeFile(wb, 'relatorio-dre.xlsx');
    };

    // Event listener para geração de relatórios
    document.getElementById('report-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const tipo = document.getElementById('report-type').value;
      const inicio = document.getElementById('report-start').value;
      const fim = document.getElementById('report-end').value;

      try {
        const [receitasSnapshot, custosSnapshot, despesasSnapshot] = await Promise.all([
          getDocs(query(collection(db, 'revenues'), where('mesAno', '>=', inicio), where('mesAno', '<=', fim))),
          getDocs(query(collection(db, 'costs'), where('mesAno', '>=', inicio), where('mesAno', '<=', fim))),
          getDocs(query(collection(db, 'expenses'), where('mesAno', '>=', inicio), where('mesAno', '<=', fim)))
        ]);

        const totalReceitas = receitasSnapshot.docs.reduce((soma, doc) => soma + doc.data().valor, 0);
        const totalCustos = custosSnapshot.docs.reduce((soma, doc) => soma + doc.data().valor, 0);
        const totalDespesas = despesasSnapshot.docs.reduce((soma, doc) => soma + doc.data().valor, 0);

        const lucroBruto = totalReceitas - totalCustos;
        const lucroOperacional = lucroBruto - totalDespesas;

        const conteudo = `
          DRE - Demonstração do Resultado do Exercício
          Período: ${formatarData(inicio)} a ${formatarData(fim)}

          Receita Bruta: ${formatarMoeda(totalReceitas)}
          (-) Custos: ${formatarMoeda(totalCustos)}
          (=) Lucro Bruto: ${formatarMoeda(lucroBruto)}
          (-) Despesas Operacionais: ${formatarMoeda(totalDespesas)}
          (=) Lucro Operacional: ${formatarMoeda(lucroOperacional)}
        `;

        document.getElementById('report-content').innerText = conteudo;
        document.getElementById('report-output').style.display = 'block';
      } catch (erro) {
        console.error('Erro ao gerar relatório:', erro);
      }
    });
  </script>
</body>
</html>
