<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automatizador NFS-e Ultra-Direto</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #333;
    }

    header {
      background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      position: relative;
    }

    header h1 {
      font-size: 2.2em;
      margin-bottom: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .version-badge {
      position: absolute;
      top: 10px;
      right: 20px;
      background: #38a169;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .container {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
    }

    .upload-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      text-align: center;
    }

    .upload-area {
      border: 3px dashed #cbd5e0;
      border-radius: 10px;
      padding: 40px 20px;
      margin: 20px 0;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #667eea;
      background-color: #f7fafc;
    }

    .upload-area.dragover {
      border-color: #667eea;
      background-color: #ebf8ff;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 3em;
      color: #cbd5e0;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 1.2em;
      color: #4a5568;
      margin-bottom: 10px;
    }

    .upload-hint {
      font-size: 0.9em;
      color: #718096;
      background: #f7fafc;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }

    #fileInput {
      display: none;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }

    .status-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .status-ok {
      background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
    }

    .status-error {
      background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
    }

    .progress-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #4a5568;
      font-weight: bold;
    }

    .results-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      display: none;
    }

    .results-title {
      color: #2d3748;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.5em;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .results-table th {
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      color: white;
      padding: 15px 10px;
      text-align: left;
      font-weight: bold;
      font-size: 0.9em;
    }

    .results-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.85em;
    }

    .results-table tr:hover {
      background-color: #f7fafc;
    }

    .debug-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      display: none;
    }

    .debug-content {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      line-height: 1.4;
    }

    .debug-step {
      margin: 5px 0;
      padding: 5px 10px;
      border-radius: 5px;
      border-left: 4px solid;
    }

    .debug-info {
      background: #e3f2fd;
      border-left-color: #2196f3;
      color: #1565c0;
    }

    .debug-success {
      background: #e8f5e8;
      border-left-color: #4caf50;
      color: #2e7d2e;
    }

    .debug-warning {
      background: #fff3e0;
      border-left-color: #ff9800;
      color: #f57c00;
    }

    .debug-fail {
      background: #ffebee;
      border-left-color: #f44336;
      color: #c62828;
    }

    .debug-error {
      background: #ffebee;
      border-left-color: #f44336;
      color: #c62828;
      font-weight: bold;
    }

    footer {
      background: #2d3748;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: auto;
    }

    .btn-download {
      background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
    }

    .btn-clear {
      background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .summary-card h3 {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .summary-card p {
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      header h1 { font-size: 1.8em; }
      .container { padding: 10px; }
      .upload-section { padding: 20px; }
      .results-table { font-size: 0.75em; }
      .results-table th, .results-table td { padding: 8px 5px; }
      .version-badge { position: static; margin: 10px auto; display: block; width: fit-content; }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-bullseye"></i> Automatizador NFS-e Ultra-Direto v3.8</h1>
    <p>Melhorias adicionadas: VANTOIR DERETTI + SERVOPA + TRANSPOTECH + SINDICATO + FSC</p>
    <div class="version-badge">v3.8 - Apenas Adicionando Melhorias</div>
  </header>

  <div class="container">
    <div class="status-section" id="statusSection">
      <div id="statusMessage">Carregando sistema ultra-direto...</div>
    </div>

    <div class="upload-section">
      <h2><i class="fas fa-cloud-upload-alt"></i> Upload de Documentos</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="upload-text">Clique aqui ou arraste os arquivos</div>
        <div class="upload-hint">v3.8 - Todas as melhorias de nomes adicionadas: VANTOIR DERETTI + SERVOPA + TRANSPOTECH + SINDICATO + FSC + M.A. SILVA + BHS + PORTEC + W.O. RIGO + RD CARTUCHOS + outros</div>
      </div>
      <input type="file" id="fileInput" multiple accept=".pdf,.xlsx,.xls">
      <button class="btn" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-folder-open"></i> Selecionar Arquivos
      </button>
      <button class="btn" onclick="processFiles()" id="processBtn" disabled>
        <i class="fas fa-cogs"></i> Processar Documentos
      </button>
    </div>

    <div class="progress-section" id="progressSection">
      <h3><i class="fas fa-spinner fa-spin"></i> Processando...</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Aplicando extra√ß√£o ultra-direta...</div>
    </div>

    <div class="results-section" id="resultsSection">
      <div class="summary-cards" id="summaryCards"></div>
      
      <div style="text-align: center; margin-bottom: 20px;">
        <button class="btn btn-download" onclick="downloadExcel()" id="downloadBtn">
          <i class="fas fa-download"></i> Baixar Planilha
        </button>
        <button class="btn btn-clear" onclick="clearResults()">
          <i class="fas fa-trash"></i> Limpar Resultados
        </button>
      </div>

      <h2 class="results-title">Resultados Ultra-Diretos</h2>
      <div style="overflow-x: auto;">
        <table class="results-table" id="resultsTable">
          <thead>
            <tr>
              <th>Arquivo</th>
              <th>CNPJ</th>
              <th>Nome do Emitente</th>
              <th>N√∫mero</th>
              <th>Data</th>
              <th>Valor</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="debug-section" id="debugSection">
      <h3>Debug Ultra-Direto - An√°lise Simples</h3>
      <div class="debug-content" id="debugContent"></div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Automatizador NFS-e Ultra-Direto v3.8 | 
    <a href="#" onclick="toggleDebug(); return false;">Debug Ultra-Direto</a></p>
  </footer>

  <script>
    let librariesLoaded = false;
    let selectedFiles = [];
    let allData = [];
    let debugInfo = [];

    // ===== CLASSE PRINCIPAL DE EXTRA√á√ÉO (ORIGINAL COM ADI√á√ïES) =====
    class NFSExtractor {
      constructor() {
        this.debugSteps = [];
      }

      logStep(type, message, details = '') {
        const step = {
          type: type,
          message: message,
          details: details,
          timestamp: new Date().toLocaleTimeString()
        };
        this.debugSteps.push(step);
        
        const prefix = {
          'info': '[INFO]',
          'success': '[SUCCESS]', 
          'warning': '[WARNING]',
          'fail': '[FAIL]',
          'error': '[ERROR]'
        }[type] || '[LOG]';
        
        console.log(`${prefix} ${message}`, details ? details : '');
      }

      // ===== EXTRA√á√ÉO DE NOME - ORIGINAL + ADI√á√ïES =====
      extractEmitenteNameLaser(text, cnpj) {
        this.logStep('info', 'Iniciando extra√ß√£o ULTRA-DIRETA de nome do emitente');
        
        if (!cnpj) {
          this.logStep('fail', 'CNPJ n√£o fornecido para busca de nome');
          return '';
        }

        // ===== NOVAS ESTRAT√âGIAS ADICIONADAS v3.8 =====
        
        // NOVA ESTRAT√âGIA: VANTOIR DERETTI ME
        const vantoirMatch = text.match(/VANTOIR\s+DERETTI[^0-9\n\r]*ME[^0-9\n\r]*/gi);
        if (vantoirMatch) {
          let name = this.cleanCompanyName(vantoirMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'VANTOIR DERETTI ME encontrada', name);
            return name;
          }
        }

        // NOVA ESTRAT√âGIA: SERVOPA CAMINHOES LTDA
        const servopaMatch = text.match(/SERVOPA\s+CAMINHOES[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (servopaMatch) {
          let name = this.cleanCompanyName(servopaMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'SERVOPA CAMINHOES LTDA encontrada', name);
            return name;
          }
        }

        // NOVA ESTRAT√âGIA: TRANSPOTECH PECAS E SERVICOS LTDA
        const transpotechMatch = text.match(/TRANSPOTECH\s+PECAS\s+E\s+SERVICOS[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (transpotechMatch) {
          let name = this.cleanCompanyName(transpotechMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'TRANSPOTECH PECAS E SERVICOS encontrada', name);
            return name;
          }
        }

        // NOVA ESTRAT√âGIA: SINDICATO DO COMERCIO VAREJISTA
        const sindicatoMatch = text.match(/SINDICATO\s+DO\s+COMERCIO\s+VAREJISTA[^0-9\n\r]*JARAGUA\s+DO\s+SUL[^0-9\n\r]*/gi);
        if (sindicatoMatch) {
          let name = this.cleanCompanyName(sindicatoMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'SINDICATO DO COMERCIO VAREJISTA encontrado', name);
            return name;
          }
        }

        // NOVA ESTRAT√âGIA: FSC COMUNICACOES LTDA
        const fscMatch = text.match(/FSC\s+COMUNICACOES[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (fscMatch) {
          let name = this.cleanCompanyName(fscMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'FSC COMUNICACOES encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: M.A. DA SILVA VIEIRA - AUTO EL√âTRICA
        const autoEletricaMatch = text.match(/M\.A\.\s+DA\s+SILVA\s+VIEIRA[^0-9\n\r]*AUTO\s+EL[E√â]TRICA[^0-9\n\r]*/gi);
        if (autoEletricaMatch) {
          let name = this.cleanCompanyName(autoEletricaMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'M.A. DA SILVA VIEIRA - AUTO EL√âTRICA encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: BHS MARINGA TECNOLOGIA LTDA
        const bhsMatch = text.match(/BHS\s+MARINGA\s+TECNOLOGIA[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (bhsMatch) {
          let name = this.cleanCompanyName(bhsMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'BHS MARINGA TECNOLOGIA LTDA encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: PORTEC COMERCIO DE PRODUTOS ELETRONICOS
        const portecMatch = text.match(/PORTEC\s+COMERCIO[^0-9\n\r]*PRODUTOS[^0-9\n\r]*ELETRONICOS[^0-9\n\r]*/gi);
        if (portecMatch) {
          let name = this.cleanCompanyName(portecMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'PORTEC COMERCIO encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: TRANORTE SISTEMAS MECANIZADOS LTDA
        const tranorteMatch = text.match(/TRANORTE\s+SISTEMAS[^0-9\n\r]*MECANIZADOS[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (tranorteMatch) {
          let name = this.cleanCompanyName(tranorteMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'TRANORTE SISTEMAS MECANIZADOS encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: POSTO Z4 LTDA
        const postoMatch = text.match(/POSTO\s+Z4[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (postoMatch) {
          let name = this.cleanCompanyName(postoMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'POSTO Z4 LTDA encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: CONTABILIDADE ORLANDO AMORIM S/S LTDA
        const contabilidadeMatch = text.match(/CONTABILIDADE\s+ORLANDO\s+AMORIM[^0-9\n\r]*S\/S[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (contabilidadeMatch) {
          let name = this.cleanCompanyName(contabilidadeMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'CONTABILIDADE ORLANDO AMORIM encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: W.O. RIGO FILHO - INFORMATICA - ME
        const rigoMatch = text.match(/W\.O\.\s+RIGO\s+FILHO[^0-9\n\r]*INFORMATICA[^0-9\n\r]*ME[^0-9\n\r]*/gi);
        if (rigoMatch) {
          let name = this.cleanCompanyName(rigoMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'W.O. RIGO FILHO - INFORMATICA - ME encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: FUNILARIA NITZ LTDA
        const funilariaNitzMatch = text.match(/FUNILARIA\s+NITZ[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
        if (funilariaNitzMatch) {
          let name = this.cleanCompanyName(funilariaNitzMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'FUNILARIA NITZ LTDA encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: SASCAR TECNOLOGIA
        const sascarMatch = text.match(/SASCAR[^0-9\n\r]*TECNOLOGIA[^0-9\n\r]*SEGURAN√áA[^0-9\n\r]*AUTOMOTIVA[^0-9\n\r]*S\.?A[^0-9\n\r]*/gi);
        if (sascarMatch) {
          let name = this.cleanCompanyName(sascarMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'SASCAR TECNOLOGIA encontrada', name);
            return name;
          }
        }

        // ESTRAT√âGIA ADICIONADA: LUCIA IVONETE espec√≠fica
        const luciaMatch = text.match(/LUCIA\s+IVONETE\s+VICK\s+KASMIRSKI[^0-9\n\r]*EPP[^0-9\n\r]*MECANICA\s+DIESEL\s+KASMIRSKI[^0-9\n\r]*/gi);
        if (luciaMatch) {
          let name = this.cleanCompanyName(luciaMatch[0]);
          if (this.validateCompanyNameImproved(name)) {
            this.logStep('success', 'LUCIA IVONETE espec√≠fica encontrada', name);
            return name;
          }
        }

        // ===== ESTRAT√âGIAS ORIGINAIS MANTIDAS =====

        // Busca por se√ß√£o PRESTADOR
        const prestadorMatch = text.match(/PRESTADOR\s+DE\s+SERVI[√áC]OS([\s\S]*?)(?=TOMADOR|DISCRIMINA[√áC][√ÉA]O|Valor Total|$)/gi);
        if (prestadorMatch) {
          const prestadorSection = prestadorMatch[0];
          this.logStep('info', 'Se√ß√£o PRESTADOR encontrada', prestadorSection.substring(0, 200));
          
          // RD CARTUCHOS E INFORMATICA espec√≠fico na se√ß√£o PRESTADOR
          const rdCartuchosMatch = prestadorSection.match(/RD\s+CARTUCHOS\s+E\s+INFORMATICA[^0-9\n\r]*LTDA[^0-9\n\r]*/gi);
          if (rdCartuchosMatch) {
            let name = this.cleanCompanyName(rdCartuchosMatch[0]);
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'RD CARTUCHOS E INFORMATICA encontrada na se√ß√£o PRESTADOR', name);
              return name;
            }
          }

          // Busca qualquer linha com empresa na se√ß√£o prestador
          const prestadorLines = prestadorSection.split(/[\r\n]+/).map(l => l.trim()).filter(l => l.length > 0);
          for (const line of prestadorLines) {
            if (line.length > 15 && line.length < 120 && 
                /LTDA|EPP|S\.?A|ME|EIRELI|CARTUCHOS|TECNOLOGIA|INFORMATICA|RIGO|FILHO|BHS|MARINGA|PORTEC|COMERCIO|SERVOPA|CAMINHOES|TRANSPOTECH|PECAS|SERVICOS|SINDICATO|VAREJISTA|FSC|COMUNICACOES|VANTOIR|DERETTI/gi.test(line) &&
                !/PRESTADOR|TOMADOR|ENDERE√áO|TELEFONE|EMAIL|CPF|CNPJ|Inscri√ß√£o|Munic√≠pio|Complemento|UF:|Bairro CIC|Estado:|CURITIBA|BLUMENAU|ITOUPAVA NORTE/i.test(line)) {
              
              let name = this.cleanCompanyName(line);
              if (this.validateCompanyNameImproved(name)) {
                this.logStep('success', 'Nome encontrado em linha da se√ß√£o PRESTADOR', name);
                return name;
              }
            }
          }
        }

        // Busca por "Raz√£o Social:" espec√≠fica
        const razaoSocialMatches = text.match(/Raz√£o\s+Social:\s*([^0-9\n\r]+?)(?=\s*CNPJ|CPF|\d{2}\.\d{3}\.\d{3}|\n|\r|$)/gi);
        if (razaoSocialMatches) {
          for (const match of razaoSocialMatches) {
            let name = this.cleanCompanyName(match.replace(/Raz√£o\s+Social:\s*/gi, ''));
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'Nome encontrado em Raz√£o Social espec√≠fica', name);
              return name;
            }
          }
        }

        // Nomes com iniciais (J.A., M.S., etc.)
        const initialsMatches = text.match(/([A-Z]\.[A-Z]\.[^0-9\n\r]{5,80}(?:LTDA|EPP|ME|S\.?A|EIRELI)[^0-9\n\r]{0,50})/gi);
        if (initialsMatches) {
          for (const match of initialsMatches) {
            let name = this.cleanCompanyName(match);
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'Nome com iniciais encontrado', name);
              return name;
            }
          }
        }

        // Busca antes do CNPJ
        const beforeCnpjMatches = text.match(new RegExp(`([^0-9\\n\\r]{10,100})\\s*${cnpj.replace(/[.\/-]/g, '\\$&')}`, 'gi'));
        if (beforeCnpjMatches) {
          for (const match of beforeCnpjMatches) {
            let name = this.cleanCompanyName(match.replace(cnpj, ''));
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', 'Nome encontrado antes do CNPJ', name);
              return name;
            }
          }
        }

        // Busca em campos estruturados
        const structuredMatches = [
          text.match(/Nome\/Raz√£o\s*Social[:\s]*([^0-9\n\r]{5,100})/gi),
          text.match(/Raz√£o\s*Social[:\s]*([^0-9\n\r]{5,100})/gi),
          text.match(/Nome\s*Fantasia[:\s]*([^0-9\n\r]{5,100})/gi)
        ];

        for (const matchGroup of structuredMatches) {
          if (matchGroup) {
            for (const match of matchGroup) {
              let name = this.cleanCompanyName(match);
              if (this.validateCompanyNameImproved(name)) {
                this.logStep('success', `Nome encontrado em campo estruturado`, name);
                return name;
              }
            }
          }
        }

        // Busca por primeira linha com nome da empresa
        const lines = text.split(/[\r\n]+/).map(l => l.trim()).filter(l => l.length > 0);
        for (let i = 0; i < Math.min(5, lines.length); i++) {
          const line = lines[i];
          
          if (line.length > 10 && line.length < 120 && 
              /LTDA|EPP|S\.?A|ME|EIRELI|SERVOPA|CAMINHOES|TRANSPOTECH|PECAS|SERVICOS|SINDICATO|COMERCIO|VAREJISTA|FSC|COMUNICACOES|VANTOIR|DERETTI/gi.test(line) &&
              !/PREFEITURA|MUNICIPAL|SECRETARIA|FAZENDA|TOMADOR|PRESTADOR|DOCUMENTO|EMITIDA|Complemento|UF:|CENTRO|MUNIC√çPIO|Bairro CIC|Estado:|CURITIBA|BLUMENAU|ITOUPAVA NORTE|VIA EXPRESSA|PAUL FRITZ/i.test(line)) {
            
            let name = this.cleanCompanyName(line);
            if (this.validateCompanyNameImproved(name)) {
              this.logStep('success', `Nome de empresa encontrado na linha ${i}`, name);
              return name;
            }
          }
        }

        // Estrat√©gias de fallback originais
        const businessMatches = [
          text.match(/([A-Z][^0-9\n\r]{5,100}\s+EPP[^0-9\n\r]{0,50})/i),
          text.match(/([A-Z][^0-9\n\r]{5,100}\s+LTDA\s*-\s*ME[^0-9\n\r]{0,50})/i),
          text.match(/(RD\s+CARTUCHOS[^0-9\n\r]*LTDA[^0-9\n\r]*ME[^0-9\n\r]*)/gi),
          text.match(/(SERVOPA[^0-9\n\r]*CAMINHOES[^0-9\n\r]*LTDA[^0-9\n\r]*)/gi),
          text.match(/(TRANSPOTECH[^0-9\n\r]*PECAS[^0-9\n\r]*SERVICOS[^0-9\n\r]*LTDA[^0-9\n\r]*)/gi),
          text.match(/(SINDICATO[^0-9\n\r]*COMERCIO[^0-9\n\r]*VAREJISTA[^0-9\n\r]*)/gi),
          text.match(/(FSC[^0-9\n\r]*COMUNICACOES[^0-9\n\r]*LTDA[^0-9\n\r]*)/gi),
          text.match(/(VANTOIR[^0-9\n\r]*DERETTI[^0-9\n\r]*ME[^0-9\n\r]*)/gi)
        ];

        for (const matchGroup of businessMatches) {
          if (matchGroup) {
            for (const match of matchGroup) {
              let name = this.cleanCompanyName(match);
              if (this.validateCompanyNameImproved(name)) {
                this.logStep('success', 'Nome encontrado em padr√£o de neg√≥cio', name);
                return name;
              }
            }
          }
        }

        this.logStep('fail', 'TODAS as estrat√©gias (originais + adicionadas) falharam');
        return '';
      }

      // Valida√ß√£o melhorada (APENAS ADI√á√ïES)
      validateCompanyNameImproved(name) {
        if (!name || name.length < 5 || name.length > 150) return false;
        if (!/[A-Za-z]/.test(name)) return false;
        if (/^[\d\s\-\.]+$/.test(name)) return false;
        
        // FILTRO CR√çTICO: N√£o aceitar nomes que s√£o claramente do √≥rg√£o p√∫blico ou tomador
        if (/SECRETARIA|MUNICIPAL|FAZENDA|PREFEITURA|TOMADOR|PRESTADOR|COMERCIO DE BANANAS|Optante Simples|Regime|Situa√ß√£o|Documento emitido|Complemento|UF:|CENTRO|MUNIC√çPIO|Data Presta√ß√£o|N√∫mero:|Bairro CIC|Estado:|CURITIBA|BLUMENAU|MASSARANDUBA|ITOUPAVA NORTE/i.test(name)) {
          return false;
        }
        
        // NOVOS PADR√ïES ACEITOS (ADI√á√ïES):
        if (/VANTOIR.*DERETTI/i.test(name)) return true;
        if (/SERVOPA.*CAMINHOES/i.test(name)) return true;
        if (/TRANSPOTECH.*PECAS.*SERVICOS/i.test(name)) return true;
        if (/SINDICATO.*COMERCIO.*VAREJISTA/i.test(name)) return true;
        if (/FSC.*COMUNICACOES/i.test(name)) return true;
        if (/M\.A\.\s+DA\s+SILVA\s+VIEIRA.*AUTO.*EL[E√â]TRICA/i.test(name)) return true;
        if (/BHS.*MARINGA.*TECNOLOGIA/i.test(name)) return true;
        if (/PORTEC.*COMERCIO.*PRODUTOS.*ELETRONICOS/i.test(name)) return true;
        if (/TRANORTE.*SISTEMAS.*MECANIZADOS/i.test(name)) return true;
        if (/POSTO.*Z4/i.test(name)) return true;
        if (/CONTABILIDADE.*ORLANDO.*AMORIM/i.test(name)) return true;
        if (/W\.O\.\s+RIGO\s+FILHO.*INFORMATICA/i.test(name)) return true;
        if (/LUCIA\s+IVONETE.*KASMIRSKI/i.test(name)) return true;
        if (/FUNILARIA\s+NITZ/i.test(name)) return true;
        if (/SASCAR.*TECNOLOGIA/i.test(name)) return true;
        if (/RD\s+CARTUCHOS/i.test(name)) return true;

        // Aceitar se tem palavras caracter√≠sticas de empresa (ADI√á√ïES)
        if (/DIESEL|MECANICA|CARTUCHOS|INFORMATICA|INDUSTRIA|SERVICOS|TECNOLOGIA|SEGURANCA|AUTOMOTIVA|FUNILARIA|RIGO|FILHO|BHS|MARINGA|PORTEC|COMERCIO|TRANORTE|SISTEMAS|POSTO|CONTABILIDADE|ORLANDO|AMORIM|AUTO|ELETRICA|SERVOPA|CAMINHOES|TRANSPOTECH|PECAS|SINDICATO|VAREJISTA|FSC|COMUNICACOES|VANTOIR|DERETTI/i.test(name)) return true;

        // Aceitar se tem sufixos de empresa (ORIGINAL)
        if (/LTDA|EPP|S\.?A|ME|EIRELI/i.test(name)) return true;

        // Aceitar nomes com iniciais (ORIGINAL)
        if (/^[A-Z]\.[A-Z]\./.test(name)) return true;

        return false;
      }

      // Limpeza melhorada (APENAS ADI√á√ïES)
      cleanCompanyName(name) {
        if (!name) return '';
        
        return name
          .replace(/^(Nome\/Raz√£o social:|Nome\/Raz√£o Social:|Raz√£o Social:|Nome fantasia:|PRESTADOR:|CPF\/CNPJ:|Prestador de Servi√ßos|Raz√£o Social:)/gi, '')
          .replace(/^(e\s+|de\s+|da\s+|do\s+)/gi, '') // Remove artigos do in√≠cio
          .replace(/(Inscri√ß√£o|CPF\/CNPJ|Telefone|E-mail|N√∫mero da NFS-e|Situa√ß√£o|Emitida|Autenticidade|CNPJ:|N√∫mero da|CEP|Endere√ßo|Munic√≠pio|Email:|Complemento|UF:|Data Presta√ß√£o|Documento emitido).*$/gi, '')
          .replace(/(TOMADOR|COMERCIO DE BANANAS|ALAMEDA|TORRE|ANDAR|SITIO|CENTRO|MUNIC√çPIO|SECRETARIA|FAZENDA|Nota Fiscal|N√∫mero:|Data de|PRESTADOR DE|Inscrigao estadual|Bairro CIC|Estado:|PR CURITIBA|SC BLUMENAU|Endere√ßo:|VIA EXPRESSA|PAUL FRITZ|KUEHNRICH).*$/gi, '') // Remove tomador e endere√ßos + novos filtros
          .replace(/[\r\n]+/g, ' ') // Remove quebras de linha
          .replace(/^[\s\W]+|[\s\W]+$/g, '')
          .replace(/\s+/g, ' ')  // Normaliza espa√ßos m√∫ltiplos
          .trim();
      }

      // ===== FUN√á√ïES ORIGINAIS MANTIDAS EXATAMENTE IGUAIS =====
      
      extractCNPJ(text) {
        this.logStep('info', 'Iniciando extra√ß√£o de CNPJ');
        
        const cnpjRegex = /\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}/g;
        const cnpjs = text.match(cnpjRegex);
        
        if (!cnpjs || cnpjs.length === 0) {
          this.logStep('fail', 'Nenhum CNPJ encontrado');
          return '';
        }
        
        this.logStep('info', `Encontrados ${cnpjs.length} CNPJs no documento`);
        
        // Formatar CNPJs encontrados
        const formattedCnpjs = cnpjs.map(cnpj => {
          return cnpj.replace(/\D/g, '').replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        });
        
        // Procurar CNPJ do emitente (primeiro diferente de alguns conhecidos)
        for (const cnpj of formattedCnpjs) {
          if (!cnpj.startsWith('07.925.317')) { // N√£o √© do Comercio de Bananas (tomador)
            this.logStep('success', `CNPJ do emitente encontrado ${cnpj}`);
            return cnpj;
          }
        }
        
        // Se n√£o encontrou, retorna o primeiro
        this.logStep('success', `CNPJ encontrado ${formattedCnpjs[0]}`);
        return formattedCnpjs[0];
      }

      extractDocumentNumber(text) {
        this.logStep('info', 'Iniciando extra√ß√£o de n√∫mero do documento');
        
        // Primeira tentativa: padr√µes mais espec√≠ficos
        const patterns = [
          /N[√∫u]mero[:\s]*(\d{3,8})/gi,
          /N[¬∞¬∫]\s*(?:da\s*)?(?:Nota|NFS-e|Documento)[:\s]*(\d{3,8})/gi,
          /(?:NFS-e|NFSe)\s*N[¬∞¬∫]\s*(\d{3,8})/gi,
          /Documento[:\s]*(\d{3,8})/gi
        ];
        
        for (const pattern of patterns) {
          const matches = [...text.matchAll(pattern)];
          if (matches.length > 0) {
            const numero = matches[0][1];
            this.logStep('success', `N√∫mero encontrado: ${numero}`);
            return numero;
          }
        }
        
        // Segunda tentativa: busca simples por sequ√™ncias num√©ricas
        const numberMatches = text.match(/\b\d{3,8}\b/g);
        if (numberMatches) {
          // Pega o primeiro n√∫mero que n√£o seja CNPJ ou CEP
          for (const num of numberMatches) {
            if (num.length >= 3 && num.length <= 8 && 
                !text.includes(num + '.') && // N√£o faz parte de CNPJ
                !text.includes('-' + num)) { // N√£o faz parte de CEP
              this.logStep('success', `N√∫mero encontrado por fallback: ${num}`);
              return num;
            }
          }
        }
        
        this.logStep('fail', 'N√∫mero do documento n√£o encontrado');
        return '';
      }

      extractDate(text) {
        const datePatterns = [
          /Data[^:]*Emiss[^:]*:\s*(\d{1,2}\/\d{1,2}\/\d{4})/gi,
          /Emiss[^:]*:\s*(\d{1,2}\/\d{1,2}\/\d{4})/gi,
          /(\d{1,2}\/\d{1,2}\/\d{4})/g
        ];
        
        for (const pattern of datePatterns) {
          const match = text.match(pattern);
          if (match) {
            return match[1] || match[0];
          }
        }
        return '';
      }

      extractValue(text) {
        const valuePatterns = [
          /Valor\s*Total[^:]*:\s*R?\$?\s*([\d.,]+)/gi,
          /Total[^:]*:\s*R?\$?\s*([\d.,]+)/gi,
          /R?\$\s*([\d.,]+)/g
        ];
        
        for (const pattern of valuePatterns) {
          const match = text.match(pattern);
          if (match) {
            return match[1];
          }
        }
        return '';
      }

      async extractAllData(text, filename) {
        this.debugSteps = [];
        this.logStep('info', `=== INICIANDO EXTRA√á√ÉO ULTRA-DIRETA PARA ${filename} ===`);
        
        const data = {
          filename: filename,
          cnpj_emitente: '',
          nome_emitente: '',
          data_emissao: '',
          numero_documento: '',
          valor_total: '',
          descricao: 'Processado pelo Sistema Ultra-Direto'
        };

        try {
          // Extra√ß√£o de CNPJ
          data.cnpj_emitente = this.extractCNPJ(text);
          
          // Extra√ß√£o ULTRA-DIRETA de nome do emitente
          data.nome_emitente = this.extractEmitenteNameLaser(text, data.cnpj_emitente);
          
          // Extra√ß√µes complementares
          data.numero_documento = this.extractDocumentNumber(text);
          data.data_emissao = this.extractDate(text);
          data.valor_total = this.extractValue(text);
          
          this.logStep('success', '=== EXTRA√á√ÉO ULTRA-DIRETA CONCLU√çDA ===', data);
          return data;
          
        } catch (error) {
          this.logStep('error', 'ERRO NA EXTRA√á√ÉO ULTRA-DIRETA', error.message);
          return {
            ...data,
            nome_emitente: 'ERRO ULTRA-DIRETO',
            numero_documento: 'ERRO',
            descricao: error.message
          };
        }
      }
    }

    // ===== RESTO DO C√ìDIGO ORIGINAL MANTIDO EXATAMENTE IGUAL =====
    
    window.addEventListener('load', function() {
      const statusMessage = document.getElementById('statusMessage');
      const statusSection = document.getElementById('statusSection');
      
      try {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        statusMessage.innerHTML = '<i class="fas fa-check-circle"></i> Sistema Ultra-Direto v3.8 ativo! Melhorias de nomes adicionadas com sucesso.';
        statusMessage.className = 'status-ok';
        librariesLoaded = true;
        
        setTimeout(() => {
          statusSection.style.display = 'none';
        }, 3000);
        
        console.log('üéØ Sistema de Extra√ß√£o Ultra-Direto v3.8 inicializado');
        console.log('üÜï MELHORIAS ADICIONADAS:');
        console.log('   ‚úÖ VANTOIR DERETTI ME');
        console.log('   ‚úÖ SERVOPA CAMINHOES LTDA');
        console.log('   ‚úÖ TRANSPOTECH PECAS E SERVICOS LTDA');
        console.log('   ‚úÖ SINDICATO DO COMERCIO VAREJISTA DE JARAGUA DO SUL');
        console.log('   ‚úÖ FSC COMUNICACOES LTDA');
        console.log('   ‚úÖ M.A. DA SILVA VIEIRA - AUTO EL√âTRICA');
        console.log('   ‚úÖ BHS MARINGA TECNOLOGIA LTDA');
        console.log('   ‚úÖ PORTEC COMERCIO DE PRODUTOS ELETRONICOS');
        console.log('   ‚úÖ TRANORTE SISTEMAS MECANIZADOS LTDA');
        console.log('   ‚úÖ POSTO Z4 LTDA');
        console.log('   ‚úÖ CONTABILIDADE ORLANDO AMORIM S/S LTDA');
        console.log('   ‚úÖ W.O. RIGO FILHO - INFORMATICA - ME');
        console.log('   ‚úÖ FUNILARIA NITZ LTDA');
        console.log('   ‚úÖ SASCAR TECNOLOGIA');
        console.log('   ‚úÖ LUCIA IVONETE espec√≠fica');
        console.log('   ‚úÖ RD CARTUCHOS E INFORMATICA LTDA');
        console.log('   ‚úÖ Todas as estrat√©gias originais mantidas');
        
      } catch (error) {
        statusMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro no carregamento das bibliotecas: ' + error.message;
        statusMessage.className = 'status-error';
      }
    });

    // Upload e processamento de arquivos (ORIGINAL)
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFiles);

    function handleDragOver(e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    }

    function handleDrop(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      setSelectedFiles(files);
    }

    function handleFiles(e) {
      const files = Array.from(e.target.files);
      setSelectedFiles(files);
    }

    function setSelectedFiles(files) {
      selectedFiles = files.filter(file => 
        file.type === 'application/pdf' || 
        file.name.toLowerCase().endsWith('.xlsx') ||
        file.name.toLowerCase().endsWith('.xls')
      );
      
      if (selectedFiles.length > 0) {
        uploadArea.innerHTML = `
          <div class="upload-icon"><i class="fas fa-check-circle" style="color: #38a169;"></i></div>
          <div class="upload-text">${selectedFiles.length} arquivo(s) selecionado(s)</div>
          <div class="upload-hint">Clique em "Processar" para iniciar a extra√ß√£o ultra-direta</div>
        `;
        processBtn.disabled = false;
      }
    }

    async function processFiles() {
      if (!librariesLoaded) {
        alert('Aguarde o carregamento do sistema ULTRA-DIRETO!');
        return;
      }

      if (selectedFiles.length === 0) {
        alert('Selecione pelo menos um arquivo!');
        return;
      }

      const progressSection = document.getElementById('progressSection');
      const resultsSection = document.getElementById('resultsSection');
      
      progressSection.style.display = 'block';
      resultsSection.style.display = 'none';
      
      allData = [];
      debugInfo = [];

      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        updateProgress(i, selectedFiles.length, `Aplicando extra√ß√£o ultra-direta em ${file.name}...`);
        
        try {
          let extractedData;
          
          if (file.type === 'application/pdf') {
            extractedData = await processPDF(file);
          } else {
            extractedData = await processExcel(file);
          }
          
          allData.push(extractedData);
          debugInfo.push({
            filename: file.name,
            steps: extractedData.debugSteps || []
          });
          
        } catch (error) {
          console.error('Erro ao processar arquivo:', file.name, error);
          const errorData = {
            filename: file.name,
            cnpj_emitente: 'ERRO',
            nome_emitente: 'Erro no processamento ULTRA-DIRETO',
            data_emissao: '',
            numero_documento: '',
            valor_total: '',
            descricao: error.message || 'Erro desconhecido'
          };
          allData.push(errorData);
        }
      }

      updateProgress(selectedFiles.length, selectedFiles.length, 'Extra√ß√£o ultra-direta conclu√≠da!');
      
      setTimeout(() => {
        progressSection.style.display = 'none';
        showResults();
      }, 1000);
    }

    async function processPDF(file) {
      const extractor = new NFSExtractor();
      
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let fullText = '';

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + ' ';
        }

        console.log('üìÑ Texto extra√≠do:', fullText.substring(0, 500));
        
        const result = await extractor.extractAllData(fullText, file.name);
        result.debugSteps = extractor.debugSteps;
        
        return result;
        
      } catch (error) {
        console.error('Erro no processamento PDF:', error);
        throw error;
      }
    }

    async function processExcel(file) {
      const extractor = new NFSExtractor();
      
      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        let fullText = '';
        workbook.SheetNames.forEach(sheetName => {
          const worksheet = workbook.Sheets[sheetName];
          const csvData = XLSX.utils.sheet_to_csv(worksheet);
          fullText += csvData + ' ';
        });

        const result = await extractor.extractAllData(fullText, file.name);
        result.debugSteps = extractor.debugSteps;
        
        return result;
        
      } catch (error) {
        console.error('Erro no processamento Excel:', error);
        throw error;
      }
    }

    function updateProgress(current, total, message) {
      const progress = (current / total) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressText').textContent = message;
    }

    function showResults() {
      const resultsSection = document.getElementById('resultsSection');
      const summaryCards = document.getElementById('summaryCards');
      const resultsBody = document.getElementById('resultsBody');
      
      // Estat√≠sticas
      const total = allData.length;
      const sucesso = allData.filter(d => d.nome_emitente && !d.nome_emitente.includes('ERRO')).length;
      const erro = total - sucesso;
      
      summaryCards.innerHTML = `
        <div class="summary-card">
          <h3>${total}</h3>
          <p>Total Processados</p>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);">
          <h3>${sucesso}</h3>
          <p>Extra√ß√µes Bem-sucedidas</p>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);">
          <h3>${erro}</h3>
          <p>Erros de Processamento</p>
        </div>
      `;
      
      // Tabela de resultados
      resultsBody.innerHTML = '';
      allData.forEach(data => {
        const row = document.createElement('tr');
        const status = data.nome_emitente && !data.nome_emitente.includes('ERRO') ? 
          '<span style="color: #38a169; font-weight: bold;">‚úì Sucesso</span>' :
          '<span style="color: #e53e3e; font-weight: bold;">‚úó Erro</span>';
          
        row.innerHTML = `
          <td style="max-width: 200px; word-break: break-word;">${data.filename}</td>
          <td>${data.cnpj_emitente}</td>
          <td style="max-width: 250px; word-break: break-word;"><strong>${data.nome_emitente}</strong></td>
          <td>${data.numero_documento}</td>
          <td>${data.data_emissao}</td>
          <td>${data.valor_total}</td>
          <td>${status}</td>
        `;
        resultsBody.appendChild(row);
      });
      
      resultsSection.style.display = 'block';
    }

    function downloadExcel() {
      const worksheet = XLSX.utils.json_to_sheet(allData.map(data => ({
        'Nome do Arquivo': data.filename,
        'CNPJ do Emitente': data.cnpj_emitente,
        'Nome do Emitente': data.nome_emitente,
        'N√∫mero do Documento': data.numero_documento,
        'Data de Emiss√£o': data.data_emissao,
        'Valor Total': data.valor_total,
        'Descri√ß√£o': data.descricao
      })));

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Resultados NFS-e Ultra-Direto');
      
      const fileName = `resultados_nfse_ultra_direto_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(workbook, fileName);
    }

    function clearResults() {
      selectedFiles = [];
      allData = [];
      debugInfo = [];
      
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('debugSection').style.display = 'none';
      document.getElementById('progressSection').style.display = 'none';
      
      uploadArea.innerHTML = `
        <div class="upload-icon"><i class="fas fa-file-pdf"></i></div>
        <div class="upload-text">Clique aqui ou arraste os arquivos</div>
        <div class="upload-hint">v3.8 - Todas as melhorias de nomes adicionadas: VANTOIR DERETTI + SERVOPA + TRANSPOTECH + SINDICATO + FSC + M.A. SILVA + BHS + PORTEC + W.O. RIGO + RD CARTUCHOS + outros</div>
      `;
      
      processBtn.disabled = true;
      fileInput.value = '';
    }

    function toggleDebug() {
      const debugSection = document.getElementById('debugSection');
      const debugContent = document.getElementById('debugContent');
      
      if (debugSection.style.display === 'none' || !debugSection.style.display) {
        if (debugInfo.length === 0) {
          alert('Processe alguns arquivos primeiro para ver o debug!');
          return;
        }
        
        let html = '<h4>üéØ Processo de Extra√ß√£o Ultra-Direta (Melhorias Adicionadas):</h4>';
        
        debugInfo.forEach((fileDebug, index) => {
          html += `<div style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
          html += `<h5 style="color: #2d3748; margin-bottom: 10px;">üìÑ ${fileDebug.filename}</h5>`;
          
          fileDebug.steps.forEach(step => {
            const stepClass = `debug-${step.type}`;
            const icon = {
              'info': '‚ÑπÔ∏è',
              'success': '‚úÖ', 
              'warning': '‚ö†Ô∏è',
              'fail': '‚ùå',
              'error': 'üö®'
            }[step.type] || 'üìù';
            
            html += `<div class="debug-step ${stepClass}">`;
            html += `<strong>${icon} [${step.timestamp}]</strong> ${step.message}`;
            if (step.details && typeof step.details === 'string') {
              html += `<br><em style="font-size: 0.9em; color: #666;">${step.details.substring(0, 200)}${step.details.length > 200 ? '...' : ''}</em>`;
            }
            html += `</div>`;
          });
          
          html += `</div>`;
        });
        
        debugContent.innerHTML = html;
        debugSection.style.display = 'block';
        debugSection.scrollIntoView({ behavior: 'smooth' });
      } else {
        debugSection.style.display = 'none';
      }
    }
  </script>
</body>
</html>
